<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Begin Bridgetown SEO tag v3.0.5 -->
<title>Autenticación Two-Factor (2FA) | Mario Alberto Chávez Cárdenas</title>
<meta property="og:title" content="Autenticación Two-Factor (2FA)" />
<meta name="author" content="Mario Alberto Chávez Cárdenas" />
<meta property="og:locale" content="es_MX" />
<meta name="description" content="La seguridad es un factor importante en toda aplicación hoy en día, es algo que como desarrolladores de aplicaciones no debemos de dejar a la ligera. Es nuestra responsabilidad asegurar la información y la confianza de nuestros usuarios." />
<meta property="og:description" content="La seguridad es un factor importante en toda aplicación hoy en día, es algo que como desarrolladores de aplicaciones no debemos de dejar a la ligera. Es nuestra responsabilidad asegurar la información y la confianza de nuestros usuarios." />
<link rel="canonical" href="https://mariochavez.io/desarrollo/2020/07/13/autenticacion-two-factor-2fa/" />
<meta property="og:url" content="https://mariochavez.io/desarrollo/2020/07/13/autenticacion-two-factor-2fa/" />
<meta property="og:site_name" content="Mario Alberto Chávez Cárdenas" />
<meta property="og:image" content="https://mariochavez.io/images/autenticacion/password-security.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-13T01:01:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://mariochavez.io/images/autenticacion/password-security.jpg" />
<meta property="twitter:title" content="Autenticación Two-Factor (2FA)" />
<meta name="twitter:site" content="@mario_chavez" />
<meta name="twitter:creator" content="@Mario Alberto Chávez Cárdenas" />
<!-- End Bridgetown SEO tag -->


<link type="application/atom+xml" rel="alternate" href="https://mariochavez.io/feed.xml" title="Mario Alberto Chávez Cárdenas" />

<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<link rel="stylesheet" href="/static/css/main.1fb79f377577510e8719.css" />
<script src="/static/js/main.8737adaefb53b0968c14.js" defer></script>

  </head>
  <body class="min-h-screen antialiased post ">
    <section class="flex flex-nowrap">
      <aside class="sticky top-0 flex flex-col hidden w-64 max-h-screen min-h-screen bg-gray-100 xl:w-96 lg:block">
  <div class="px-8 xl:px-10">
    <header class="py-14">
      <h1 class="font-sans text-3xl font-medium tracking-widest text-gray-700 uppercase">Mario Alberto Chávez Cárdenas</h1>
      <h2 class="mt-4 font-serif text-lg italic tracking-wide text-gray-500 font-extralight">Blog personal de fotografía y desarrollo de software</h2>
    </header>

    <nav class="lg:flex-grow lg:py-14">
  <ul>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/">Inicio</a></li>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/desarrollo">Desarrollo</a></li>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/fotografía">Fotografía</a></li>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/proyectos">Proyectos</a></li>
    <li class="font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/acercade">Acerca de</a></li>
  </ul>
</nav>


    <footer class="py-8 lg:py-14">
  <div class="flex space-x-4">
    <a href="https://twitter.com/mario_chavez" target="_blank" class="text-gray-400 hover:text-red-500">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg>
    </a>
    <a href="https://instagram.com/mario_chavez" target="_blank" class="text-gray-400 hover:text-red-500">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="none" viewBox="0 0 24 24" class="w-4 h-4"><path d="M15.233 5.488c-.843-.038-1.097-.046-3.233-.046s-2.389.008-3.232.046c-2.17.099-3.181 1.127-3.279 3.279-.039.844-.048 1.097-.048 3.233s.009 2.389.047 3.233c.099 2.148 1.106 3.18 3.279 3.279.843.038 1.097.047 3.233.047 2.137 0 2.39-.008 3.233-.046 2.17-.099 3.18-1.129 3.279-3.279.038-.844.046-1.097.046-3.233s-.008-2.389-.046-3.232c-.099-2.153-1.111-3.182-3.279-3.281zm-3.233 10.62c-2.269 0-4.108-1.839-4.108-4.108 0-2.269 1.84-4.108 4.108-4.108s4.108 1.839 4.108 4.108c0 2.269-1.839 4.108-4.108 4.108zm4.271-7.418c-.53 0-.96-.43-.96-.96s.43-.96.96-.96.96.43.96.96-.43.96-.96.96zm-1.604 3.31c0 1.473-1.194 2.667-2.667 2.667s-2.667-1.194-2.667-2.667c0-1.473 1.194-2.667 2.667-2.667s2.667 1.194 2.667 2.667zm4.333-12h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm.952 15.298c-.132 2.909-1.751 4.521-4.653 4.654-.854.039-1.126.048-3.299.048s-2.444-.009-3.298-.048c-2.908-.133-4.52-1.748-4.654-4.654-.039-.853-.048-1.125-.048-3.298 0-2.172.009-2.445.048-3.298.134-2.908 1.748-4.521 4.654-4.653.854-.04 1.125-.049 3.298-.049s2.445.009 3.299.048c2.908.133 4.523 1.751 4.653 4.653.039.854.048 1.127.048 3.299 0 2.173-.009 2.445-.048 3.298z"/></svg>
    </a>
  </div>
  <p class="mt-4 font-sans text-xs font-light tracking-wider text-gray-500 xl:text-sm">©2021. Mario Alberto Chávez Cárdenas</p>
</footer>

  </div>
</aside>


      <main class="flex-auto overflow-hidden text-gray-700">
        <header class="flex flex-col bg-gray-100 lg:hidden" data-controller="menu">
  <div class="flex flex-col w-full px-8 md:flex-row xl:px-10">
    <div class="w-full pt-12 pb-6 md:py-12">
      <a href="/">
        <h1 class="font-sans text-lg font-medium tracking-widest text-gray-700 uppercase md:text-2xl">Mario Alberto Chávez Cárdenas</h1>
      </a>
      <h2 class="mt-4 font-serif text-xs italic tracking-wide text-gray-500 md:text-lg font-extralight">Blog personal de fotografía y desarrollo de software</h2>
    </div>

    <div class="pb-6 md:py-12 md:pl-4 md:self-center md:justify-self-end md:pl-0">
      <a href="#" class="inline-flex items-center px-4 py-2 border border-gray-500 md:flex hover:text-red-500 hover:border-red-500" data-action="menu#toggle">
        <span class="font-semibold text-md md:text-lg">Menú</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-4 h-4 ml-4" data-menu-target="closed">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hidden w-4 h-4 ml-4" data-menu-target="opened">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </a>
    </div>
  </div>

  <div data-menu-target="submenu" class="hidden w-full px-8">
    <nav class="lg:flex-grow lg:py-14">
  <ul>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/">Inicio</a></li>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/desarrollo">Desarrollo</a></li>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/fotografía">Fotografía</a></li>
    <li class="pb-4 font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/proyectos">Proyectos</a></li>
    <li class="font-sans font-light tracking-wider text-gray-500 uppercase text-md hover:text-red-500"><a href="/acercade">Acerca de</a></li>
  </ul>
</nav>


    <footer class="py-8 lg:py-14">
  <div class="flex space-x-4">
    <a href="https://twitter.com/mario_chavez" target="_blank" class="text-gray-400 hover:text-red-500">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg>
    </a>
    <a href="https://instagram.com/mario_chavez" target="_blank" class="text-gray-400 hover:text-red-500">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke="none" viewBox="0 0 24 24" class="w-4 h-4"><path d="M15.233 5.488c-.843-.038-1.097-.046-3.233-.046s-2.389.008-3.232.046c-2.17.099-3.181 1.127-3.279 3.279-.039.844-.048 1.097-.048 3.233s.009 2.389.047 3.233c.099 2.148 1.106 3.18 3.279 3.279.843.038 1.097.047 3.233.047 2.137 0 2.39-.008 3.233-.046 2.17-.099 3.18-1.129 3.279-3.279.038-.844.046-1.097.046-3.233s-.008-2.389-.046-3.232c-.099-2.153-1.111-3.182-3.279-3.281zm-3.233 10.62c-2.269 0-4.108-1.839-4.108-4.108 0-2.269 1.84-4.108 4.108-4.108s4.108 1.839 4.108 4.108c0 2.269-1.839 4.108-4.108 4.108zm4.271-7.418c-.53 0-.96-.43-.96-.96s.43-.96.96-.96.96.43.96.96-.43.96-.96.96zm-1.604 3.31c0 1.473-1.194 2.667-2.667 2.667s-2.667-1.194-2.667-2.667c0-1.473 1.194-2.667 2.667-2.667s2.667 1.194 2.667 2.667zm4.333-12h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm.952 15.298c-.132 2.909-1.751 4.521-4.653 4.654-.854.039-1.126.048-3.299.048s-2.444-.009-3.298-.048c-2.908-.133-4.52-1.748-4.654-4.654-.039-.853-.048-1.125-.048-3.298 0-2.172.009-2.445.048-3.298.134-2.908 1.748-4.521 4.654-4.653.854-.04 1.125-.049 3.298-.049s2.445.009 3.299.048c2.908.133 4.523 1.751 4.653 4.653.039.854.048 1.127.048 3.299 0 2.173-.009 2.445-.048 3.298z"/></svg>
    </a>
  </div>
  <p class="mt-4 font-sans text-xs font-light tracking-wider text-gray-500 xl:text-sm">©2021. Mario Alberto Chávez Cárdenas</p>
</footer>

  </div>
</header>

        <article class="py-16 font-serif lg:py-24 post">
  <header class="px-4 m-auto md:max-w-2xl lg:max-w-4xl">
    <a href="/desarrollo" class="pb-1 text-sm font-bold leading-normal uppercase border-b-4 border-gray-200 transition-all hover:text-red-500">desarrollo</a>
    <h1 class="mt-6 text-3xl font-bold tracking-wide md:text-4xl lg:text-6xl">Autenticación Two-Factor (2FA)</h1>
  </header>

  <figure class="mt-16 aspect-w-16 aspect-h-9">
    <img src="/images/autenticacion/password-security.jpg" loading="lazy" />
  </figure>

  <div class="px-4 m-auto mt-16 tracking-wider md:max-w-2xl lg:max-w-4xl prose md:prose-lg">
    <h1 id="autenticación-two-factor-2fa">Autenticación Two-Factor (2FA)</h1>

<p>El publicar una aplicación en Internet automáticamente vuelve la cuestión de seguridad un tema importante como el agregar nuevas características o solucionar errores en la misma.</p>

<p>Aunque Ruby on Rails  por omisión configura toda nueva aplicación con ciertos parámetros que básicos de seguridad hay detalles que nosotros como desarrolladores o administradores de una aplicación debemos de tomar.</p>

<p>El el post de hace unas semanas <a href="https://mariochavez.io/desarrollo/2020/06/15/seguridad-ruby-aplicacion.html" target="_blank">Proteger tu aplicación de ataques en Internet</a> platiqué de acciones que podemos configurar para proteger una aplicación de posibles ataques, el la mayoría automatizados.</p>

<p>Ahora en este post quiero hablar de el tema de cómo proteger a nuestros usuarios del robo de contraseñas o de un tipo de ataque llamado <em>phising</em> diseñado con la misma idea de robar credenciales.</p>

<h2 id="two-factor-2fa-contraseñas-de-un-sólo-uso">Two-Factor (2FA) contraseñas de un sólo uso</h2>

<p>En muchas de las aplicaciones modernas que se preocupan por la seguridad de sus usuarios agregan un nivel más a la protección de contraseñas. Aplicaciones de correo electrónico, de información financiera o bancos entre muchas otras cuentan como una opción más de protección las contraseñas de un sólo uso.</p>

<p>Este tipo de seguridad se conoce como autenticación <em>Two-Factor</em> e implica que el usuario aparte de su contraseña para iniciar una sesión necesita generar un código temporal de un sólo uso con una aplicación de su teléfono. La aplicación registra un código secreto que utiliza para generar los códigos temporales que el usuario necesita.</p>

<p>Aplicaciones como Google Authenticator o <a href="https://authy.com/" target="_blank">Authy</a> se utilizan para generar ese código temporal.</p>

<p>Otra forma de implementar las contraseñas de un sólo uso es con el envío del código temporal a través de SMS al teléfono del usuario como segundo paso después de introducir su contraseña.</p>

<h2 id="rails-y-otp">Rails y OTP</h2>

<p>Implementar OTP en una aplicación de Ruby on Rails es relativamente sencillo gracias a la gema <a href="https://github.com/mdp/rotp" target="_blank">rtop</a> que hace todo el trabajo de implementar los <a href="http://tools.ietf.org/html/rfc4226" target="_blank">RFC 4226</a> y <a href="http://tools.ietf.org/html/rfc6238" target="_blank">RFC 6238</a> para contraseñas de un sólo uso por contador o por tiempo.</p>

<p>Realmente utilizando <em>rtop</em> lo complicado es diseñar un flujo que sea amigable para el usuario no técnico dónde se le lleve por el proceso de activar su cuenta para que este protegida por 2FA. Además, hay que darle la posibilidad al usuario de poder tener acceso a la misma en caso de que su dispositivo móvil se haya dañado o extraviado; esto generalmente sucede con un grupo de códigos de recuperación que el usuario recibe al momento de activar su cuenta para 2FA.</p>

<h3 id="la-aplicación">La aplicación</h3>

<p>Para el contenido de este post cree una aplicación de Ruby on Rails con la implementación de OTP y sus flujos. Donde la lógica de controladores y vistas están dentro de un <em>namespace</em> llamado <strong><em>Otp</em></strong> con la finalidad de que sea sencilla su reutilización en otras aplicaciones.</p>

<p>Para el sistema de autenticación vía correo electrónico y contraseña no utilicé ninguna de las librerías populares, en su lugar utilicé un generador que desarrollé hace algunos años y que genera lo básico para poder registrarse e iniciar y cerrar sesión utilizando la funcionalidad de <a href="http://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html#method-i-has_secure_password" target="_blank">has_secure_password</a> de Rails. El motivo de esta decisión es eliminar la complejidad de las librerías conocidas del foco de la implementación de OTP. El código del generador está disponible en su <a href="https://github.com/mariochavez/mac_generators/" target="_blank">repositorio</a>.</p>

<p>El repositorio del código de esta aplicación está disponible en el <a href="https://github.com/mariochavez/rails-two-factor-otp" target="_blank">repositorio</a>. El post no va a mostrar en detalle el código por lo que va a ser necesario hacer referencia en el repositorio.</p>

<p>La aplicación de Rails de creó como se muestra a continuación. Se desactivaron algunos <em>frameworks</em> de Ruby on Rails que no son útiles para los objetivos de esta aplicación. Adicionalmente se instaló Webpack y Stimulus, siendo el último utilizado en varias partes de la aplicación que veremos un poco más adelante.</p>

<p>Finalmente con el generador que mencioné anteriormente generamos modelos, vistas y controladores para poder realizar registro y autenticación vía correo electrónico. Por omisión en lugar de crear el modelo <strong><em>User</em></strong>, al que estamos acostumbrados, se crea el modelo <strong><em>Identity</em></strong>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">rail</span> <span class="n">new</span> <span class="n">otp_security</span> <span class="o">-</span><span class="n">d</span> <span class="n">postgresql</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">mailer</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">mailbox</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">text</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">active</span><span class="o">-</span><span class="n">storage</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">cable</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">sprockets</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">otp_security</span>
<span class="err">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">webpacker</span><span class="ss">:install</span>
<span class="err">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">webpacker</span><span class="ss">:install:stimulus</span>
<span class="err">$</span> <span class="n">yarn</span> <span class="n">add</span> <span class="n">bulma</span>
<span class="err">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">g</span> <span class="n">authentication</span><span class="ss">:email</span>
</code></pre></div></div>

<h3 id="activar-2fa">Activar 2FA</h3>

<p>Activar 2FA para un usuario implica el explicarle al usuario en qué consiste y cómo va a cambiar su experiencia al iniciar sesión y llevarlo de la mano en el proceso.</p>

<p>El proceso tipo “<em>wizard</em>” se inicia con el controlador <code class="highlighter-rouge">Otp::ConfigureController</code> en donde inicialmente con la ayuda de <em>rtop</em> se genera un código secreto y único por cada usuario.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new</span>
  <span class="vi">@otp_secret</span> <span class="o">=</span> <span class="n">generate_otp_secret</span>
  <span class="vi">@qr_code</span> <span class="o">=</span> <span class="n">generate_qr_code_url</span><span class="p">(</span><span class="vi">@otp_secret</span><span class="p">,</span> <span class="n">current_identity</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>El “<em>wizard</em>” informativo es manejado por el controlador de Stimulus <code class="highlighter-rouge">wizard_controller.js</code>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Controller</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">stimulus</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nx">Controller</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="nx">targets</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">slide</span><span class="dl">"</span><span class="p">];</span>

  <span class="nx">connect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">showSlide</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">disconnect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">showSlide</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">next</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">showSlide</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">back</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">showSlide</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">showSlide</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">slideTargets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">element</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">data-wizard-index</span><span class="dl">"</span><span class="p">));</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">toggle</span><span class="p">(</span><span class="dl">"</span><span class="s2">wizard--current</span><span class="dl">"</span><span class="p">,</span> <span class="nx">index</span> <span class="o">===</span> <span class="nx">idx</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Al final del “<em>wizard</em>” al usuario se le presenta un código QR que debe de escanear utilizando una aplicación de autenticación 2FA compatible con Google Authenticator como <a href="https://authy.com/" target="_blank">Authy</a>. Después de escanear y registrar la autenticación en la aplicación móvil el usuario tiene que introducir el código generado para verificar que todo se encuentra listo para habilitar 2FA para el usuario.</p>

<p>El código del usuario se recibe en el controlador <code class="highlighter-rouge">Otp::ConfigureController</code> donde una vez que ha sido verificado se guarda el secreto único del usuario, se guarda el <em>timestamp</em> del último código que verificó el usuario y se generan 10 código de recuperación en caso de el usuario pierda o se le dañe su dispositivo y que no quede bloqueado.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">otp_secret</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:otp_secret</span><span class="p">]</span>
  <span class="n">otp_code</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:otp_code</span><span class="p">]</span>

  <span class="n">last_otp_at</span> <span class="o">=</span> <span class="n">verify_otp_code</span><span class="p">(</span><span class="n">otp_secret</span><span class="p">,</span> <span class="n">otp_code</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">last_otp_at</span><span class="p">.</span><span class="nf">present?</span>
    <span class="vi">@recovery_codes</span> <span class="o">=</span> <span class="n">generate_recovery_codes</span>
    <span class="n">current_identity</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">identity</span><span class="o">|</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">last_otp_at</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">last_otp_at</span><span class="p">).</span><span class="nf">utc</span><span class="p">.</span><span class="nf">to_datetime</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">otp_secret_key</span> <span class="o">=</span> <span class="n">otp_secret</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">recovery_codes</span> <span class="o">=</span> <span class="vi">@recovery_codes</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">save</span>
    <span class="k">end</span>

    <span class="n">redirect_to</span> <span class="n">otp_complete_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"2AF enabled succesfully"</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span><span class="ss">error: </span><span class="s2">"Verification code is invalid"</span><span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>El código único y secreto así como los código de recuperación son secretos sensibles de los cuales tenemos que prevenir que caigan en manos no confiables. Es por este motivo que esos atributos se guardan cifrados en la base de datos con la ayuda de la gema <a href="https://github.com/attr-encrypted/attr_encrypted" target="_blank">attr_encrypted</a>. La llave de cifrado se guarda en las credenciales de Rails.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Identity</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_secure_password</span> <span class="ss">validations: </span><span class="kp">true</span>

  <span class="n">attr_encrypted</span> <span class="ss">:otp_secret_key</span><span class="p">,</span> <span class="ss">:recovery_codes</span><span class="p">,</span> <span class="ss">key: </span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">encryption</span><span class="p">[</span><span class="ss">:otp_secret_key</span><span class="p">])</span>

  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">if: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="n">r</span><span class="p">.</span><span class="nf">password</span><span class="p">.</span><span class="nf">present?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>La llave de cifrado se genera en una consola de Ruby con el siguiente comando <code class="highlighter-rouge">Base64.encode64(SecureRandom.random_bytes(32))</code>.</p>

<p>Una vez que se validó el código y se guardó la información secreta, al usuario se le muestran sus códigos de recuperación, los cuales van a ser visibles esta única ocasión y se le muestra al usuario opciones para copiar los códigos al “<em>clipboard</em>” o imprimirlos o descargarlos en un archivo. Es responsabilidad del usuario guardarlo y mantenerlos seguros. El controlador <code class="highlighter-rouge">Otp::CompleteController</code> se encarga de esta parte.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">show</span>
  <span class="n">current_identity</span><span class="p">.</span><span class="nf">update_column</span><span class="p">(</span><span class="ss">:otp_enabled_at</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
  <span class="vi">@recovery_codes</span> <span class="o">=</span> <span class="n">current_identity</span><span class="p">.</span><span class="nf">recovery_codes</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>La lógica para copiar, imprimir o descargar los códigos de recuperación está implementada en los controladores de Stimulus <code class="highlighter-rouge">clipboard_controller.js</code>, <code class="highlighter-rouge">print_controller.js</code> y <code class="highlighter-rouge">download_controller.js</code>.</p>

<div class="gallery">
  <figure>
    <img src="/images/autenticacion/login-with-otp.gif" loading="lazy" />
  </figure>
</div>

<h3 id="nuevo-inicio-de-sesión">Nuevo inicio de sesión</h3>

<p>Con 2FA activado para un usuario su flujo de inicio de sesión cambia. Ahora el usuario después de ingresar sus credenciales, se le pedirá que ingrese el código temporal que se genera en su aplicación de autenticación en el móvil.</p>

<p>El código se valida y si es correcto entonces se guarda la última ocasión que el usuario validó un código correcto, esto con el fin de evitar que el código se pueda reutilizar en la ventana de 30 segundos que es cuando se genera un nuevo código.</p>

<p>Si el código no es válido, entonces el usuario no va a poder iniciar sesión.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:code</span><span class="p">]</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">verified</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="k">if</span> <span class="n">present_code?</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">last_otp_at</span> <span class="o">=</span> <span class="n">verify_otp_code</span><span class="p">(</span><span class="n">current_identity</span><span class="p">.</span><span class="nf">otp_secret_key</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">current_identity</span><span class="p">.</span><span class="nf">last_otp_at</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">last_otp_at</span><span class="p">.</span><span class="nf">present?</span>
      <span class="n">current_identity</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">last_otp_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">last_otp_at</span><span class="p">).</span><span class="nf">utc</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">)</span>
      <span class="n">verified</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="k">else</span>
      <span class="n">verified_code</span><span class="p">,</span> <span class="n">recovery_codes</span> <span class="o">=</span> <span class="n">verify_recovery_code</span><span class="p">(</span><span class="n">current_identity</span><span class="p">.</span><span class="nf">recovery_codes</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">verified_code</span><span class="p">.</span><span class="nf">present?</span>
        <span class="n">current_identity</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">recovery_codes: </span><span class="n">recovery_codes</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">))</span>
        <span class="n">verified</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">verified</span>
      <span class="n">warden</span><span class="p">.</span><span class="nf">session</span><span class="p">(</span><span class="ss">:identity</span><span class="p">)[</span><span class="s2">"otp_verified"</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">return</span> <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="n">t</span><span class="p">(</span><span class="s2">".logged_in"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span><span class="ss">error: </span><span class="s2">"Verification code is invalid"</span><span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
<span class="k">end</span>
</code></pre></div></div>

<p>En caso de que el usuario haya perdido acceso a la aplicación móvil que genera los códigos temporales este puede hacer uso de uno de los 10 códigos de recuperación en lugar del código temporal. Al hacer uso del código de recuperación y que sea válido, este se elimina impidiendo que se pueda volver a utilizar y se le permite el inicio de sesión al usuario.</p>

<p>Esta código se encuentra en el controlador <code class="highlighter-rouge">Otp::VerifyController</code>.</p>

<div class="gallery">
  <figure>
    <img src="/images/autenticacion/login-with-recovery-code.gif" loading="lazy" />
  </figure>
</div>

<h3 id="deshabilitar-2fa">Deshabilitar 2FA</h3>

<p>Aunque no es lo recomendable, el usuario que ha iniciado puede deshabilitar la necesidad de autenticación 2FA al iniciar sesión. Esto puede ser necesario en el caso de que el usuario cambie de dispositivo móvil por lo que es necesario deshabilitar 2FA y volver a habilitarlo con el nuevo dispositivo.</p>

<p>En el controlador <code class="highlighter-rouge">Otp::DisableController</code> se realiza la desactivación de 2FA dónde se elimina la información como secretos, códigos de recuperación y otros datos adicionales que en conjunto deshabilitan 2FA.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">destroy</span>
  <span class="n">current_identity</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">identity</span><span class="o">|</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">last_otp_at</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">otp_secret_key</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">recovery_codes</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">otp_enabled_at</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">save</span>
  <span class="k">end</span>

  <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"2FA disabled succesfully"</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="gallery">
  <figure>
    <img src="/images/autenticacion/disable-otp.gif" loading="lazy" />
  </figure>
</div>

<h3 id="detalles-finales-de-la-aplicación">Detalles finales de la aplicación</h3>

<p>El módulo <code class="highlighter-rouge">Otp::Base</code> incluye la lógica común entre los controladores relacionados en el proceso de 2FA.</p>

<p>En el proyecto disponible en el repositorio mencionado al inicio del post se incluyen también algunas pruebas de sistema, es decir pruebas dónde se automatiza el navegador para simular la interacción del usuario. Las pruebas tienen comentarios que explican qué operaciones son las que se están realizando para verificar los escenarios de 2FA.</p>

<h2 id="conclusiones">Conclusiones</h2>

<p>La seguridad es un factor importante en toda aplicación hoy en día, es algo que como desarrolladores de aplicaciones no debemos de dejar a la ligera. Es nuestra responsabilidad asegurar la información y la confianza de nuestros usuarios.</p>

<p>Estoy seguro que al revisar a detalle el código de la aplicación de ejemplo veremos que es sencillo implementar un nivel más de seguridad en nuestras aplicaciones y que el código está pensado en que pueda ser reutilizado.</p>

  </div>
</article>

      </main>
    </section>

  </body>
</html>
