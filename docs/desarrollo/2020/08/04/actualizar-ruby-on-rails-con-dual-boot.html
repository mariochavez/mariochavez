<!doctype html>

<html class="no-js" lang="es"><head>
  <meta charset="utf-8"></meta>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0"></meta>
  <title>Actualizar Ruby on Rails con boot doble</title>
  <meta name="description" content="Es necesario perder el miedo a actualizar y obtener los beneficios de seguridad y rendimiento de las versiones más recientes."></meta>
  <meta name="keywords" content="rails, ruby, performace, upgrade, dual, boot"></meta>
  <link rel="image_src" href="https://mariochavez.io/assets/img/640-upgrade-rails.jpg"></link>

  <link rel="alternate" type="application/rss+xml" title="Actualizar Ruby on Rails con boot doble" href="https://mariochavez.io/feed.xml">

  <meta property="og:title" content="Actualizar Ruby on Rails con boot doble"></meta>
  <meta property="og:description" content="Es necesario perder el miedo a actualizar y obtener los beneficios de seguridad y rendimiento de las versiones más recientes."></meta>
  <meta property="og:type" content="article" /></meta>
  <meta property="og:url" content="https://mariochavez.io/desarrollo/2020/08/04/actualizar-ruby-on-rails-con-dual-boot.html"></meta>
  <meta property="og:image" content="https://mariochavez.io/assets/img/640-upgrade-rails.jpg"></meta>
  <meta property="og:site_name" content="Mario Alberto Chávez : Blog"></meta>

  <meta name="twitter:site" content="@mario_chavez"></meta>
  <meta name="twitter:domain" content="mariochavez.io"></meta>
  <meta name="twitter:card" content="summary_large_image"></meta>
  <meta name="twitter:title" content="Actualizar Ruby on Rails con boot doble"></meta>
  <meta name="twitter:description" content="Es necesario perder el miedo a actualizar y obtener los beneficios de seguridad y rendimiento de las versiones más recientes."></meta>
  <meta name="twitter:image:src" content="https://mariochavez.io/assets/img/640-upgrade-rails.jpg"></meta>

  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"></link>

  <link rel="stylesheet" type="text/css" href="/assets/style-f53587fcc403c6b6464a7aaad7fb1970a9e72c0b3c05e52765810f28da2015e1.css" integrity="sha256-9TWH/MQDxrZGSnqq1/sZcKnnLAs8BeUnZYEPKNogFeE=" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="/assets/isotope-d185bd15a4ce846d0ae2da7dcdba501a42dd340f48e7690465610391cdee1657.css" integrity="sha256-0YW9FaTOhG0K4tp9zbpQGkLdNA9I52kEZWEDkc3uFlc=" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="/assets/mqueries-05a4d0eb5cc7105f9bba8b36a0b3738cd2d052a769570bae775e46495600e0de.css" integrity="sha256-BaTQ61zHEF+buos2oLNzjNLQUqdpVwuud15GSVYA4N4=" crossorigin="anonymous">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141668117-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-141668117-1');
  </script>
</head>
<body class="loader-dot">
    <div id="page-loader">
      <span class="loader-icon"></span>
    </div>

    <div id="page-content"><header id="header">
  <div class="header-inner clearfix">

    <div id="logo">
      <a href="/">
        <img id="dark-logo" src="/assets/mariochavez.png" srcset="/assets/mariochavez.png 1x, /assets/mariochavez@2x.png 2x" alt="Mario Chávez">
      </a>
    </div>

    <div id="menu" class="clearfix transition-enabled">
      <div class="menu-actions">
        <div class="menu-toggle"><span class="hamburger"></span></div>
      </div>

      <div id="menu-inner">
        <nav id="main-nav">
          <ul>
            <li class="current_page_item"><a href="/">Secciones</a>
              <ul class="sub-menu">
                <li><a href="/desarrollo.html">Desarrollo de Software</a></li>
                <li><a href="/fotografia.html">Fotografía</a></li>
                <li><a href="/proyectos.html">Proyectos</a></li>
              </ul>
            </li>
            <li><a href="/acerca.html">Acerca</a></li>
            <li><a href="https://heroimage.co" target="_blank">Hero Image</a></li>
            <li><a href="https://f64.io" target="_blank">F/64</a></li>
            <li><a href="https://michelada.io" target="_blank">michelada.io</a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div id="header-widget" class="social">
      <ul class="socialmedia-widget">
        <li class="facebook"><a href="#"></a></li>
        <li class="twitter"><a href="#"></a></li>
        <li class="instagram"><a href="#"></a></li>
      </ul>
    </div> <!-- END #header-awidget -->

  </div>
</header>
<div id="hero-and-body">

        <section id="hero" class="hero-auto no-bg">

          <div id="page-title" class="wrapper-small">
            <span class="post-cat"><a class="cat-link" href="#">desarrollo</a></span>
                       <h1 class="post-name"><strong>Actualizar Ruby on Rails con boot doble</strong></h1>
            <div class="post-meta">
              <span class="post-date">Agosto 04, 2020</span>
              <div class="meta-author"><span>por</span> <a href="/">Mario Alberto Chávez</a></div>
            </div>
          </div>

        </section>

        <section id="page-body">
          <div id="blog-single">

            <div class="blog-media">
              <img width="1200" height="800" src="/assets/img/upgrade-rails.jpg"
                class="attachment-orio-thumb-big size-orio-thumb-big wp-post-image" alt="Main image"
                srcset="/assets/img/upgrade-rails.jpg 1200w, /assets/img/300-upgrade-rails.jpg 300w, /assets/img/768-upgrade-rails.jpg 768w, /assets/img/1024-upgrade-rails.jpg 1024w, /assets/img/180-upgrade-rails.jpg 180w, /assets/img/940-upgrade-rails.jpg 940w, /assets/img/320-upgrade-rails.jpg 320w, /assets/img/640-upgrade-rails.jpg 640w, /assets/img/960-upgrade-rails.jpg 960w" sizes="(max-width: 1200px) 100vw, 1200px" />
            </div>

            <div class="blog-content wrapper-small">
              <p>Desde la versión 4.2 de Ruby on Rails las actualizaciones del framework son en buena medida estables. Atendiendo cuestiones de API’s que ya están fuera de uso, verificando que las gemas o dependencias de la aplicación tengan ya soporte de la versión a la que vamos actualizar y que contenemos con un set de pruebas por lo menos es la funcionalidad crítica es suficiente para tener éxito.</p>

<p>Obviamente el tiempo y esfuerzo de actualización también dependerá de que tan grande es nuestra aplicación y la cantidad de ajustes que se requieran. Este esfuerzo se puede ver afectado en buena medida cuando tratamos de realizar la actualización en un “<em>branch</em>” de git con los nuevo cambios y que de alguna forma se empiece a quedar atrás esa rama de los cambios principales.</p>

<p>En este post voy a resumir la estrategia que desde mi punto de vista es la más efectiva.</p>

<h2 id="dualboot">Dualboot</h2>

<p>Normalmente soy de los desarrolladores que que prefieren omitir el uso de gemas o librería a menos  de que sea realmente necesario. <a href="https://github.com/Shopify/bootboot" target="_blank">Bootboot</a> de Shopify en esta caso es bastante útil ya que permite tener dos <code class="highlighter-rouge">Gemfile</code> uno que es el base de la aplicación y otro dónde se tiene la versión de Rails a la que vamos actualizar así como versiones de dependencias necesarias.</p>

<p>Con una variable de ambiente es posible hacer que la aplicación haga el boot con la versión actual de Rails o con la versión nueva. Esto permite mandar a la rama principal los cambios de la actualización y los cambios normales de aplicación evitando conflictos a la larga o tener una rama de actualización separada por varias semanas y cuando estamos listos resolver conflictos.</p>

<p>Bootboot se instala como un plugin de Bundler en el archivo <code class="highlighter-rouge">Gemfile</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>plugin <span class="s1">'bootboot'</span>, <span class="s1">'~&gt; 0.1.1'</span>
</code></pre></div></div>

<p>Después de agregar la librería ejecutamos lo siguiente.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle <span class="nb">install</span> <span class="o">&amp;&amp;</span> bundle bootboot
</code></pre></div></div>

<p>Al finalizer Bundler vamos a tener un archivo <code class="highlighter-rouge">Gemfile_next.lock</code> y en el archivo <code class="highlighter-rouge">Gemfile</code> vamos a encontrar un bloque que nos permite con la variable de ambiente <em>DEPENDENCIES_NEXT</em> hacer el boot de la aplicación con una versión de Rail u otra.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span>ENV[<span class="s2">"DEPENDENCIES_NEXT"</span><span class="o">]</span>
  enable_dual_booting <span class="k">if </span>Plugin.installed?<span class="o">(</span><span class="s2">"bootboot"</span><span class="o">)</span>

  <span class="c"># Add any gem you want here, they will be loaded only when running</span>
  <span class="c"># bundler command prefixed with `DEPENDENCIES_NEXT=1`.</span>
<span class="k">else
</span>end
</code></pre></div></div>

<p>El <code class="highlighter-rouge">if</code> yo lo modifiqué para quedara de la siguiente forma.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span>ENV.fetch<span class="o">(</span><span class="s2">"DEPENDENCIES_NEXT"</span>, 0<span class="o">)</span>.to_i <span class="o">==</span> 1
  enable_dual_booting <span class="k">if </span>Plugin.installed?<span class="o">(</span><span class="s2">"bootboot"</span><span class="o">)</span>

  <span class="c"># Add any gem you want here, they will be loaded only when running</span>
  <span class="c"># bundler command prefixed with `DEPENDENCIES_NEXT=1`.</span>
<span class="k">else
</span>end
</code></pre></div></div>

<p>Como primer paso es agregar en el bloque del <code class="highlighter-rouge">if</code> las dependencias de la versión a la cuál queremos migrar. Para el proyecto que utilicé para este ejemplo estoy migrando de Rails 6.0 a master de Rails que está marcado como Rails 6.1.alpha.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span>ENV.fetch<span class="o">(</span><span class="s2">"DEPENDENCIES_NEXT"</span>, 0<span class="o">)</span>.to_i <span class="o">==</span> 1
  enable_dual_booting <span class="k">if </span>Plugin.installed?<span class="o">(</span><span class="s2">"bootboot"</span><span class="o">)</span>

  <span class="c"># Add any gem you want here, they will be loaded only when running</span>
  <span class="c"># bundler command prefixed with `DEPENDENCIES_NEXT=1`.</span>
  gem <span class="s2">"rails"</span>, github: <span class="s2">"rails/rails"</span>
  gem <span class="s2">"puma"</span>, <span class="s2">"~&gt; 5.0.0.beta1"</span>
  gem <span class="s2">"webpacker"</span>, github: <span class="s2">"rails/webpacker"</span>
<span class="k">else
  </span>gem <span class="s2">"puma"</span>, <span class="s2">"~&gt; 3.11"</span>
  gem <span class="s2">"rails"</span>, <span class="s2">"~&gt; 6.0.0"</span>
  gem <span class="s2">"webpacker"</span>, <span class="s2">"~&gt; 4.0"</span>
end
</code></pre></div></div>

<p>Primeramente agregué la referencia de Rails a Github y corrí Bundler con la variable de ambiente.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ DEPENDENCIES_NEXT</span><span class="o">=</span>1 bundle <span class="nb">install</span>
</code></pre></div></div>

<p>Bundler me indicó que tenía conflictos para instalar Webpacker 4.0 con Rails 6.1.alpha entonces agregué Rails y Webpacker actual al bloque del <code class="highlighter-rouge">else</code> y agregué Webpacker de Github al bloque del <code class="highlighter-rouge">if</code>.</p>

<p>Este proceso lo repetí varias ocasiones hasta que en cada uno de los bloques del <code class="highlighter-rouge">if</code> tuviera las dependencias correctas. Este es el primer paso.</p>

<h2 id="configuración-de-la-aplicación">Configuración de la aplicación</h2>

<p>El siguiente paso es hacer que la aplicación pueda finalmente hacer el boot. Ejecuté el servidor de Rails de la siguiente forma.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ DEPENDENCIES_NEXT</span><span class="o">=</span>1  bin/rails s
</code></pre></div></div>

<p>Hubo código en los inicializadores que impedían que el servidor se iniciara correctamente pero es código que en la versión actual de Rails de la aplicación funciona sin problemas.</p>

<p>En este punto necesito tener información de qué versión de Rails se está ejecutando para decidir que código cambia, se queda o se modifica pero siempre manteniendo compatibilidad entre ambas versiones.</p>

<p>Modifiqué el archivo <code class="highlighter-rouge">config/application.rb</code> donde agregué el siguiente método.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">rails_6_0?</span>
  <span class="n">version</span> <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Rails</span><span class="o">::</span><span class="no">VERSION</span><span class="o">::</span><span class="no">STRING</span><span class="p">)</span>
  <span class="n">version</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">to_f</span> <span class="o">&lt;</span> <span class="mf">6.1</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Este método está disponible vía <code class="highlighter-rouge">Rails.application.rails_6_0?</code> y me permite conocer si estoy en la versión actual de la aplicación o en la versión nueva para de esta forma ejecutar cierto código para cada versión.</p>

<p>Es necesario hacer los ajustes que nuestra aplicación nos vaya solicitando para asegurar que al menos podemos hacer el boot de la misma.</p>

<p>Como siempre en cada actualización es necesario ejecutar el comando <code class="highlighter-rouge">bin/rails app:update</code>. Este proceso va a actualizar los archivos de configuración de la aplicación de forma interactiva, es decir, nos va a preguntar que acción realizar. Para cada archivo mostrado normalmente en mi caso o hago que sobre escriba el archivo con <strong><em>Y</em></strong> o que me muestre las diferencias de los cambios propuestos con <strong><em>d</em></strong> o negarle el que haga cambios con <strong><em>n</em></strong>. La decisión va a depender de cada aplicación.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails app:update
    conflict  config/boot.rb
Overwrite /Users/marioch/Development/michelada/butaca/config/boot.rb? <span class="o">(</span>enter <span class="s2">"h"</span> <span class="k">for </span><span class="nb">help</span><span class="o">)</span> <span class="o">[</span>Ynaqdhm]
        Y - <span class="nb">yes</span>, overwrite
        n - no, <span class="k">do </span>not overwrite
        a - all, overwrite this and all others
        q - quit, abort
        d - diff, show the differences between the old and the new
        h - <span class="nb">help</span>, show this <span class="nb">help
        </span>m - merge, run merge tool
</code></pre></div></div>

<p>Para el caso de actualización posiblemente en los archivos de configuración vamos a querer mantener la configuración actual y si hay cambios debido a la nueva versión de Rails entonces vamos a tener que hacer uso de nuestro método <code class="highlighter-rouge">Rails.application.rails_6_0?</code> para mantener ambas configuraciones separadas.</p>

<h2 id="ajustes-a-la-aplicación">Ajustes a la aplicación</h2>

<p>En este punto podemos ejecutar la suite de pruebas y comenzar a corregir cualquier problema descubierto. Con la ayuda del equipo de QA también podemos descubrir ajustes necesarios. Recuerda que debido al <strong><em>dual boot</em></strong> podemos enviar de forma segura esos cambios a la rama principal de nuestro repositorio.</p>

<p>En el momento que nos sentimos satisfechos de los cambios realizados y que estamos listos para enviar nuestra aplicación con la nueva versión de Rails a producción y que confirmamos que funciona como lo esperamos, es momento de eliminar cualquier código condicional que agregamos durante el proceso de actualización.</p>

<h2 id="conclusiones">Conclusiones</h2>

<p>Realmente no hay excusa para no tratar de actualizar nuestras aplicaciones a las nuevas versiones de Ruby on Rails y de Ruby. Las versiones recientes son bastante estables y la compatibilidad se ha mantenido para muchos de los casos.</p>

<p>Empresas como Github, Shopify y Basecamp al día de hoy corren con las versiones más nuevas sin problemas. Inclusive en el caso de Basecamp indican que tienen varios meses corriendo con la rama principal de Rails.</p>

<p>Es necesario perder el miedo a actualizar y obtener los beneficios de seguridad y rendimiento de las versiones más recientes.</p>


              <!--
              <div id="single-share" class="fixed">
                <h6 class="widget-title title-alt">Share</h6>
                <ul class="socialmedia-widget">
                  <li class="facebook"><a href="#"></a></li>
                  <li class="twitter"><a href="#"></a></li>
                  <li class="googleplus"><a href="#"></a></li>
                  <li class="pinterest"><a href="#"></a></li>
                </ul>
              </div>
              -->

            </div>
          </div>
        </section><footer id="footer" >
  <div class="footer-inner">
    <div class="column-section spaced-big clearfix">
      <div class="column one-half">
        <p>
         <img id="dark-logo" src="/assets/mariochavez.png" srcset="/assets/mariochavez.png 1x, /assets/mariochavez@2x.png 2x" alt="Mario Chávez">
        </p>
        <h6><strong>Mario Alberto Chávez Cárdenas</strong></h6>
        <small>Copyright © 2020 Mario Alberto Chávez Cárdenas.</small>
      </div>
    </div>
  </div>
</footer>
</div><script integrity="sha256-zFEi9rPqpkNHK3rBRasJy8Wg/6p9F7OJb3y7c+pYWpg=" crossorigin="anonymous" src="/assets/jquery-1.12.4.min-cc5122f6b3eaa643472b7ac145ab09cbc5a0ffaa7d17b3896f7cbb73ea585a98.js" type="text/javascript"></script>
<script integrity="sha256-wC1z/rhmt1HL4oHCWZBCfEnlDVRoyd/pgK0mw3szPwk=" crossorigin="anonymous" src="/assets/plugins-c02d73feb866b751cbe281c25990427c49e50d5468c9dfe980ad26c37b333f09.js" type="text/javascript"></script>
<script integrity="sha256-Eb+0agFdSeKjMVpciJcveYAmQCgLY/1m2j8llYabW2s=" crossorigin="anonymous" src="/assets/jquery.imagesloaded.min-11bfb46a015d49e2a3315a5c88972f79802640280b63fd66da3f2595869b5b6b.js" type="text/javascript"></script>
<script integrity="sha256-jtoBd6LGcFxlyQ6H4JYR/FT9+vgf52H0IrAh57WacZw=" crossorigin="anonymous" src="/assets/jquery.isotope.min-8eda0177a2c6705c65c90e87e09611fc54fdfaf81fe761f422b021e7b59a719c.js" type="text/javascript"></script>
<script integrity="sha256-CEBbmkbD4MhghrH5XHoh9QLFe9kWe2phWwd6j0WsD3c=" crossorigin="anonymous" src="/assets/script-08405b9a46c3e0c86086b1f95c7a21f502c57bd9167b6a615b077a8f45ac0f77.js" type="text/javascript"></script>
</body>
</html>
