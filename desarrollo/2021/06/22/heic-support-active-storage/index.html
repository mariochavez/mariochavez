<!doctype html>
<html lang="en" class="h-full antialiased">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Begin Bridgetown SEO tag v7.0.1 -->
<title>HEIC support for Active Storage | Mario Alberto Chávez - Ruby on Rails, AI Tools &amp; former CTO</title>
<meta property="og:title" content="HEIC support for Active Storage" />
<meta name="author" content="Mario Alberto Chávez" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Apple’s HEIC format is not supported out of the box on Active Storage" />
<meta property="og:description" content="Apple’s HEIC format is not supported out of the box on Active Storage" />
<link rel="canonical" href="https://mariochavez.io/desarrollo/2021/06/22/heic-support-active-storage/" />
<meta property="og:url" content="https://mariochavez.io/desarrollo/2021/06/22/heic-support-active-storage/" />
<meta property="og:site_name" content="Mario Alberto Chávez - Ruby on Rails, AI Tools &amp; former CTO" />
<meta property="og:image" content="https://mariochavez.io/images/heic/iphone.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-22T02:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mariochavez.io/images/heic/iphone.jpg" />
<meta property="twitter:title" content="HEIC support for Active Storage" />
<meta name="twitter:site" content="@mario_chavez" />
<meta name="twitter:creator" content="@Mario Alberto Chávez" />
<!-- End Bridgetown SEO tag -->


<link type="application/atom+xml" rel="alternate" href="https://mariochavez.io/feed.xml" title="Mario Alberto Chávez - Ruby on Rails, AI Tools & former CTO" />

<meta property="og:type" content="article">
<meta property="og:site_name" content="Mario Alberto Chávez - Software Development">
<meta name="twitter:card" content="summary_large_image">

<meta name="robots" content="index, follow">
<meta name="revisit-after" content="7 days">

<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<link rel="stylesheet" href="/assets/index.C2JFVGXA.css" />
<script src="/assets/index.OQDTOKYE.js" defer></script>


<script type="application/javascript">
  (function() {
    try {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    } catch (e) {
      // Fail silently
    }
  })();
</script>

<script type="application/ld+json">
  {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://mariochavez.io/#website",
      "url": "https://mariochavez.io/",
      "name": "Mario Alberto Chávez",
      "description": "Ruby on Rails architect and AI toolmaker from Colima, México. Creator of Rails MCP Server, former fintech CTO, and author of Aprendiendo Ruby on Rails. Exploring the convergence of Rails and AI.",
      "publisher": {
        "@type": "Person",
        "@id": "https://mariochavez.io/#person",
        "name": "Mario Alberto Chávez"
      },
    },
    {
      "@type": "CollectionPage",
      "@id": "https://mariochavez.io/#webpage",
      "url": "https://mariochavez.io/",
      "name": "Inicio | Mario Alberto Chávez",
      "isPartOf": {
        "@id": "https://mariochavez.io/#website"
      },
      "about": {
        "@id": "https://mariochavez.io/#person"
      },
      "description": "Ruby on Rails architect and AI toolmaker from Colima, México. Creator of Rails MCP Server, former fintech CTO, and author of Aprendiendo Ruby on Rails. Exploring the convergence of Rails and AI.",
      "breadcrumb": {
        "@id": "https://mariochavez.io/#breadcrumb"
      },
    },
    {
      "@type": "BreadcrumbList",
      "@id": "https://mariochavez.io/#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Inicio"
        }
      ]
    },
    {
      "@type": "Person",
      "@id": "https://mariochavez.io/#person",
      "name": "Mario Alberto Chávez",
      "image": {
        "@type": "ImageObject",
        "@id": "https://mariochavez.io/#personlogo",
        "inLanguage": "es-MX",
        "url": "https://mariochavez.io/images/mario_chavez.svg",
        "contentUrl": "https://mariochavez.io/images/mario_chavez.svg",
        "caption": "Mario Alberto Chávez"
      },
      "description": "I'm Mario Alberto, a software engineer and entrepreneur based in Colima, México. I'm the creator of Rails MCP Server and former CTO/co-founder of Aoorora, where I architected a core banking platform in Ruby on Rails that enabled lending startups to build on modern, secure infrastructure. I spend my time at the intersection of Ruby on Rails and AI—building tools that help developers work smarter. When I'm not writing code, I'm documenting territory, popular culture, and memory through photography.",
      "sameAs": [
        "https://github.com/mariochavez",
        "https://x.com/mario_chavez",
        "https://linkedin.com/in/mariochavez",
        "https://instagram.com/mario_chavez"
      ]
    }
  ]
}

</script>

  </head>

  <body class="flex h-full flex-col bg-zinc-50 font-manrope dark:bg-black">
    <!-- Outer Frame for the "Card" look on large screens -->
    <div class="fixed inset-0 flex justify-center sm:px-8">
      <div class="flex w-full max-w-7xl lg:px-8">
        <div
          class="
            w-full bg-white ring-1 ring-zinc-100 dark:bg-zinc-900 dark:ring-zinc-300/20
          "
        ></div>
      </div>
    </div>

    <div class="relative flex w-full flex-col">
      <!-- Header / Navigation -->
<header
  data-controller="menu"
  data-menu-open-value=false
  class="pointer-events-none relative z-50 flex flex-none flex-col"
>
  <div class="top-0 z-10 h-16 pt-6">
    <div class="sm:px-8 w-full max-w-7xl mx-auto lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="relative flex gap-4">
            <!-- Logo / Avatar -->
            <div class="flex flex-1 pointer-events-auto">
              <a
                href="/"
                class="
                  h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1
                  ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:ring-white/10
                "
              >
                <img
                  src="/images/mario.jpg"
                  alt="Mario Alberto Chávez"
                  class="
                    h-9 w-9 rounded-full bg-zinc-100 object-cover
                    dark:bg-zinc-800
                  "
                >
              </a>
            </div>

            <!-- Desktop Nav -->
            <div class="hidden md:flex flex-1 justify-center pointer-events-auto">
              <nav
                class="
                  flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg
                  shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90
                  dark:text-zinc-200 dark:ring-white/10
                "
              >
               
                  <a
                      href="/about"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  About
                  </a>
                
                  <a
                      href="/articles"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  Articles
                  </a>
                
                  <a
                      href="/projects"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  Projects
                  </a>
                
              </nav>
            </div>

            <!-- Mobile Menu Button & Theme Toggle -->
            <div class="flex flex-1 justify-end gap-4 pointer-events-auto">
              <!-- Mobile Menu Button -->
              <div class="pointer-events-auto md:hidden">
                <button
                  data-action="menu#toggle"
                  class="
                    group flex items-center rounded-full bg-white/90 px-4 py-2 text-sm font-medium
                    text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur
                    dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10
                    dark:hover:ring-white/20
                  "
                >
                  Menu
                  <i
                    class="
                      ml-3 h-auto w-2 [&_svg]:size-3 stroke-zinc-500 group-hover:stroke-zinc-700
                      dark:group-hover:stroke-zinc-400
                    "
                    
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
</i>
                </button>
              </div>

              <div 
                data-menu-target="overlay"
                data-action="click->menu#toggle"
                class="
                  data-[open=false]:hidden fixed inset-0 z-50 bg-zinc-800/40 backdrop-blur-xs duration-150 
                  opacity-100 data-[open=false]:opacity-0 ease-in dark:bg-black/80
                " 
                aria-hidden="true" 
                data-open="false">
              </div>

              <!-- Theme Toggle (Visual Only) -->
              <button
                  data-controller="theme"
                  data-theme-dark-value
                  data-action="theme#toggle"
                  class="
                    group rounded-full bg-white/90 px-3 py-2 shadow-lg ring-1 shadow-zinc-800/5 ring-zinc-900/5 
                    backdrop-blur-sm transition dark:bg-zinc-800/90 dark:ring-white/10 dark:hover:ring-white/20
                  "
              >
                <i
                  data-theme-target="light"
                  class="
                    [&_svg]:size-5 text-zinc-500 transition group-hover:fill-zinc-200
                    group-hover:text-zinc-700 dark:hidden
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
</i>

                <i
                  data-theme-target="dark"
                  class="
                    hidden [&_svg]:size-5 text-emerald-700 transition dark:block
                    dark:group-hover:text-emerald-400
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>
</i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Dropdown -->
  <div
    data-menu-target="menu"
    data-open="false"
    class="
      data-[open=false]:hidden opacity-100 data-[open=false]:opacity-0 data-[open=false]:scale-95 
      fixed inset-x-0 top-0 z-50 origin-top rounded-b-2xl bg-zinc-50 px-6 pb-6 pt-24
      shadow-2xl shadow-zinc-900/20 ring-1 ring-zinc-900/5 dark:bg-zinc-900 transition-all ease-out
      dark:ring-zinc-800 pointer-events-auto md:hidden duration-150
    "
  >
    <div class="flex flex-col space-y-4">
      <div class="flex flex-row-reverse items-center justify-between">
        <button 
           data-action="menu#toggle"
           aria-label="Close menu" 
           class="-m-1 p-1 [&_svg]:size-6 text-zinc-500 dark:text-zinc-400" 
           type="button">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m17.25 6.75-10.5 10.5M6.75 6.75l10.5 10.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
 
        </button>
        <h2 class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Navigation</h2>
      </div>
      
        <a
            href="/about"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          About
        </a>
      
        <a
            href="/articles"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          Articles
        </a>
      
        <a
            href="/projects"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          Projects
        </a>
      
    </div>
  </div>
</header>


      <main class="flex-auto pointer-events-auto">
  <div class="mt-16 sm:px-8 sm:mt-32">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="xl:relative">
            <div class="mx-auto max-w-2xl">
              <!-- Back Button -->
              <a
                href="/articles"
                aria-label="Go back to articles"
                class="
                  group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white
                  shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border
                  dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10
                  dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5
                  lg:-mt-2 lg:mb-0 xl:-top-1.5 xl:left-0 xl:mt-0
                "
              >
                <i
                  class="
                    [&_svg]:size-4 text-zinc-500 transition group-hover:text-zinc-700
                    dark:text-zinc-400 dark:group-hover:text-zinc-300
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
</i>
              </a>

              <article>
                <header class="flex flex-col">
                  <time
                      datetime="2021-06-22 01:00:00 -0600"
                    class="
                      order-first flex items-center text-base text-zinc-400
                      dark:text-zinc-500
                    "
                  >
                    <span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
                    <span class="ml-3">June 22, 2021</span>
                  </time>

                  <h1
                    class="
                      mt-6 text-4xl font-bold tracking-tight text-emerald-700 dark:text-emerald-100
                      sm:text-5xl
                    "
                  >
                  HEIC support for Active Storage
                  </h1>

                  <h3 class="text-2xl text-zinc-600 font-light tracking-tight mt-6 dark:text-zinc-100 sm:text-3xl">Apple's HEIC format is not supported out of the box on Active Storage</h3>
                </header>

                <!-- Article Content -->
                <div class="mt-8 prose prose-zinc dark:prose-invert">
                  <p>Active Storage is the Ruby on Rails solution to work with file attachments on an application. It is not the only solution available, but it comes by default as part of the framework, so there is a chance that it is used on new projects.</p>

<p>Working with images is as easy as possible; creating variants to display images in different sizes might be the most common use case in a Rails Application. The <a href="https://github.com/janko/image_processing" target="_blank">image_processing</a> gem is responsible for abstracting the complexity of creating an image variant, like resizing the image to be 300px on the longest side.</p>

<p>Underneath the image_processing gem, it uses <a href="https://imagemagick.org/script/index.php" target="_blank">ImageMagick</a> or <a href="https://libvips.github.io/libvips/" target="_blank">Vips</a> to handle image operations and transformations; by default, it uses the first, ImageMagick..</p>

<h2 id="heif-and-heic-image-formats">HEIF and HEIC image formats.</h2>

<p>High Efficiency Image File format or HEIF is a container for images and videos that requires half of the storage as JPEG with the same image quality. The HEIC format, which is a variation of HIEF and stands for High Efficiency Image Container, was introduced by Apple with the release of iOS 11 and macOS High Sierra The format is not widely adopted. For example, no browser can display a HEIC image, and only a few Android devices support it.to optimize the space of Apple’s devices.</p>

<p>The format is not widely adopted. For example, no browser can display a HEIC image, and only a few Android devices support it.</p>

<p>There is a <a href="https://www.theverge.com/2020/5/20/21262302/ap-test-fail-iphone-photos-glitch-email-college-board-jpeg-heic" target="_blank">case where High School students failed a test</a> because their school systems didn’t support the HEIC format.</p>

<h2 id="add-active-storage-support-for-heic">Add Active Storage support for HEIC.</h2>

<p>At <a href="https://creditar.io" target="_blank">Creditar.io</a>, we are working on a service that allows customers to upload a photo of a Mexican ID, then the service validates the ID extracts its information. Everything was fine until we received our first HEIC file; our service could not do anything with the file.</p>

<p>A quick <a href="https://duckduckgo.com/" target="_blank">DuckDuckGo</a> search about this told me what I already knew, no support out of the box for HEIC on Active Storage. Some work needs to be done to enable it. I came across this post, “<a href="https://hashtagjohnt.com/how-to-generage-heic-previews-in-rails-using-activestorage.html" target="_blank">How to generate HEIC previews in Rails using ActiveStorage</a>”.</p>

<p>The post explains how to create an Active Storage Previewer that converts a HEIC image into a PNG or any other format. It uses Vips as image processing library and describes how to enable Vips support on Heroku.</p>

<p>ImageMagick is used at <a href="https://creditar.io" target="_blank">Creditar.io</a>, and I didn’t want to switch to Vips. With the latest versions of ImageMagick, it can be compiled with HEIC support. If you are on macOS and use Homebrew to install dependencies, version 7.x comes with support for HEIC.</p>

<p>The changes in the previewer to work with ImageMagick are very simple.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/previewers/heic_previewer.rb</span>

<span class="k">class</span> <span class="nc">HeicPreviewer</span> <span class="o">&lt;</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Previewer</span>
  <span class="no">CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">"image/heic"</span>

  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">accept?</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
      <span class="n">blob</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">==</span> <span class="no">CONTENT_TYPE</span> <span class="o">&amp;&amp;</span> <span class="n">minimagick_exists?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">minimagick_exists?</span>
      <span class="k">return</span> <span class="vi">@minimagick_exists</span> <span class="k">unless</span> <span class="vi">@minimagick_exists</span><span class="p">.</span><span class="nf">blank?</span>

      <span class="vi">@minimagick_exists</span> <span class="o">=</span> <span class="k">defined?</span><span class="p">(</span><span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span><span class="p">)</span>
      <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2"> :: MiniMagick is not installed"</span> <span class="k">unless</span> <span class="vi">@minimagick_exists</span>

      <span class="vi">@minimagick_exists</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="n">transformations</span><span class="p">)</span>
    <span class="n">download_blob_to_tempfile</span> <span class="k">do</span> <span class="o">|</span><span class="n">input</span><span class="o">|</span>
      <span class="n">io</span> <span class="o">=</span> <span class="no">ImageProcessing</span><span class="o">::</span><span class="no">MiniMagick</span><span class="p">.</span><span class="nf">source</span><span class="p">(</span><span class="n">input</span><span class="p">).</span><span class="nf">convert</span><span class="p">(</span><span class="s2">"png"</span><span class="p">).</span><span class="nf">call</span>
      <span class="k">yield</span> <span class="ss">io: </span><span class="n">io</span><span class="p">,</span> <span class="ss">filename: </span><span class="s2">"</span><span class="si">#{</span><span class="n">blob</span><span class="p">.</span><span class="nf">filename</span><span class="p">.</span><span class="nf">base</span><span class="si">}</span><span class="s2">.png"</span><span class="p">,</span> <span class="ss">content_type: </span><span class="s2">"image/png"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The previewer needs to be registered with Active Storage via an initializer.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/active_storage.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">previewers</span> <span class="o">&lt;&lt;</span> <span class="no">HeicPreviewer</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">variable_content_types</span> <span class="o">&lt;&lt;</span> <span class="s2">"image/heic"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">variable_content_types</span> <span class="o">&lt;&lt;</span> <span class="s2">"image/heif"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And we must tell Active Storage that HEIC/HEIF content types are supported. The test for this previewer is as follows.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/previewers/heic_previewer_test.rb</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">HeicPreviewerTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">ActiveStorageBlob</span>

  <span class="no">CONTENT_TYPE</span> <span class="o">=</span> <span class="s2">"image/heic"</span>

  <span class="nb">test</span> <span class="s2">"it previews a heic image"</span> <span class="k">do</span>
    <span class="n">skip</span> <span class="s2">"it does not run on CI due to missing support for HEIC"</span> <span class="k">if</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"CI"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"true"</span>

    <span class="n">blob</span> <span class="o">=</span> <span class="n">create_file_blob</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"heic-image-file.heic"</span><span class="p">,</span> <span class="ss">content_type: </span><span class="no">CONTENT_TYPE</span><span class="p">)</span>

    <span class="n">refute_nil</span> <span class="n">blob</span>
    <span class="n">assert</span> <span class="no">HeicPreviewer</span><span class="p">.</span><span class="nf">accept?</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

    <span class="no">HeicPreviewer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">blob</span><span class="p">).</span><span class="nf">preview</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">attachable</span><span class="o">|</span>
      <span class="n">assert_equal</span> <span class="s2">"image/png"</span><span class="p">,</span> <span class="n">attachable</span><span class="p">[</span><span class="ss">:content_type</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">create_file_blog</code> method is a helper that I use to create an Active Storage blob object from a file. The test is simple; it tests that previewing or downloading a file get converted to PNG.</p>

<p>Running this test on GitHub’s CI was impossible because the ImageMagick version it provides comes without HEIC support. I tried to download and compile ImageMagick in the pipeline, but it takes too much time, so I decided to skip this test there. It works on my machine(tm), so what can go wrong, right?</p>

<p>To deploy these changes, Heroku needs a buildpack with an ImageMagick binary compiled with HEIC. There are a few of those in Heroku’s marketplace, so I settle for <a href="https://elements.heroku.com/buildpacks/himamainc/heroku-buildpack-imagemagick-heif" target="_blank">this one</a>. It needs to be installed before deploying the code changes. Installation is simple.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">heroku</span> <span class="n">buildpacks</span><span class="ss">:add</span> <span class="p">[</span><span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="no">HiMamaInc</span><span class="o">/</span><span class="n">heroku</span><span class="o">-</span><span class="n">buildpack</span><span class="o">-</span><span class="n">imagemagick</span><span class="o">-</span><span class="n">heif</span><span class="p">](</span><span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="no">HiMamaInc</span><span class="o">/</span><span class="n">heroku</span><span class="o">-</span><span class="n">buildpack</span><span class="o">-</span><span class="n">imagemagick</span><span class="o">-</span><span class="n">heif</span><span class="p">)</span> <span class="o">--</span><span class="n">index</span> <span class="mi">1</span>
</code></pre></div></div>

<p>After these changes in the code, customers can take a picture with their iPhone and send it to our service to validate their ID, no need to worry if they had HEIC enable on their phones. The service displays the thumbnail and sends a png version to the Python ML backend to be processed.</p>

                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>


      <!-- Footer -->
<footer class="mt-32 flex-none">
  <div class="sm:px-8">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="border-t border-zinc-100 pb-16 pt-10 dark:border-zinc-700/40">
        <div class="relative px-4 sm:px-8 lg:px-12">
          <div class="mx-auto max-w-2xl lg:max-w-5xl">
            <div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
              <div
                class="
                  flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800
                  dark:text-zinc-200
                "
              >
              
                <a
                    href="/about"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                About
                </a>
              
                <a
                    href="/articles"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                Articles
                </a>
              
                <a
                    href="/projects"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                Projects
                </a>
              
              </div>

              <p class="text-sm text-zinc-400 dark:text-zinc-500">
              &copy; 2025 Mario Alberto Chávez. All rights reserved.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>
</html>
