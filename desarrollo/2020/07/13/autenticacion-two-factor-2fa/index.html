<!doctype html>
<html lang="en" class="h-full antialiased">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Begin Bridgetown SEO tag v7.0.1 -->
<title>Autenticación Two-Factor (2FA) | Mario Alberto Chávez - Ruby on Rails, AI Tools &amp; former CTO</title>
<meta property="og:title" content="Autenticación Two-Factor (2FA)" />
<meta name="author" content="Mario Alberto Chávez" />
<meta property="og:locale" content="es_MX" />
<meta name="description" content="La seguridad es un factor importante en toda aplicación hoy en día, es algo que como desarrolladores de aplicaciones no debemos de dejar a la ligera. Es nuestra responsabilidad asegurar la información y la confianza de nuestros usuarios." />
<meta property="og:description" content="La seguridad es un factor importante en toda aplicación hoy en día, es algo que como desarrolladores de aplicaciones no debemos de dejar a la ligera. Es nuestra responsabilidad asegurar la información y la confianza de nuestros usuarios." />
<link rel="canonical" href="https://mariochavez.io/desarrollo/2020/07/13/autenticacion-two-factor-2fa/" />
<meta property="og:url" content="https://mariochavez.io/desarrollo/2020/07/13/autenticacion-two-factor-2fa/" />
<meta property="og:site_name" content="Mario Alberto Chávez - Ruby on Rails, AI Tools &amp; former CTO" />
<meta property="og:image" content="https://mariochavez.io/images/autenticacion/password-security.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-13T01:01:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mariochavez.io/images/autenticacion/password-security.jpg" />
<meta property="twitter:title" content="Autenticación Two-Factor (2FA)" />
<meta name="twitter:site" content="@mario_chavez" />
<meta name="twitter:creator" content="@Mario Alberto Chávez" />
<!-- End Bridgetown SEO tag -->


<link type="application/atom+xml" rel="alternate" href="https://mariochavez.io/feed.xml" title="Mario Alberto Chávez - Ruby on Rails, AI Tools & former CTO" />

<meta property="og:type" content="article">
<meta property="og:site_name" content="Mario Alberto Chávez - Software Development">
<meta name="twitter:card" content="summary_large_image">

<meta name="robots" content="index, follow">
<meta name="revisit-after" content="7 days">

<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<link rel="stylesheet" href="/assets/index.R2XT6LUA.css" />
<script src="/assets/index.OQDTOKYE.js" defer></script>


<script type="application/javascript">
  (function() {
    try {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    } catch (e) {
      // Fail silently
    }
  })();
</script>

<script type="application/ld+json">
  {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://mariochavez.io/#website",
      "url": "https://mariochavez.io/",
      "name": "Mario Alberto Chávez",
      "description": "Ruby on Rails architect and AI toolmaker from Colima, México. Creator of Rails MCP Server, former fintech CTO, and author of Aprendiendo Ruby on Rails. Exploring the convergence of Rails and AI.",
      "publisher": {
        "@type": "Person",
        "@id": "https://mariochavez.io/#person",
        "name": "Mario Alberto Chávez"
      },
    },
    {
      "@type": "CollectionPage",
      "@id": "https://mariochavez.io/#webpage",
      "url": "https://mariochavez.io/",
      "name": "Inicio | Mario Alberto Chávez",
      "isPartOf": {
        "@id": "https://mariochavez.io/#website"
      },
      "about": {
        "@id": "https://mariochavez.io/#person"
      },
      "description": "Ruby on Rails architect and AI toolmaker from Colima, México. Creator of Rails MCP Server, former fintech CTO, and author of Aprendiendo Ruby on Rails. Exploring the convergence of Rails and AI.",
      "breadcrumb": {
        "@id": "https://mariochavez.io/#breadcrumb"
      },
    },
    {
      "@type": "BreadcrumbList",
      "@id": "https://mariochavez.io/#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Inicio"
        }
      ]
    },
    {
      "@type": "Person",
      "@id": "https://mariochavez.io/#person",
      "name": "Mario Alberto Chávez",
      "image": {
        "@type": "ImageObject",
        "@id": "https://mariochavez.io/#personlogo",
        "inLanguage": "es-MX",
        "url": "https://mariochavez.io/images/mario_chavez.svg",
        "contentUrl": "https://mariochavez.io/images/mario_chavez.svg",
        "caption": "Mario Alberto Chávez"
      },
      "description": "I'm Mario Alberto, a software engineer and entrepreneur based in Colima, México. I'm the creator of Rails MCP Server and former CTO/co-founder of Aoorora, where I architected a core banking platform in Ruby on Rails that enabled lending startups to build on modern, secure infrastructure. I spend my time at the intersection of Ruby on Rails and AI—building tools that help developers work smarter. When I'm not writing code, I'm documenting territory, popular culture, and memory through photography.",
      "sameAs": [
        "https://github.com/mariochavez",
        "https://x.com/mario_chavez",
        "https://linkedin.com/in/mariochavez",
        "https://instagram.com/mario_chavez"
      ]
    }
  ]
}

</script>

  </head>

  <body class="flex h-full flex-col bg-zinc-50 font-manrope dark:bg-black">
    <!-- Outer Frame for the "Card" look on large screens -->
    <div class="fixed inset-0 flex justify-center sm:px-8">
      <div class="flex w-full max-w-7xl lg:px-8">
        <div
          class="
            w-full bg-white ring-1 ring-zinc-100 dark:bg-zinc-900 dark:ring-zinc-300/20
          "
        ></div>
      </div>
    </div>

    <div class="relative flex w-full flex-col">
      <!-- Header / Navigation -->
<header
  data-controller="menu"
  data-menu-open-value=false
  class="pointer-events-none relative z-50 flex flex-none flex-col"
>
  <div class="top-0 z-10 h-16 pt-6">
    <div class="sm:px-8 w-full max-w-7xl mx-auto lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="relative flex gap-4">
            <!-- Logo / Avatar -->
            <div class="flex flex-1 pointer-events-auto">
              <a
                href="/"
                class="
                  h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1
                  ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:ring-white/10
                "
              >
                <img
                  src="/images/mario.jpg"
                  alt="Mario Alberto Chávez"
                  class="
                    h-9 w-9 rounded-full bg-zinc-100 object-cover
                    dark:bg-zinc-800
                  "
                >
              </a>
            </div>

            <!-- Desktop Nav -->
            <div class="hidden md:flex flex-1 justify-center pointer-events-auto">
              <nav
                class="
                  flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg
                  shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90
                  dark:text-zinc-200 dark:ring-white/10
                "
              >
               
                  <a
                      href="/about"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  About
                  </a>
                
                  <a
                      href="/articles"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  Articles
                  </a>
                
                  <a
                      href="/projects"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  Projects
                  </a>
                
              </nav>
            </div>

            <!-- Mobile Menu Button & Theme Toggle -->
            <div class="flex flex-1 justify-end gap-4 pointer-events-auto">
              <!-- Mobile Menu Button -->
              <div class="pointer-events-auto md:hidden">
                <button
                  data-action="menu#toggle"
                  class="
                    group flex items-center rounded-full bg-white/90 px-4 py-2 text-sm font-medium
                    text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur
                    dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10
                    dark:hover:ring-white/20
                  "
                >
                  Menu
                  <i
                    class="
                      ml-3 h-auto w-2 [&_svg]:size-3 stroke-zinc-500 group-hover:stroke-zinc-700
                      dark:group-hover:stroke-zinc-400
                    "
                    
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
</i>
                </button>
              </div>

              <div 
                data-menu-target="overlay"
                data-action="click->menu#toggle"
                class="
                  data-[open=false]:hidden fixed inset-0 z-50 bg-zinc-800/40 backdrop-blur-xs duration-150 
                  opacity-100 data-[open=false]:opacity-0 ease-in dark:bg-black/80
                " 
                aria-hidden="true" 
                data-open="false">
              </div>

              <!-- Theme Toggle (Visual Only) -->
              <button
                  data-controller="theme"
                  data-theme-dark-value
                  data-action="theme#toggle"
                  class="
                    group rounded-full bg-white/90 px-3 py-2 shadow-lg ring-1 shadow-zinc-800/5 ring-zinc-900/5 
                    backdrop-blur-sm transition dark:bg-zinc-800/90 dark:ring-white/10 dark:hover:ring-white/20
                  "
              >
                <i
                  data-theme-target="light"
                  class="
                    [&_svg]:size-5 text-zinc-500 transition group-hover:fill-zinc-200
                    group-hover:text-zinc-700 dark:hidden
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
</i>

                <i
                  data-theme-target="dark"
                  class="
                    hidden [&_svg]:size-5 text-emerald-700 transition dark:block
                    dark:group-hover:text-emerald-400
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>
</i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Dropdown -->
  <div
    data-menu-target="menu"
    data-open="false"
    class="
      data-[open=false]:hidden opacity-100 data-[open=false]:opacity-0 data-[open=false]:scale-95 
      fixed inset-x-0 top-0 z-50 origin-top rounded-b-2xl bg-zinc-50 px-6 pb-6 pt-24
      shadow-2xl shadow-zinc-900/20 ring-1 ring-zinc-900/5 dark:bg-zinc-900 transition-all ease-out
      dark:ring-zinc-800 pointer-events-auto md:hidden duration-150
    "
  >
    <div class="flex flex-col space-y-4">
      <div class="flex flex-row-reverse items-center justify-between">
        <button 
           data-action="menu#toggle"
           aria-label="Close menu" 
           class="-m-1 p-1 [&_svg]:size-6 text-zinc-500 dark:text-zinc-400" 
           type="button">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m17.25 6.75-10.5 10.5M6.75 6.75l10.5 10.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
 
        </button>
        <h2 class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Navigation</h2>
      </div>
      
        <a
            href="/about"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          About
        </a>
      
        <a
            href="/articles"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          Articles
        </a>
      
        <a
            href="/projects"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          Projects
        </a>
      
    </div>
  </div>
</header>


      <main class="flex-auto pointer-events-auto">
  <div class="mt-16 sm:px-8 sm:mt-32">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="xl:relative">
            <div class="mx-auto max-w-2xl">
              <!-- Back Button -->
              <a
                href="/articles"
                aria-label="Go back to articles"
                class="
                  group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white
                  shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border
                  dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10
                  dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5
                  lg:-mt-2 lg:mb-0 xl:-top-1.5 xl:left-0 xl:mt-0
                "
              >
                <i
                  class="
                    [&_svg]:size-4 text-zinc-500 transition group-hover:text-zinc-700
                    dark:text-zinc-400 dark:group-hover:text-zinc-300
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
</i>
              </a>

              <article>
                <header class="flex flex-col">
                  <time
                      datetime="2020-07-13 00:01:00 -0600"
                    class="
                      order-first flex items-center text-base text-zinc-400
                      dark:text-zinc-500
                    "
                  >
                    <span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
                    <span class="ml-3">July 13, 2020</span>
                  </time>

                  <h1
                    class="
                      mt-6 text-4xl font-bold tracking-tight text-emerald-700 dark:text-emerald-100
                      sm:text-5xl
                    "
                  >
                  Autenticación Two-Factor (2FA)
                  </h1>

                  <h3 class="text-2xl text-zinc-600 font-light tracking-tight mt-6 dark:text-zinc-100 sm:text-3xl">La seguridad es un factor importante en toda aplicación hoy en día, es algo que como desarrolladores de aplicaciones no debemos de dejar a la ligera. Es nuestra responsabilidad asegurar la información y la confianza de nuestros usuarios.</h3>
                </header>

                <!-- Article Content -->
                <div class="mt-8 prose prose-zinc dark:prose-invert">
                  <h1 id="autenticación-two-factor-2fa">Autenticación Two-Factor (2FA)</h1>

<p>El publicar una aplicación en Internet automáticamente vuelve la cuestión de seguridad un tema importante como el agregar nuevas características o solucionar errores en la misma.</p>

<p>Aunque Ruby on Rails  por omisión configura toda nueva aplicación con ciertos parámetros que básicos de seguridad hay detalles que nosotros como desarrolladores o administradores de una aplicación debemos de tomar.</p>

<p>El el post de hace unas semanas <a href="https://mariochavez.io/desarrollo/2020/06/15/seguridad-ruby-aplicacion.html" target="_blank">Proteger tu aplicación de ataques en Internet</a> platiqué de acciones que podemos configurar para proteger una aplicación de posibles ataques, el la mayoría automatizados.</p>

<p>Ahora en este post quiero hablar de el tema de cómo proteger a nuestros usuarios del robo de contraseñas o de un tipo de ataque llamado <em>phising</em> diseñado con la misma idea de robar credenciales.</p>

<h2 id="two-factor-2fa-contraseñas-de-un-sólo-uso">Two-Factor (2FA) contraseñas de un sólo uso</h2>

<p>En muchas de las aplicaciones modernas que se preocupan por la seguridad de sus usuarios agregan un nivel más a la protección de contraseñas. Aplicaciones de correo electrónico, de información financiera o bancos entre muchas otras cuentan como una opción más de protección las contraseñas de un sólo uso.</p>

<p>Este tipo de seguridad se conoce como autenticación <em>Two-Factor</em> e implica que el usuario aparte de su contraseña para iniciar una sesión necesita generar un código temporal de un sólo uso con una aplicación de su teléfono. La aplicación registra un código secreto que utiliza para generar los códigos temporales que el usuario necesita.</p>

<p>Aplicaciones como Google Authenticator o <a href="https://authy.com/" target="_blank">Authy</a> se utilizan para generar ese código temporal.</p>

<p>Otra forma de implementar las contraseñas de un sólo uso es con el envío del código temporal a través de SMS al teléfono del usuario como segundo paso después de introducir su contraseña.</p>

<h2 id="rails-y-otp">Rails y OTP</h2>

<p>Implementar OTP en una aplicación de Ruby on Rails es relativamente sencillo gracias a la gema <a href="https://github.com/mdp/rotp" target="_blank">rtop</a> que hace todo el trabajo de implementar los <a href="http://tools.ietf.org/html/rfc4226" target="_blank">RFC 4226</a> y <a href="http://tools.ietf.org/html/rfc6238" target="_blank">RFC 6238</a> para contraseñas de un sólo uso por contador o por tiempo.</p>

<p>Realmente utilizando <em>rtop</em> lo complicado es diseñar un flujo que sea amigable para el usuario no técnico dónde se le lleve por el proceso de activar su cuenta para que este protegida por 2FA. Además, hay que darle la posibilidad al usuario de poder tener acceso a la misma en caso de que su dispositivo móvil se haya dañado o extraviado; esto generalmente sucede con un grupo de códigos de recuperación que el usuario recibe al momento de activar su cuenta para 2FA.</p>

<h3 id="la-aplicación">La aplicación</h3>

<p>Para el contenido de este post cree una aplicación de Ruby on Rails con la implementación de OTP y sus flujos. Donde la lógica de controladores y vistas están dentro de un <em>namespace</em> llamado <strong><em>Otp</em></strong> con la finalidad de que sea sencilla su reutilización en otras aplicaciones.</p>

<p>Para el sistema de autenticación vía correo electrónico y contraseña no utilicé ninguna de las librerías populares, en su lugar utilicé un generador que desarrollé hace algunos años y que genera lo básico para poder registrarse e iniciar y cerrar sesión utilizando la funcionalidad de <a href="http://api.rubyonrails.org/classes/ActiveModel/SecurePassword/ClassMethods.html#method-i-has_secure_password" target="_blank">has_secure_password</a> de Rails. El motivo de esta decisión es eliminar la complejidad de las librerías conocidas del foco de la implementación de OTP. El código del generador está disponible en su <a href="https://github.com/mariochavez/mac_generators/" target="_blank">repositorio</a>.</p>

<p>El repositorio del código de esta aplicación está disponible en el <a href="https://github.com/mariochavez/rails-two-factor-otp" target="_blank">repositorio</a>. El post no va a mostrar en detalle el código por lo que va a ser necesario hacer referencia en el repositorio.</p>

<p>La aplicación de Rails de creó como se muestra a continuación. Se desactivaron algunos <em>frameworks</em> de Ruby on Rails que no son útiles para los objetivos de esta aplicación. Adicionalmente se instaló Webpack y Stimulus, siendo el último utilizado en varias partes de la aplicación que veremos un poco más adelante.</p>

<p>Finalmente con el generador que mencioné anteriormente generamos modelos, vistas y controladores para poder realizar registro y autenticación vía correo electrónico. Por omisión en lugar de crear el modelo <strong><em>User</em></strong>, al que estamos acostumbrados, se crea el modelo <strong><em>Identity</em></strong>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">rail</span> <span class="n">new</span> <span class="n">otp_security</span> <span class="o">-</span><span class="n">d</span> <span class="n">postgresql</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">mailer</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">mailbox</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">text</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">active</span><span class="o">-</span><span class="n">storage</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">action</span><span class="o">-</span><span class="n">cable</span> <span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">sprockets</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">otp_security</span>
<span class="err">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">webpacker</span><span class="ss">:install</span>
<span class="err">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">webpacker</span><span class="ss">:install:stimulus</span>
<span class="err">$</span> <span class="n">yarn</span> <span class="n">add</span> <span class="n">bulma</span>
<span class="err">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">rails</span> <span class="n">g</span> <span class="n">authentication</span><span class="ss">:email</span>
</code></pre></div></div>

<h3 id="activar-2fa">Activar 2FA</h3>

<p>Activar 2FA para un usuario implica el explicarle al usuario en qué consiste y cómo va a cambiar su experiencia al iniciar sesión y llevarlo de la mano en el proceso.</p>

<p>El proceso tipo “<em>wizard</em>” se inicia con el controlador <code class="highlighter-rouge">Otp::ConfigureController</code> en donde inicialmente con la ayuda de <em>rtop</em> se genera un código secreto y único por cada usuario.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">new</span>
  <span class="vi">@otp_secret</span> <span class="o">=</span> <span class="n">generate_otp_secret</span>
  <span class="vi">@qr_code</span> <span class="o">=</span> <span class="n">generate_qr_code_url</span><span class="p">(</span><span class="vi">@otp_secret</span><span class="p">,</span> <span class="n">current_identity</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>El “<em>wizard</em>” informativo es manejado por el controlador de Stimulus <code class="highlighter-rouge">wizard_controller.js</code>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Controller</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">stimulus</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="nc">extends</span> <span class="nx">Controller</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="nx">targets</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">slide</span><span class="dl">"</span><span class="p">];</span>

  <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nf">showSlide</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nf">disconnect</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nf">showSlide</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nf">next</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nf">stopPropagation</span><span class="p">();</span>
    <span class="nx">event</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nf">showSlide</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nf">back</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">event</span><span class="p">.</span><span class="nf">stopPropagation</span><span class="p">();</span>
      <span class="nx">event</span><span class="p">.</span><span class="nf">preventDefault</span><span class="p">();</span>

      <span class="k">this</span><span class="p">.</span><span class="nf">showSlide</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nf">showSlide</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">slideTargets</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">element</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nf">getAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">data-wizard-index</span><span class="dl">"</span><span class="p">));</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">toggle</span><span class="p">(</span><span class="dl">"</span><span class="s2">wizard--current</span><span class="dl">"</span><span class="p">,</span> <span class="nx">index</span> <span class="o">===</span> <span class="nx">idx</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Al final del “<em>wizard</em>” al usuario se le presenta un código QR que debe de escanear utilizando una aplicación de autenticación 2FA compatible con Google Authenticator como <a href="https://authy.com/" target="_blank">Authy</a>. Después de escanear y registrar la autenticación en la aplicación móvil el usuario tiene que introducir el código generado para verificar que todo se encuentra listo para habilitar 2FA para el usuario.</p>

<p>El código del usuario se recibe en el controlador <code class="highlighter-rouge">Otp::ConfigureController</code> donde una vez que ha sido verificado se guarda el secreto único del usuario, se guarda el <em>timestamp</em> del último código que verificó el usuario y se generan 10 código de recuperación en caso de el usuario pierda o se le dañe su dispositivo y que no quede bloqueado.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">otp_secret</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:otp_secret</span><span class="p">]</span>
  <span class="n">otp_code</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:otp_code</span><span class="p">]</span>

  <span class="n">last_otp_at</span> <span class="o">=</span> <span class="n">verify_otp_code</span><span class="p">(</span><span class="n">otp_secret</span><span class="p">,</span> <span class="n">otp_code</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">last_otp_at</span><span class="p">.</span><span class="nf">present?</span>
    <span class="vi">@recovery_codes</span> <span class="o">=</span> <span class="n">generate_recovery_codes</span>
    <span class="n">current_identity</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">identity</span><span class="o">|</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">last_otp_at</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">last_otp_at</span><span class="p">).</span><span class="nf">utc</span><span class="p">.</span><span class="nf">to_datetime</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">otp_secret_key</span> <span class="o">=</span> <span class="n">otp_secret</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">recovery_codes</span> <span class="o">=</span> <span class="vi">@recovery_codes</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
      <span class="n">identity</span><span class="p">.</span><span class="nf">save</span>
    <span class="k">end</span>

    <span class="n">redirect_to</span> <span class="n">otp_complete_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"2AF enabled succesfully"</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span><span class="ss">error: </span><span class="s2">"Verification code is invalid"</span><span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>El código único y secreto así como los código de recuperación son secretos sensibles de los cuales tenemos que prevenir que caigan en manos no confiables. Es por este motivo que esos atributos se guardan cifrados en la base de datos con la ayuda de la gema <a href="https://github.com/attr-encrypted/attr_encrypted" target="_blank">attr_encrypted</a>. La llave de cifrado se guarda en las credenciales de Rails.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Identity</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_secure_password</span> <span class="ss">validations: </span><span class="kp">true</span>

  <span class="n">attr_encrypted</span> <span class="ss">:otp_secret_key</span><span class="p">,</span> <span class="ss">:recovery_codes</span><span class="p">,</span> <span class="ss">key: </span><span class="no">Base64</span><span class="p">.</span><span class="nf">decode64</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">credentials</span><span class="p">.</span><span class="nf">encryption</span><span class="p">[</span><span class="ss">:otp_secret_key</span><span class="p">])</span>

  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">if: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span> <span class="n">r</span><span class="p">.</span><span class="nf">password</span><span class="p">.</span><span class="nf">present?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>La llave de cifrado se genera en una consola de Ruby con el siguiente comando <code class="highlighter-rouge">Base64.encode64(SecureRandom.random_bytes(32))</code>.</p>

<p>Una vez que se validó el código y se guardó la información secreta, al usuario se le muestran sus códigos de recuperación, los cuales van a ser visibles esta única ocasión y se le muestra al usuario opciones para copiar los códigos al “<em>clipboard</em>” o imprimirlos o descargarlos en un archivo. Es responsabilidad del usuario guardarlo y mantenerlos seguros. El controlador <code class="highlighter-rouge">Otp::CompleteController</code> se encarga de esta parte.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">show</span>
  <span class="n">current_identity</span><span class="p">.</span><span class="nf">update_column</span><span class="p">(</span><span class="ss">:otp_enabled_at</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">zone</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
  <span class="vi">@recovery_codes</span> <span class="o">=</span> <span class="n">current_identity</span><span class="p">.</span><span class="nf">recovery_codes</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>La lógica para copiar, imprimir o descargar los códigos de recuperación está implementada en los controladores de Stimulus <code class="highlighter-rouge">clipboard_controller.js</code>, <code class="highlighter-rouge">print_controller.js</code> y <code class="highlighter-rouge">download_controller.js</code>.</p>

<div class="gallery">
  <figure>
    <img src="/images/autenticacion/login-with-otp.gif" loading="lazy" />
  </figure>
</div>

<h3 id="nuevo-inicio-de-sesión">Nuevo inicio de sesión</h3>

<p>Con 2FA activado para un usuario su flujo de inicio de sesión cambia. Ahora el usuario después de ingresar sus credenciales, se le pedirá que ingrese el código temporal que se genera en su aplicación de autenticación en el móvil.</p>

<p>El código se valida y si es correcto entonces se guarda la última ocasión que el usuario validó un código correcto, esto con el fin de evitar que el código se pueda reutilizar en la ventana de 30 segundos que es cuando se genera un nuevo código.</p>

<p>Si el código no es válido, entonces el usuario no va a poder iniciar sesión.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:code</span><span class="p">]</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">strip</span>
  <span class="n">verified</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="k">if</span> <span class="n">present_code?</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">last_otp_at</span> <span class="o">=</span> <span class="n">verify_otp_code</span><span class="p">(</span><span class="n">current_identity</span><span class="p">.</span><span class="nf">otp_secret_key</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">current_identity</span><span class="p">.</span><span class="nf">last_otp_at</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">last_otp_at</span><span class="p">.</span><span class="nf">present?</span>
      <span class="n">current_identity</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">last_otp_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="n">last_otp_at</span><span class="p">).</span><span class="nf">utc</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">)</span>
      <span class="n">verified</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="k">else</span>
      <span class="n">verified_code</span><span class="p">,</span> <span class="n">recovery_codes</span> <span class="o">=</span> <span class="n">verify_recovery_code</span><span class="p">(</span><span class="n">current_identity</span><span class="p">.</span><span class="nf">recovery_codes</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">verified_code</span><span class="p">.</span><span class="nf">present?</span>
        <span class="n">current_identity</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">recovery_codes: </span><span class="n">recovery_codes</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">))</span>
        <span class="n">verified</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">verified</span>
      <span class="n">warden</span><span class="p">.</span><span class="nf">session</span><span class="p">(</span><span class="ss">:identity</span><span class="p">)[</span><span class="s2">"otp_verified"</span><span class="p">]</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">return</span> <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="n">t</span><span class="p">(</span><span class="s2">".logged_in"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">render</span> <span class="ss">json: </span><span class="p">{</span><span class="ss">error: </span><span class="s2">"Verification code is invalid"</span><span class="p">},</span> <span class="ss">status: :unprocessable_entity</span>
<span class="k">end</span>
</code></pre></div></div>

<p>En caso de que el usuario haya perdido acceso a la aplicación móvil que genera los códigos temporales este puede hacer uso de uno de los 10 códigos de recuperación en lugar del código temporal. Al hacer uso del código de recuperación y que sea válido, este se elimina impidiendo que se pueda volver a utilizar y se le permite el inicio de sesión al usuario.</p>

<p>Esta código se encuentra en el controlador <code class="highlighter-rouge">Otp::VerifyController</code>.</p>

<div class="gallery">
  <figure>
    <img src="/images/autenticacion/login-with-recovery-code.gif" loading="lazy" />
  </figure>
</div>

<h3 id="deshabilitar-2fa">Deshabilitar 2FA</h3>

<p>Aunque no es lo recomendable, el usuario que ha iniciado puede deshabilitar la necesidad de autenticación 2FA al iniciar sesión. Esto puede ser necesario en el caso de que el usuario cambie de dispositivo móvil por lo que es necesario deshabilitar 2FA y volver a habilitarlo con el nuevo dispositivo.</p>

<p>En el controlador <code class="highlighter-rouge">Otp::DisableController</code> se realiza la desactivación de 2FA dónde se elimina la información como secretos, códigos de recuperación y otros datos adicionales que en conjunto deshabilitan 2FA.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">destroy</span>
  <span class="n">current_identity</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">identity</span><span class="o">|</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">last_otp_at</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">otp_secret_key</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">recovery_codes</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">otp_enabled_at</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">identity</span><span class="p">.</span><span class="nf">save</span>
  <span class="k">end</span>

  <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"2FA disabled succesfully"</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="gallery">
  <figure>
    <img src="/images/autenticacion/disable-otp.gif" loading="lazy" />
  </figure>
</div>

<h3 id="detalles-finales-de-la-aplicación">Detalles finales de la aplicación</h3>

<p>El módulo <code class="highlighter-rouge">Otp::Base</code> incluye la lógica común entre los controladores relacionados en el proceso de 2FA.</p>

<p>En el proyecto disponible en el repositorio mencionado al inicio del post se incluyen también algunas pruebas de sistema, es decir pruebas dónde se automatiza el navegador para simular la interacción del usuario. Las pruebas tienen comentarios que explican qué operaciones son las que se están realizando para verificar los escenarios de 2FA.</p>

<h2 id="conclusiones">Conclusiones</h2>

<p>La seguridad es un factor importante en toda aplicación hoy en día, es algo que como desarrolladores de aplicaciones no debemos de dejar a la ligera. Es nuestra responsabilidad asegurar la información y la confianza de nuestros usuarios.</p>

<p>Estoy seguro que al revisar a detalle el código de la aplicación de ejemplo veremos que es sencillo implementar un nivel más de seguridad en nuestras aplicaciones y que el código está pensado en que pueda ser reutilizado.</p>

                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>


      <!-- Footer -->
<footer class="mt-32 flex-none">
  <div class="sm:px-8">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="border-t border-zinc-100 pb-16 pt-10 dark:border-zinc-700/40">
        <div class="relative px-4 sm:px-8 lg:px-12">
          <div class="mx-auto max-w-2xl lg:max-w-5xl">
            <div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
              <div
                class="
                  flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800
                  dark:text-zinc-200
                "
              >
              
                <a
                    href="/about"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                About
                </a>
              
                <a
                    href="/articles"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                Articles
                </a>
              
                <a
                    href="/projects"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                Projects
                </a>
              
              </div>

              <p class="text-sm text-zinc-400 dark:text-zinc-500">
              &copy; 2025 Mario Alberto Chávez. All rights reserved.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>
</html>
