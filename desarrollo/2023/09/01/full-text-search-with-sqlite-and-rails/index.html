<!doctype html>
<html lang="en" class="h-full antialiased">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Begin Bridgetown SEO tag v7.0.1 -->
<title>Full-text search with SQLite and Rails | Mario Alberto Chávez - Ruby on Rails, AI Tools &amp; former CTO</title>
<meta property="og:title" content="Full-text search with SQLite and Rails" />
<meta name="author" content="Mario Alberto Chávez" />
<meta property="og:locale" content="en" />
<meta name="description" content="Integrate SQLite fts5 extension for Full-text search in Ruby on Rails applications." />
<meta property="og:description" content="Integrate SQLite fts5 extension for Full-text search in Ruby on Rails applications." />
<link rel="canonical" href="https://mariochavez.io/desarrollo/2023/09/01/full-text-search-with-sqlite-and-rails/" />
<meta property="og:url" content="https://mariochavez.io/desarrollo/2023/09/01/full-text-search-with-sqlite-and-rails/" />
<meta property="og:site_name" content="Mario Alberto Chávez - Ruby on Rails, AI Tools &amp; former CTO" />
<meta property="og:image" content="https://mariochavez.io/images/full-text-search/full-text-search.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-01T00:00:00-06:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://mariochavez.io/images/full-text-search/full-text-search.jpg" />
<meta property="twitter:title" content="Full-text search with SQLite and Rails" />
<meta name="twitter:site" content="@mario_chavez" />
<meta name="twitter:creator" content="@Mario Alberto Chávez" />
<!-- End Bridgetown SEO tag -->


<link type="application/atom+xml" rel="alternate" href="https://mariochavez.io/feed.xml" title="Mario Alberto Chávez - Ruby on Rails, AI Tools & former CTO" />

<meta property="og:type" content="article">
<meta property="og:site_name" content="Mario Alberto Chávez - Software Development">
<meta name="twitter:card" content="summary_large_image">

<meta name="robots" content="index, follow">
<meta name="revisit-after" content="7 days">

<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<link rel="stylesheet" href="/assets/index.R2XT6LUA.css" />
<script src="/assets/index.OQDTOKYE.js" defer></script>


<script type="application/javascript">
  (function() {
    try {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    } catch (e) {
      // Fail silently
    }
  })();
</script>

<script type="application/ld+json">
  {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "https://mariochavez.io/#website",
      "url": "https://mariochavez.io/",
      "name": "Mario Alberto Chávez",
      "description": "Ruby on Rails architect and AI toolmaker from Colima, México. Creator of Rails MCP Server, former fintech CTO, and author of Aprendiendo Ruby on Rails. Exploring the convergence of Rails and AI.",
      "publisher": {
        "@type": "Person",
        "@id": "https://mariochavez.io/#person",
        "name": "Mario Alberto Chávez"
      },
    },
    {
      "@type": "CollectionPage",
      "@id": "https://mariochavez.io/#webpage",
      "url": "https://mariochavez.io/",
      "name": "Inicio | Mario Alberto Chávez",
      "isPartOf": {
        "@id": "https://mariochavez.io/#website"
      },
      "about": {
        "@id": "https://mariochavez.io/#person"
      },
      "description": "Ruby on Rails architect and AI toolmaker from Colima, México. Creator of Rails MCP Server, former fintech CTO, and author of Aprendiendo Ruby on Rails. Exploring the convergence of Rails and AI.",
      "breadcrumb": {
        "@id": "https://mariochavez.io/#breadcrumb"
      },
    },
    {
      "@type": "BreadcrumbList",
      "@id": "https://mariochavez.io/#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Inicio"
        }
      ]
    },
    {
      "@type": "Person",
      "@id": "https://mariochavez.io/#person",
      "name": "Mario Alberto Chávez",
      "image": {
        "@type": "ImageObject",
        "@id": "https://mariochavez.io/#personlogo",
        "inLanguage": "es-MX",
        "url": "https://mariochavez.io/images/mario_chavez.svg",
        "contentUrl": "https://mariochavez.io/images/mario_chavez.svg",
        "caption": "Mario Alberto Chávez"
      },
      "description": "I'm Mario Alberto, a software engineer and entrepreneur based in Colima, México. I'm the creator of Rails MCP Server and former CTO/co-founder of Aoorora, where I architected a core banking platform in Ruby on Rails that enabled lending startups to build on modern, secure infrastructure. I spend my time at the intersection of Ruby on Rails and AI—building tools that help developers work smarter. When I'm not writing code, I'm documenting territory, popular culture, and memory through photography.",
      "sameAs": [
        "https://github.com/mariochavez",
        "https://x.com/mario_chavez",
        "https://linkedin.com/in/mariochavez",
        "https://instagram.com/mario_chavez"
      ]
    }
  ]
}

</script>

  </head>

  <body class="flex h-full flex-col bg-zinc-50 font-manrope dark:bg-black">
    <!-- Outer Frame for the "Card" look on large screens -->
    <div class="fixed inset-0 flex justify-center sm:px-8">
      <div class="flex w-full max-w-7xl lg:px-8">
        <div
          class="
            w-full bg-white ring-1 ring-zinc-100 dark:bg-zinc-900 dark:ring-zinc-300/20
          "
        ></div>
      </div>
    </div>

    <div class="relative flex w-full flex-col">
      <!-- Header / Navigation -->
<header
  data-controller="menu"
  data-menu-open-value=false
  class="pointer-events-none relative z-50 flex flex-none flex-col"
>
  <div class="top-0 z-10 h-16 pt-6">
    <div class="sm:px-8 w-full max-w-7xl mx-auto lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="relative flex gap-4">
            <!-- Logo / Avatar -->
            <div class="flex flex-1 pointer-events-auto">
              <a
                href="/"
                class="
                  h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1
                  ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:ring-white/10
                "
              >
                <img
                  src="/images/mario.jpg"
                  alt="Mario Alberto Chávez"
                  class="
                    h-9 w-9 rounded-full bg-zinc-100 object-cover
                    dark:bg-zinc-800
                  "
                >
              </a>
            </div>

            <!-- Desktop Nav -->
            <div class="hidden md:flex flex-1 justify-center pointer-events-auto">
              <nav
                class="
                  flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg
                  shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90
                  dark:text-zinc-200 dark:ring-white/10
                "
              >
               
                  <a
                      href="/about"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  About
                  </a>
                
                  <a
                      href="/articles"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  Articles
                  </a>
                
                  <a
                      href="/projects"
                    class="
                      relative block px-3 py-2 transition hover:text-emerald-500
                      dark:hover:text-emerald-400
                    "
                  >
                  Projects
                  </a>
                
              </nav>
            </div>

            <!-- Mobile Menu Button & Theme Toggle -->
            <div class="flex flex-1 justify-end gap-4 pointer-events-auto">
              <!-- Mobile Menu Button -->
              <div class="pointer-events-auto md:hidden">
                <button
                  data-action="menu#toggle"
                  class="
                    group flex items-center rounded-full bg-white/90 px-4 py-2 text-sm font-medium
                    text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur
                    dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10
                    dark:hover:ring-white/20
                  "
                >
                  Menu
                  <i
                    class="
                      ml-3 h-auto w-2 [&_svg]:size-3 stroke-zinc-500 group-hover:stroke-zinc-700
                      dark:group-hover:stroke-zinc-400
                    "
                    
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
</i>
                </button>
              </div>

              <div 
                data-menu-target="overlay"
                data-action="click->menu#toggle"
                class="
                  data-[open=false]:hidden fixed inset-0 z-50 bg-zinc-800/40 backdrop-blur-xs duration-150 
                  opacity-100 data-[open=false]:opacity-0 ease-in dark:bg-black/80
                " 
                aria-hidden="true" 
                data-open="false">
              </div>

              <!-- Theme Toggle (Visual Only) -->
              <button
                  data-controller="theme"
                  data-theme-dark-value
                  data-action="theme#toggle"
                  class="
                    group rounded-full bg-white/90 px-3 py-2 shadow-lg ring-1 shadow-zinc-800/5 ring-zinc-900/5 
                    backdrop-blur-sm transition dark:bg-zinc-800/90 dark:ring-white/10 dark:hover:ring-white/20
                  "
              >
                <i
                  data-theme-target="light"
                  class="
                    [&_svg]:size-5 text-zinc-500 transition group-hover:fill-zinc-200
                    group-hover:text-zinc-700 dark:hidden
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
</i>

                <i
                  data-theme-target="dark"
                  class="
                    hidden [&_svg]:size-5 text-emerald-700 transition dark:block
                    dark:group-hover:text-emerald-400
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>
</i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Dropdown -->
  <div
    data-menu-target="menu"
    data-open="false"
    class="
      data-[open=false]:hidden opacity-100 data-[open=false]:opacity-0 data-[open=false]:scale-95 
      fixed inset-x-0 top-0 z-50 origin-top rounded-b-2xl bg-zinc-50 px-6 pb-6 pt-24
      shadow-2xl shadow-zinc-900/20 ring-1 ring-zinc-900/5 dark:bg-zinc-900 transition-all ease-out
      dark:ring-zinc-800 pointer-events-auto md:hidden duration-150
    "
  >
    <div class="flex flex-col space-y-4">
      <div class="flex flex-row-reverse items-center justify-between">
        <button 
           data-action="menu#toggle"
           aria-label="Close menu" 
           class="-m-1 p-1 [&_svg]:size-6 text-zinc-500 dark:text-zinc-400" 
           type="button">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m17.25 6.75-10.5 10.5M6.75 6.75l10.5 10.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
 
        </button>
        <h2 class="text-sm font-medium text-zinc-600 dark:text-zinc-400">Navigation</h2>
      </div>
      
        <a
            href="/about"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          About
        </a>
      
        <a
            href="/articles"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          Articles
        </a>
      
        <a
            href="/projects"
          class="block text-base font-semibold text-zinc-800 dark:text-zinc-100"
        >
          Projects
        </a>
      
    </div>
  </div>
</header>


      <main class="flex-auto pointer-events-auto">
  <div class="mt-16 sm:px-8 sm:mt-32">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="relative px-4 sm:px-8 lg:px-12">
        <div class="mx-auto max-w-2xl lg:max-w-5xl">
          <div class="xl:relative">
            <div class="mx-auto max-w-2xl">
              <!-- Back Button -->
              <a
                href="/articles"
                aria-label="Go back to articles"
                class="
                  group mb-8 flex h-10 w-10 items-center justify-center rounded-full bg-white
                  shadow-md shadow-zinc-800/5 ring-1 ring-zinc-900/5 transition dark:border
                  dark:border-zinc-700/50 dark:bg-zinc-800 dark:ring-0 dark:ring-white/10
                  dark:hover:border-zinc-700 dark:hover:ring-white/20 lg:absolute lg:-left-5
                  lg:-mt-2 lg:mb-0 xl:-top-1.5 xl:left-0 xl:mt-0
                "
              >
                <i
                  class="
                    [&_svg]:size-4 text-zinc-500 transition group-hover:text-zinc-700
                    dark:text-zinc-400 dark:group-hover:text-zinc-300
                  "
                  ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
</i>
              </a>

              <article>
                <header class="flex flex-col">
                  <time
                      datetime="2023-09-01 00:00:00 -0600"
                    class="
                      order-first flex items-center text-base text-zinc-400
                      dark:text-zinc-500
                    "
                  >
                    <span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span>
                    <span class="ml-3">September 01, 2023</span>
                  </time>

                  <h1
                    class="
                      mt-6 text-4xl font-bold tracking-tight text-emerald-700 dark:text-emerald-100
                      sm:text-5xl
                    "
                  >
                  Full-text search with SQLite and Rails
                  </h1>

                  <h3 class="text-2xl text-zinc-600 font-light tracking-tight mt-6 dark:text-zinc-100 sm:text-3xl">Integrate SQLite fts5 extension for Full-text search in Ruby on Rails applications.</h3>
                </header>

                <!-- Article Content -->
                <div class="mt-8 prose prose-zinc dark:prose-invert">
                  <p>Today, I planned to move a few small Ruby on Rails applications with Heroku using <a href="https://kamal-deploy.org/">Kamal</a> onto a single server. All applications use PostgreSQL as the database because it is simple to use with Heroku and because they take advantage of Postgres’ full-text search.</p>

<p>Because of the size and usage of those applications, I was not convinced that I wanted to manage my own PostgreSQL server or pay for a managed service. So, I started to consider replacing the database with <a href="https://www.sqlite.org/index.html">SQLite</a>. At least in my feed at <a href="https://x.com/mario_chavez">X</a>, I have seen so many posts in the past few months on how good and fast it is.</p>

<p>I wanted something like the <a href="https://github.com/Casecommons/pg_search#pg_search_scope">pg_search</a> gem, where I could define a scope name and the fields to be indexed. On the SQLite side, I found that it has an extension called <a href="https://www.sqlite.org/fts5.html">FTS5</a>, which is defined as:</p>

<blockquote>
  <p>FTS5 is an SQLite <a href="https://www.sqlite.org/c3ref/module.html">virtual table module</a> that provides <a href="https://en.wikipedia.org/wiki/Full_text_search">full-text search</a> functionality to database applications. In their most elementary form, full-text search engines allow the user to efficiently search a large collection of documents for the subset that contains one or more instances of a search term. The search functionality provided to World Wide Web users by Google is, among other things, a full-text search engine, as it allows users to search for all documents on the web that contain, for example, the term “fts5”.</p>

</blockquote>

<p>This looked promising, so I started implementing a quick and dirty solution for my needs.
Starting from a model Post with title and content attributes, I want to define a <code class="highlighter-rouge">full_search</code> scope and indicate the attributes to index for full-text search.</p>

<p>Something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">SqliteSearch</span>

  <span class="n">search_scope</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:content</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Where <code class="highlighter-rouge">SqliteSearch</code> is the module that does the heavy work. Before continuing with the implementation, there are decisions to be made regarding how to store the indexed data in the database. A virtual table is required to store the indexed data; one option is to create a single table for this purpose with a <code class="highlighter-rouge">record_type</code> and <code class="highlighter-rouge">record_id</code> fields to identify the data per model type, just like the way it works for ActiveStorage or ActionText in Rails.</p>

<p>The second option is to create a table per indexed model. I chose this option since not all my models require this functionality. The migration for this table is as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PostSearch</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">execute</span><span class="p">(</span><span class="s2">"CREATE VIRTUAL TABLE fts_posts USING fts5(title, content, post_id)"</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">execute</span><span class="p">(</span><span class="s2">"DROP TABLE IF EXISTS fts_posts"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The table name follows the Rails convention, but it adds the prefix <code class="highlighter-rouge">fts_</code>. The table fields are the ones that need indexing with the addition of the original record id with the foreign key convention. SQLite virtual tables don’t have data types, primary keys, constraints, or indexes.</p>

<p>The <code class="highlighter-rouge">SqliteSearch</code> module needs to implement a way to add or update the model data to the search index. This is done using the <strong>ActiveRecord</strong> callbacks for save and destroy commit.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">SqliteSearch</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="kp">private</span> <span class="k">def</span> <span class="nf">update_search_index</span>
    <span class="n">primary_key</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">primary_key</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">table_name</span>
    <span class="n">foreign_key</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">foreign_key</span>

    <span class="n">search_attrs</span> <span class="o">=</span> <span class="vc">@@search_scope_attrs</span><span class="p">.</span><span class="nf">each_with_object</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="kp">attr</span><span class="p">,</span> <span class="n">acc</span><span class="o">|</span>
      <span class="n">acc</span><span class="p">[</span><span class="kp">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">quote_string</span><span class="p">(</span><span class="nb">send</span><span class="p">(</span><span class="kp">attr</span><span class="p">)</span> <span class="o">||</span> <span class="s2">""</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">id_value</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">primary_key</span><span class="p">]</span>

    <span class="n">sql_delete</span> <span class="o">=</span> <span class="o">&lt;&lt;~</span><span class="no">SQL</span><span class="p">.</span><span class="nf">strip</span><span class="sh">
      DELETE FROM fts_</span><span class="si">#{</span><span class="n">table_name</span><span class="si">}</span><span class="sh"> WHERE </span><span class="si">#{</span><span class="n">foreign_key</span><span class="si">}</span><span class="sh"> = </span><span class="si">#{</span><span class="n">id_value</span><span class="si">}</span><span class="sh">;
</span><span class="no">    SQL</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql_delete</span><span class="p">)</span>

    <span class="n">sql_insert</span> <span class="o">=</span> <span class="o">&lt;&lt;~</span><span class="no">SQL</span><span class="p">.</span><span class="nf">strip</span><span class="sh">
      INSERT INTO fts_</span><span class="si">#{</span><span class="n">table_name</span><span class="si">}</span><span class="sh">(</span><span class="si">#{</span><span class="n">search_attrs</span><span class="p">.</span><span class="nf">keys</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span><span class="si">}</span><span class="sh">, </span><span class="si">#{</span><span class="n">foreign_key</span><span class="si">}</span><span class="sh">)
      VALUES (</span><span class="si">#{</span><span class="n">search_attrs</span><span class="p">.</span><span class="nf">values</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span> <span class="s2">"'</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">'"</span> <span class="si">}</span><span class="sh">.join(", ")}, </span><span class="si">#{</span><span class="n">attributes</span><span class="p">[</span><span class="n">primary_key</span><span class="p">]</span><span class="si">}</span><span class="sh">);
</span><span class="no">    SQL</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql_insert</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span> <span class="k">def</span> <span class="nf">delete_search_index</span>
    <span class="n">primary_key</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">primary_key</span>
    <span class="n">table_name</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">table_name</span>
    <span class="n">foreign_key</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">foreign_key</span>
    <span class="n">id_value</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">primary_key</span><span class="p">]</span>

    <span class="n">sql_delete</span> <span class="o">=</span> <span class="o">&lt;&lt;~</span><span class="no">SQL</span><span class="p">.</span><span class="nf">strip</span><span class="sh">
      DELETE FROM fts_</span><span class="si">#{</span><span class="n">table_name</span><span class="si">}</span><span class="sh"> WHERE </span><span class="si">#{</span><span class="n">foreign_key</span><span class="si">}</span><span class="sh"> = </span><span class="si">#{</span><span class="n">id_value</span><span class="si">}</span><span class="sh">;
</span><span class="no">    SQL</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql_delete</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">after_save_commit</span> <span class="ss">:update_search_index</span>
    <span class="n">after_destroy_commit</span> <span class="ss">:delete_search_index</span>

    <span class="n">scope_foreign_key</span> <span class="o">=</span> <span class="nb">to_s</span><span class="p">.</span><span class="nf">foreign_key</span>
    <span class="n">scope</span> <span class="ss">:full_search</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">none</span> <span class="k">if</span> <span class="n">query</span><span class="p">.</span><span class="nf">blank?</span>

      <span class="n">sql</span> <span class="o">=</span> <span class="o">&lt;&lt;~</span><span class="no">SQL</span><span class="p">.</span><span class="nf">strip</span><span class="sh">
        SELECT </span><span class="si">#{</span><span class="n">scope_foreign_key</span><span class="si">}</span><span class="sh"> AS id FROM fts_</span><span class="si">#{</span><span class="n">table_name</span><span class="si">}</span><span class="sh">
        WHERE fts_</span><span class="si">#{</span><span class="n">table_name</span><span class="si">}</span><span class="sh"> = '</span><span class="si">#{</span><span class="n">query</span><span class="si">}</span><span class="sh">' ORDER BY rank;
</span><span class="no">      SQL</span>
      <span class="n">ids</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:values</span><span class="p">).</span><span class="nf">flatten</span>
      <span class="n">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">ids</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">class_methods</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">search_scope</span><span class="p">(</span><span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
      <span class="vc">@@search_scope_attrs</span> <span class="o">=</span> <span class="n">attrs</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">rebuild_search_index</span><span class="p">(</span><span class="o">*</span><span class="n">ids</span><span class="p">)</span>
      <span class="n">target_ids</span> <span class="o">=</span> <span class="no">Array</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
      <span class="n">target_ids</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">ids</span> <span class="k">if</span> <span class="n">target_ids</span><span class="p">.</span><span class="nf">empty?</span>

      <span class="n">scope_foreign_key</span> <span class="o">=</span> <span class="nb">to_s</span><span class="p">.</span><span class="nf">foreign_key</span>

      <span class="n">delete_where</span> <span class="o">=</span> <span class="no">Array</span><span class="p">(</span><span class="n">ids</span><span class="p">).</span><span class="nf">any?</span> <span class="p">?</span> <span class="s2">"WHERE </span><span class="si">#{</span><span class="n">scope_foreign_key</span><span class="si">}</span><span class="s2"> IN (</span><span class="si">#{</span><span class="n">ids</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span> <span class="p">:</span> <span class="s2">""</span>
      <span class="n">sql_delete</span> <span class="o">=</span> <span class="o">&lt;&lt;~</span><span class="no">SQL</span><span class="p">.</span><span class="nf">strip</span><span class="sh">
        DELETE FROM fts_</span><span class="si">#{</span><span class="n">table_name</span><span class="si">}</span><span class="sh"> </span><span class="si">#{</span><span class="n">delete_where</span><span class="si">}</span><span class="sh">;
</span><span class="no">      SQL</span>
      <span class="n">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql_delete</span><span class="p">)</span>

      <span class="n">target_ids</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">id</span><span class="o">|</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="ss">id: </span><span class="nb">id</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="o">*</span><span class="vc">@@search_scope_attrs</span><span class="p">,</span> <span class="ss">:id</span><span class="p">).</span><span class="nf">first</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="nf">present?</span>
          <span class="nb">id</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="nf">pop</span>

          <span class="n">sql_insert</span> <span class="o">=</span> <span class="o">&lt;&lt;~</span><span class="no">SQL</span><span class="p">.</span><span class="nf">strip</span><span class="sh">
            INSERT INTO fts_</span><span class="si">#{</span><span class="n">table_name</span><span class="si">}</span><span class="sh">(</span><span class="si">#{</span><span class="vc">@@search_scope_attrs</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span><span class="si">}</span><span class="sh">, </span><span class="si">#{</span><span class="n">scope_foreign_key</span><span class="si">}</span><span class="sh">)
            VALUES (</span><span class="si">#{</span><span class="n">record</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span> <span class="s2">"'</span><span class="si">#{</span><span class="n">quote_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">'"</span> <span class="si">}</span><span class="sh">.join(", ")}, </span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="sh">);
</span><span class="no">          SQL</span>
          <span class="n">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql_insert</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">quote_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="n">s</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span><span class="p">,</span> <span class="s1">'\&amp;\&amp;'</span><span class="p">).</span><span class="nf">gsub</span><span class="p">(</span><span class="s2">"'"</span><span class="p">,</span> <span class="s2">"''"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The class method <code class="highlighter-rouge">search_scope</code> tells the module the attributes we need to index. The <code class="highlighter-rouge">update_search_index</code> callback is called when the record is created or updated. Since SQLite, virtual tables don’t support upsert, which is a way to tell the database to insert a record if it doesn’t exist or to update it if it does. Also, the Rails SQLite adapter does not support multiple statements in a single execution call. </p>

<p>These limitations forced me to make two additional database calls: the first to delete the indexed data for a specific record, and the second to insert the new indexed data. It’s not very performant, but for a small database, it might be just fine.
The <code class="highlighter-rouge">delete_search_index</code> callback removes the indexed data when a record is deleted.</p>

<p>The module also implements a class method, <code class="highlighter-rouge">rebuild_search_index</code>, which optionally receives an array of record ids to re-index. If no ids are passed, then it rebuilds the index for all records.</p>

<p>Finally, a scope full_search is added to fetch records based on the full-text search index. You can use keywords like “AND”, “OR,” or “NOT” to refine your search or any other special character supported by SQLite FTS5.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Post</span><span class="p">.</span><span class="nf">full_search</span><span class="p">(</span><span class="s2">"Ruby OR Rails NOT Javascript"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>Adding this module to my applications allowed me to explore the idea of moving from PostgreSQL for these small applications. Not because PostgreSQL is bad, but because it might be too much for the current application’s needs.</p>

                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>


      <!-- Footer -->
<footer class="mt-32 flex-none">
  <div class="sm:px-8">
    <div class="mx-auto w-full max-w-7xl lg:px-8">
      <div class="border-t border-zinc-100 pb-16 pt-10 dark:border-zinc-700/40">
        <div class="relative px-4 sm:px-8 lg:px-12">
          <div class="mx-auto max-w-2xl lg:max-w-5xl">
            <div class="flex flex-col items-center justify-between gap-6 sm:flex-row">
              <div
                class="
                  flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800
                  dark:text-zinc-200
                "
              >
              
                <a
                    href="/about"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                About
                </a>
              
                <a
                    href="/articles"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                Articles
                </a>
              
                <a
                    href="/projects"
                  class="
                    transition hover:text-emerald-500
                    dark:hover:text-emerald-400
                  "
                >
                Projects
                </a>
              
              </div>

              <p class="text-sm text-zinc-400 dark:text-zinc-500">
              &copy; 2025 Mario Alberto Chávez. All rights reserved.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>
</html>
