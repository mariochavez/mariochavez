<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://bridgetownrb.com/" version="2.0.5">Bridgetown</generator><link href="https://mariochavez.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://mariochavez.io/" rel="alternate" type="text/html" /><updated>2025-11-25T16:36:23-06:00</updated><id>https://mariochavez.io/feed.xml</id><title type="html">Mario Alberto Chávez - Ruby on Rails, AI Tools &amp;amp; former CTO</title><subtitle>Ruby on Rails architect and AI toolmaker from Colima, México. Creator of Rails MCP Server, former fintech CTO, and author of Aprendiendo Ruby on Rails. Exploring the convergence of Rails and AI.</subtitle><author><name>Mario Alberto Chávez</name></author><entry xml:lang="en_US"><title type="html">Vibecoding the Physical: How AI Helped Me Bind My Photobook</title><link href="https://mariochavez.io/desarrollo/2025/11/22/vibecoding-the-physical-how-ai-helped-me-bind-my-photobook/" rel="alternate" type="text/html" title="Vibecoding the Physical: How AI Helped Me Bind My Photobook" /><published>2025-11-22T00:00:00-06:00</published><updated>2025-11-22T00:00:00-06:00</updated><id>repo://posts.collection/_posts/2025-11-22-vibecoding-the-physical-how-ai-helped-me-bind-my-photobook.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2025/11/22/vibecoding-the-physical-how-ai-helped-me-bind-my-photobook/">&lt;p&gt;Sometimes, I reach for Claude Desktop just to “vibecode.” I start with a spark—a very simple idea—and I iterate, building complexity layer by layer. Usually, I don’t even specify the tech stack. By default, Sonnet tends to choose React.&lt;/p&gt;

&lt;p&gt;Here’s the catch: my knowledge of React is basic. I can’t strictly tell if the code is idiomatic or “correct.” I can only treat the app as a black box—testing it to see if it works as expected. I leave the architectural decisions to the model and focus purely on the outcome.&lt;/p&gt;

&lt;p&gt;But this time, the outcome was personal.&lt;/p&gt;

&lt;h2 id=&quot;the-artists-need&quot;&gt;The Artist’s Need&lt;/h2&gt;

&lt;p&gt;Besides being a Software Engineer, I am a Visual Artist and contemporary photographer. Since 2022, I’ve been working on a long-term project that is finally becoming my first photobook.&lt;/p&gt;

&lt;p&gt;Recently, my book editor and designer sent me a draft PDF. It looked great on screen, but a photobook is a physical object. I needed to “feel” the book before giving feedback. Electronic documents don’t have weight; they don’t have page turns.&lt;/p&gt;

&lt;p&gt;I have the knowledge to print at home on a consumer printer. I also know the process required to take a linear PDF and rearrange the pages into “signatures” (groups of folded sheets) for traditional binding. But doing this manually is tedious and error-prone. One calculation mistake, one wrong paper flip, and the page order is ruined.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/vibecoding-photobook/claude-1.png&quot; alt=&quot;Image: Understanding Signature Binding documentation section&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;the-ai-solution&quot;&gt;The AI Solution&lt;/h2&gt;

&lt;p&gt;I needed a tool, not a math lesson. I opened Claude and pitched the idea: a &lt;strong&gt;“Photobook Signature and Printing Layout Calculator.”&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/vibecoding-photobook/claude-2.png&quot; alt=&quot;Image: Signatures visualization&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I wanted to upload my PDF and have the tool calculate:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;How many signatures do I need for binding?&lt;/li&gt;
  &lt;li&gt;How to rearrange (impose) the pages for printing?&lt;/li&gt;
  &lt;li&gt;How to optimize paper usage based on my printer’s specific paper size?&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;After about 10 iterations, Sonnet nailed it. It built a fully client-side React application. It visualizes the grid, handles the imposition math, and even generates a visual guide for printing.&lt;/p&gt;

&lt;p&gt;Because I was “vibecoding,” I didn’t stop at the code. I asked Claude to generate a comprehensive user manual for me (the Photographer) and a technical architecture document for “Future Me” (the Developer).&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/vibecoding-photobook/claude-3.png&quot; alt=&quot;Image: Printing layout&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;the-engineers-return&quot;&gt;The Engineer’s Return&lt;/h2&gt;

&lt;p&gt;This is where the process gets interesting. The React app worked, but as an engineer, I felt a bit detached from the “how.” I wanted to ground the project in a stack I actually mastered.&lt;/p&gt;

&lt;p&gt;So, I asked for a &lt;strong&gt;Spike&lt;/strong&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;“Can you make a spike and convert this application to Rails? Don’t worry about the full application; assume that it is there and you are only creating the needed files… Think harder about what can be pushed to the backend with ActiveStorage, and what needs to happen in the front end with ERB, Tailwind, Hotwire, and Stimulus.”&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The vibe shifted. Sonnet didn’t get the Rails architecture perfect on the first try, but because I know Rails deeply, I could spot the flaws immediately. I knew where the N+1 queries would hide, how to better utilize ActiveStorage, or where a specific Gem would be more efficient than custom logic.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/vibecoding-photobook/claude-5.png&quot; alt=&quot;Image: The Ruby on Rails spike&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;the-takeaway&quot;&gt;The Takeaway&lt;/h2&gt;

&lt;p&gt;I have found this to be a powerful workflow for testing ideas:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;strong&gt;Vibecode in the unknown:&lt;/strong&gt; Let AI build the prototype in a stack it prefers (like React). Focus purely on the user experience and solving the pain point.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Spike into the known:&lt;/strong&gt; Once the logic is proven, ask AI to port it to my core stack (Rails).&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Refine with expertise:&lt;/strong&gt; Use my engineering seniority to polish the code that I now fully understand.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The result? I have a tool that solves my artistic problem, and it saved me from the manual process to get the layout right. Now, I can go back to my book editing software and rearrange pages to the suggested layout, then finally print my draft book.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/vibecoding-photobook/vibecoding.jpg" /><media:content medium="image" url="https://mariochavez.io/images/vibecoding-photobook/vibecoding.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en_US"><title type="html">Upgrading Rails applications with an AI skill</title><link href="https://mariochavez.io/desarrollo/2025/11/12/upgrading-rails-ai-skill/" rel="alternate" type="text/html" title="Upgrading Rails applications with an AI skill" /><published>2025-11-12T00:00:00-06:00</published><updated>2025-11-12T00:00:00-06:00</updated><id>repo://posts.collection/_posts/2025-11-12-upgrading-rails-ai-skill.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2025/11/12/upgrading-rails-ai-skill/">&lt;p&gt;What if you could use an AI skill to handle the most tedious, error-prone parts of a Ruby on Rails upgrade? As someone who’s been in the Rails trenches since 2008, I’ve spent countless hours on this exact task.&lt;/p&gt;

&lt;p&gt;In my time as a founder, contractor, and company owner, I’ve upgraded applications from nearly every era. The early days of 2.x, 3.x, and 4.x were battles against breaking API changes, specific and complex monkey patches, and gems that were abandoned over time.&lt;/p&gt;

&lt;p&gt;Things got better after Rails 5.2, but one command still triggers a familiar headache: &lt;code class=&quot;highlighter-rouge&quot;&gt;rails app:update&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The real challenge isn’t the command itself. It’s the high-stakes, manual process that follows: &lt;strong&gt;meticulously merging your application’s custom configurations&lt;/strong&gt; with the framework’s new defaults. Even with great tools like &lt;a href=&quot;https://railsdiff.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;RailsDiff&lt;/a&gt;, it’s a slow, manual process where a single mistake can cause subtle, cascading bugs.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;the-spark-of-an-idea&quot;&gt;The Spark of an Idea&lt;/h3&gt;

&lt;p&gt;I’ve been thinking about how to improve this process for a while. When Anthropic first announced the Model Context Protocol (MCP), I saw a post on X (formerly Twitter) asking if AI could finally solve this exact config-merging nightmare. The idea struck a chord, but I was swamped with work.&lt;/p&gt;

&lt;p&gt;A few weeks ago, that idea resurfaced. A client’s application on Rails 7.1 was approaching its end-of-life (EOL) date, and I was staring down another upgrade. But this time, something was different: Anthropic had just launched &lt;strong&gt;Skills&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;As I was planning the upgrade, I was open to considering if one of these new &lt;strong&gt;Skills&lt;/strong&gt; could be the solution. I realized a “skill” wasn’t just a general-purpose AI; it was a specialized, tool-driven capability. Could this be the key to &lt;em&gt;finally&lt;/em&gt; automating the most painful part of a Rails upgrade?&lt;/p&gt;

&lt;p&gt;I had to find out.&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;introducing-the-rails-upgrade-skill&quot;&gt;Introducing the &lt;code class=&quot;highlighter-rouge&quot;&gt;rails-upgrade-skill&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;The result of that experiment is the &lt;strong&gt;Rails Upgrade Assistant Skill&lt;/strong&gt; (or &lt;code class=&quot;highlighter-rouge&quot;&gt;rails-upgrade-skill&lt;/code&gt; in its repository). This is a specialized &lt;strong&gt;AI skill&lt;/strong&gt; that uses Claude’s intelligence to guide the entire upgrade process.&lt;/p&gt;

&lt;p&gt;It’s built using official Rails CHANGELOGs to intelligently plan your upgrade path for any version from &lt;strong&gt;Rails 7.0 through 8.1.1&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;What makes this skill an &lt;em&gt;intelligent&lt;/em&gt; upgrade assistant?&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Intelligent Analysis:&lt;/strong&gt; It calls the Rails MCP Server to read &lt;strong&gt;your actual project files&lt;/strong&gt;, understand &lt;strong&gt;your customizations&lt;/strong&gt;, and provide personalized guidance—not generic advice.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Custom Code Preservation:&lt;/strong&gt; It automatically detects custom configurations and provides specific warnings (e.g., about custom SSL middleware or autoload paths) with clear instructions on how to migrate them safely, ensuring your code logic isn’t lost.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Sequential Enforcement:&lt;/strong&gt; It prevents the dangerous practice of skipping versions. If you ask for a multi-hop upgrade (e.g., 7.0 to 8.1), it automatically plans the correct sequential path (7.0 → 7.1 → 7.2 → 8.0 → 8.1) and guides you through each hop separately.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;make-it-your-own&quot;&gt;Make It Your Own&lt;/h3&gt;

&lt;p&gt;This skill is currently &lt;strong&gt;opinionated and tightly coupled to my personal workflow&lt;/strong&gt;. It’s built to work with two other tools I’ve made:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/maquina-app/rails-mcp-server&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;Rails MCP Server&lt;/a&gt;: Used to gather deep information about your Rails application (like version, file contents, routes).
    &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/maquina-app/nvim-mcp-server&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;Neovim MCP Server&lt;/a&gt;: Used to allow Claude to apply the identified changes directly to your files in Neovim (the &lt;strong&gt;Interactive Mode&lt;/strong&gt;).
    &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;But this is the beauty of Skills. You don’t have to use my stack. I invite you to &lt;strong&gt;fork the repo&lt;/strong&gt; and edit the &lt;code class=&quot;highlighter-rouge&quot;&gt;SKILL.md&lt;/code&gt; file. You can instruct the skill on how &lt;em&gt;you&lt;/em&gt; want it to get project information or apply changes, tailoring it to your own editor and workflow.&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;how-to-use-the-skill-a-step-by-step-guide&quot;&gt;How to Use the Skill: A Step-by-Step Guide&lt;/h2&gt;

&lt;p&gt;Here’s how it works in my setup.&lt;/p&gt;

&lt;h3 id=&quot;1-installation&quot;&gt;1. Installation&lt;/h3&gt;

&lt;p&gt;First, clone the repository and run the build script:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; git clone &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;https://github.com/maquina-app/rails-upgrade-skill.git]&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;https://github.com/maquina-app/rails-upgrade-skill.git&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;rails-upgrade-skill
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; bin/build
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This command zips the skill into a &lt;code class=&quot;highlighter-rouge&quot;&gt;/build&lt;/code&gt; folder. Next, open your Claude Desktop app, go to &lt;strong&gt;Settings &amp;gt; Capabilities&lt;/strong&gt;, and scroll down to &lt;strong&gt;Skills&lt;/strong&gt;. You can upload the &lt;code class=&quot;highlighter-rouge&quot;&gt;build/rails-upgrade-skill.zip&lt;/code&gt; file there.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rails-upgrade-skill/claude-settings.png&quot; alt=&quot;Install the skill&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;2-set-your-project-context&quot;&gt;2. Set Your Project Context&lt;/h3&gt;

&lt;p&gt;In a new chat, you need to tell Claude which project you’re working on. If you’re using my Rails MCP Server, the command is:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Switch to my_app project and show me the project information&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This activates your Rails application’s context and allows the skill to gather its details.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rails-upgrade-skill/rails-app-information.png&quot; alt=&quot;Switch to your application context&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;3-activate-the-upgrade-skill&quot;&gt;3. Activate the Upgrade Skill&lt;/h3&gt;

&lt;p&gt;Once the context is set, you can invoke the AI skill with a simple prompt:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Help me upgrade my Rails application to next available version&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The skill takes over and kicks off a three-step process, which can be done in two modes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Mode 1 (Report-Only):&lt;/strong&gt; Claude provides the comprehensive report, and you apply changes manually. This is recommended for your first time.&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;&lt;strong&gt;Mode 2 (Interactive):&lt;/strong&gt; Claude guides you and offers to apply changes directly to your open files in Neovim.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/images/rails-upgrade-skill/generate-breaking-changes-script.png&quot; alt=&quot;Activate the skill&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;4-the-three-phase-process&quot;&gt;4. The Three-Phase Process&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;Step 1: Detect Deprecations&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;The skill generates a bash script for you. You copy and run this script in your application’s root directory. It scans your application for deprecation patterns and breaking changes, saving findings to a .txt file, which you then paste back into Claude.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rails-upgrade-skill/run-the-script.png&quot; alt=&quot;Run the script&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Step 2: Generate a Comprehensive Report&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;This is the core value. Using the project analysis and the deprecation findings, the skill generates a detailed report. It breaks down changes by priority (HIGH, MEDIUM, LOW) and component (ActiveRecord, ActionMailer, etc.).&lt;/p&gt;

&lt;p&gt;Crucially, it &lt;strong&gt;intelligently merges the new Rails defaults with your existing custom settings&lt;/strong&gt; and provides &lt;strong&gt;OLD vs. NEW code examples&lt;/strong&gt; with explanation.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rails-upgrade-skill/the-report.png&quot; alt=&quot;The comprehensive report&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Step 3: Apply the Changes (The app:update Report)&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;The final report summarizes all files needing changes. If you are using the Interactive Mode with the Neovim MCP server, you can review the proposed changes and then tell Claude:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;All files are ready on nvim buffers, update them all&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Claude will then apply all the approved changes directly to your open files.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/rails-upgrade-skill/the-app-update-report.png&quot; alt=&quot;The app:update report&quot; /&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;the-final-mile-after-the-skill&quot;&gt;The Final Mile: After the Skill&lt;/h2&gt;

&lt;p&gt;This AI skill handles the most complex parts of the upgrade, getting you 90% of the way there. You still need to follow the standard Rails procedure:&lt;/p&gt;

&lt;p&gt;First, update your gems:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; bundle update
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Next, run the &lt;code class=&quot;highlighter-rouge&quot;&gt;rails app:update&lt;/code&gt; command. Run it with &lt;strong&gt;confidence&lt;/strong&gt;. When the command flags conflicts in config files, you can usually &lt;strong&gt;skip&lt;/strong&gt; overwriting them, knowing the logic has already been intelligently merged by the skill. You then let the command proceed to create &lt;em&gt;new&lt;/em&gt; files, like initializers and migrations.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; rails app:update
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the last, most crucial step: &lt;strong&gt;run your test suite&lt;/strong&gt; and test the application manually.&lt;/p&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;final-thoughts&quot;&gt;Final Thoughts&lt;/h2&gt;

&lt;p&gt;I’ve already used this skill to upgrade a client application and several of my own projects, turning hours of tedious work into a process that takes just a few minutes of interaction time.&lt;/p&gt;

&lt;p&gt;This, for me, represents the true power of AI in development: combining deep, specialized domain knowledge (the nuances of a Rails upgrade) with new tools like Anthropic Skills.&lt;/p&gt;

&lt;p&gt;Please, &lt;strong&gt;give the &lt;a href=&quot;https://github.com/maquina-app/rails-upgrade-skill&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;rails-upgrade-skill&lt;/a&gt; a try&lt;/strong&gt;. Fork it, adapt it to your own workflow, and let me know what you think.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/rails-upgrade-skill/upgrade-rails-ia-skill.jpg" /><media:content medium="image" url="https://mariochavez.io/images/rails-upgrade-skill/upgrade-rails-ia-skill.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Rails MCP Server: Enhanced Documentation Access</title><link href="https://mariochavez.io/desarrollo/rails/ai-tools/development-workflow/2025/06/03/rails-mcp-server-enhanced-documentation-access/" rel="alternate" type="text/html" title="Rails MCP Server: Enhanced Documentation Access" /><published>2025-06-03T00:00:00-06:00</published><updated>2025-06-03T00:00:00-06:00</updated><id>repo://posts.collection/_posts/2025-06-03-rails-mcp-server-enhanced-documentation-access.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/rails/ai-tools/development-workflow/2025/06/03/rails-mcp-server-enhanced-documentation-access/">&lt;h2 id=&quot;rails-mcp-server-enhanced-documentation-access-and-ai-workflow-integration&quot;&gt;Rails MCP Server: Enhanced Documentation Access and AI Workflow Integration&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;Updated Rails MCP Server now provides consistent, up-to-date Rails documentation across multiple LLM clients with enhanced proxy support and Neovim integration.&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;table-of-contents&quot;&gt;Table of Contents&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;#comprehensive-documentation-resources&quot;&gt;Comprehensive Documentation Resources&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#the-documentation-challenge&quot;&gt;The Documentation Challenge&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#five-resource-categories-available&quot;&gt;Five Resource Categories Available&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#setting-up-documentation-resources&quot;&gt;Setting Up Documentation Resources&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#mcp-proxy-integration-for-better-compatibility&quot;&gt;MCP Proxy Integration for Better Compatibility&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#rails-mcp--neovim-mcp-integration-workflow&quot;&gt;Rails MCP + Neovim MCP Integration Workflow&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#documentation-as-a-shared-resource&quot;&gt;Documentation as a Shared Resource&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#resource-management-and-best-practices&quot;&gt;Resource Management and Best Practices&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#faq&quot;&gt;FAQ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;p&gt;The latest updates to &lt;strong&gt;Rails MCP Server&lt;/strong&gt; introduce significant improvements to documentation access, better integration capabilities, and enhanced workflow support that have transformed how I work with Rails projects using AI assistance.&lt;/p&gt;

&lt;h2 id=&quot;comprehensive-documentation-resources&quot;&gt;Comprehensive Documentation Resources&lt;/h2&gt;

&lt;p&gt;The most significant addition in this release is the comprehensive &lt;strong&gt;Resources and Documentation system&lt;/strong&gt;. This addresses a critical need in AI-assisted development: providing LLM clients with consistent, up-to-date documentation that can be shared across multiple AI sessions and different LLM providers.&lt;/p&gt;

&lt;h3 id=&quot;the-documentation-challenge&quot;&gt;The Documentation Challenge&lt;/h3&gt;

&lt;p&gt;When working with AI assistants on Rails projects, I frequently encountered situations where the LLM’s training data was outdated or incomplete regarding specific framework features. This led to suggestions based on deprecated APIs or missing newer functionality. The resource system solves this by:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Ensuring accuracy&lt;/strong&gt;: LLMs receive the exact same official documentation that developers reference&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Maintaining consistency&lt;/strong&gt;: Multiple AI sessions can access identical documentation, ensuring consistent guidance&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Staying current&lt;/strong&gt;: Documentation can be updated to match specific Rails versions or framework releases&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Sharing context&lt;/strong&gt;: The same documentation resources work across different LLM clients and providers&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;five-resource-categories-available&quot;&gt;Five Resource Categories Available&lt;/h3&gt;

&lt;p&gt;The server now provides access to five complete documentation libraries:&lt;/p&gt;

&lt;h4 id=&quot;1-rails-guides-documentation&quot;&gt;1. Rails Guides Documentation&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Content&lt;/strong&gt;: Official Ruby on Rails 8.0.2 documentation - all 50+ guides&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Coverage&lt;/strong&gt;: Getting started to advanced topics including Active Record, Action Pack, security, and deployment&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Use case&lt;/strong&gt;: Comprehensive Rails framework reference&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;2-turbo-framework-documentation&quot;&gt;2. Turbo Framework Documentation&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Content&lt;/strong&gt;: Complete Hotwire Turbo framework documentation&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Structure&lt;/strong&gt;: Handbook and reference sections covering Turbo Drive, Frames, and Streams&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Use case&lt;/strong&gt;: Modern Rails frontend development with Hotwire&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;3-stimulus-javascript-framework-documentation&quot;&gt;3. Stimulus JavaScript Framework Documentation&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Content&lt;/strong&gt;: Full Stimulus documentation for building interactive components&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Structure&lt;/strong&gt;: Handbook tutorials and API reference&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Use case&lt;/strong&gt;: JavaScript interactions in Rails applications&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;4-kamal-deployment-documentation&quot;&gt;4. Kamal Deployment Documentation&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Content&lt;/strong&gt;: Comprehensive Kamal deployment tool documentation&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Coverage&lt;/strong&gt;: Installation, configuration, commands, and deployment strategies&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Use case&lt;/strong&gt;: Modern Rails application deployment&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;5-custom-documentation-resources&quot;&gt;5. Custom Documentation Resources&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Content&lt;/strong&gt;: Import and access your own markdown documentation files&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Flexibility&lt;/strong&gt;: Project-specific guides, API documentation, team standards&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Use case&lt;/strong&gt;: Maintaining consistent project documentation across AI sessions&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;setting-up-documentation-resources&quot;&gt;Setting Up Documentation Resources&lt;/h2&gt;

&lt;p&gt;Setting up documentation is straightforward with the dedicated download tool:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Download official framework documentation&lt;/span&gt;
rails-mcp-server-download-resources rails
rails-mcp-server-download-resources turbo
rails-mcp-server-download-resources stimulus
rails-mcp-server-download-resources kamal

&lt;span class=&quot;c&quot;&gt;# Import your custom documentation&lt;/span&gt;
rails-mcp-server-download-resources &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; /path/to/your/docs/

&lt;span class=&quot;c&quot;&gt;# Force update existing resources&lt;/span&gt;
rails-mcp-server-download-resources &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt; rails

&lt;span class=&quot;c&quot;&gt;# Verbose output for troubleshooting&lt;/span&gt;
rails-mcp-server-download-resources &lt;span class=&quot;nt&quot;&gt;--verbose&lt;/span&gt; turbo
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once downloaded, you can access guides naturally in conversation:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Can you load the Rails getting started guide?
Show me the Turbo Frames documentation.
I need help with Stimulus controllers - can you show me that guide?
Load the Kamal deployment guide so I can understand the process.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;mcp-proxy-integration-for-better-compatibility&quot;&gt;MCP Proxy Integration for Better Compatibility&lt;/h2&gt;

&lt;p&gt;Building on the &lt;a href=&quot;https://mariochavez.io/desarrollo/2025/04/20/rails-mcp-server-with-sse/&quot;&gt;previous release with HTTP SSE support&lt;/a&gt;, this update includes comprehensive documentation for using &lt;strong&gt;MCP proxies&lt;/strong&gt; to address Ruby version manager compatibility issues that many developers face with Claude Desktop.&lt;/p&gt;

&lt;h3 id=&quot;setting-up-mcp-proxy-for-enhanced-compatibility&quot;&gt;Setting Up MCP Proxy for Enhanced Compatibility&lt;/h3&gt;

&lt;p&gt;For users who want to leverage the HTTP/SSE capabilities or work around Ruby version manager issues:&lt;/p&gt;

&lt;h4 id=&quot;step-1-start-rails-mcp-server-in-http-mode&quot;&gt;Step 1: Start Rails MCP Server in HTTP Mode&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rails-mcp-server &lt;span class=&quot;nt&quot;&gt;--mode&lt;/span&gt; http
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;step-2-install-and-configure-mcp-proxy&quot;&gt;Step 2: Install and Configure MCP Proxy&lt;/h4&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Install the Node.js based MCP proxy&lt;/span&gt;
npm &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; mcp-remote

&lt;span class=&quot;c&quot;&gt;# Run the proxy, pointing to your running Rails MCP Server&lt;/span&gt;
npx mcp-remote http://localhost:6029/mcp/sse
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;step-3-configure-claude-desktop-for-proxy-usage&quot;&gt;Step 3: Configure Claude Desktop for Proxy Usage&lt;/h4&gt;

&lt;div class=&quot;language-json highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;mcpServers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;railsMcpServer&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;command&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;npx&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
      &lt;/span&gt;&lt;span class=&quot;nl&quot;&gt;&quot;args&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;mcp-remote&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;http://localhost:6029/mcp/sse&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
    &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
  &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This setup allows STDIO-only clients to communicate through the proxy while benefiting from HTTP/SSE capabilities and avoiding Ruby version conflicts.&lt;/p&gt;

&lt;h2 id=&quot;rails-mcp--neovim-mcp-integration-workflow&quot;&gt;Rails MCP + Neovim MCP Integration Workflow&lt;/h2&gt;

&lt;p&gt;I’ve significantly improved my development workflow by combining the Rails MCP Server with the &lt;a href=&quot;https://github.com/maquina-app/nvim-mcp-server&quot;&gt;&lt;strong&gt;Neovim MCP Server&lt;/strong&gt;&lt;/a&gt;. This combination creates a powerful development environment where I can seamlessly work with both my Rails codebase and my active editing context.&lt;/p&gt;

&lt;h3 id=&quot;the-two-server-development-approach&quot;&gt;The Two-Server Development Approach&lt;/h3&gt;

&lt;p&gt;Here’s how I use both MCP servers together for enhanced productivity:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Rails MCP Server handles:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Project structure analysis and exploration&lt;/li&gt;
  &lt;li&gt;Database schema exploration and relationships&lt;/li&gt;
  &lt;li&gt;Route inspection and API endpoint analysis&lt;/li&gt;
  &lt;li&gt;Model relationship analysis and validations&lt;/li&gt;
  &lt;li&gt;Access to comprehensive Rails ecosystem documentation&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;Neovim MCP Server provides:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Real-time access to currently open buffers&lt;/li&gt;
  &lt;li&gt;Context about active editing sessions&lt;/li&gt;
  &lt;li&gt;Bridge between editor state and AI assistance&lt;/li&gt;
  &lt;li&gt;Live file content without manual specification&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;optimized-development-session-workflow&quot;&gt;Optimized Development Session Workflow&lt;/h3&gt;

&lt;p&gt;When I start a development session, I begin with context gathering:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Switch to project my_rails_app, don&apos;t analyze anything yet.
Show me which files I have open in my &quot;my_rails_app&quot; Neovim instance.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This gives me both project context from Rails MCP and my current editing context from Neovim MCP. Then I can work more efficiently:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Load the User model from Rails and also get the user_controller.rb that I have open in Neovim.
Can you also load the Rails Active Record associations guide for reference?
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;benefits-of-the-dual-server-approach&quot;&gt;Benefits of the Dual-Server Approach&lt;/h3&gt;

&lt;p&gt;This approach allows me to:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Work with live context&lt;/strong&gt;: See exactly what I’m editing without manually specifying files&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Access comprehensive documentation&lt;/strong&gt;: Get official guides loaded instantly for reference&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Maintain project focus&lt;/strong&gt;: Switch between Rails projects while keeping editor context&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Avoid manual file management&lt;/strong&gt;: Let the tools handle finding and loading the right files&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;managing-token-usage-effectively&quot;&gt;Managing Token Usage Effectively&lt;/h3&gt;

&lt;p&gt;I’ve refined my prompting strategy to manage Claude’s context window more effectively:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Session Start:&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Switch to project my_finances, don&apos;t analyze the project or any loaded files until you are told to.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Loading Files:&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Load the following files from my Neovim buffers, do not analyze or try to load dependencies unless you are told to.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;Session Continuation:&lt;/strong&gt;
When reaching conversation limits, I summarize and continue:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Summarize this chat. Describe the goal and add relevant information about what was done. Include the project name and list any files loaded, generated or shared.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;documentation-as-a-shared-resource&quot;&gt;Documentation as a Shared Resource&lt;/h2&gt;

&lt;p&gt;The resource system transforms documentation from a static reference into a dynamic, shared asset. When I load Rails validation documentation in one conversation, another AI session can access the same exact information. This consistency is particularly valuable when:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Training team members&lt;/strong&gt;: Everyone gets the same documentation regardless of which AI tool they use&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Maintaining project standards&lt;/strong&gt;: Documentation stays consistent across different development sessions&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Working with multiple LLM providers&lt;/strong&gt;: The same Rails 8.0.2 guides work identically with Claude, ChatGPT, or other MCP-compatible clients&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Ensuring version alignment&lt;/strong&gt;: Projects can specify exact documentation versions to match their Rails installation&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Instead of switching to browser tabs or searching through docs, I can load exactly the guide I need:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;I&apos;m working on validations - can you load the Rails validations guide?
Show me the Turbo Streams reference for this real-time update feature.
Load my custom API documentation so we can follow the established patterns.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The system handles both official framework documentation and custom project documentation seamlessly, making it a true companion for Rails development.&lt;/p&gt;

&lt;h2 id=&quot;resource-management-and-best-practices&quot;&gt;Resource Management and Best Practices&lt;/h2&gt;

&lt;p&gt;Managing resources is straightforward with clear commands and automatic organization:&lt;/p&gt;

&lt;h3 id=&quot;resource-organization-best-practices&quot;&gt;Resource Organization Best Practices&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Download once, use everywhere&lt;/strong&gt;: Resources are stored locally and available across all conversations&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Automatic updates&lt;/strong&gt;: Re-download to get the latest documentation versions&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Custom integration&lt;/strong&gt;: Import your project-specific documentation alongside official guides&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Intelligent organization&lt;/strong&gt;: Resources are categorized and easily discoverable&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;resource-storage-and-management&quot;&gt;Resource Storage and Management&lt;/h3&gt;

&lt;p&gt;Resources are stored in platform-specific locations:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;macOS&lt;/strong&gt;: &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.config/rails-mcp/resources/&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Windows&lt;/strong&gt;: &lt;code class=&quot;highlighter-rouge&quot;&gt;%APPDATA%\rails-mcp\resources\&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Each resource category maintains a manifest file tracking downloaded guides, versions, and update timestamps.&lt;/p&gt;

&lt;h3 id=&quot;performance-optimization-tips&quot;&gt;Performance Optimization Tips&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;strong&gt;Selective downloads&lt;/strong&gt;: Only download resources you actively use&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Regular updates&lt;/strong&gt;: Keep documentation current with framework releases&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Custom documentation&lt;/strong&gt;: Organize project-specific guides with descriptive filenames&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Version alignment&lt;/strong&gt;: Match documentation versions to your Rails installation&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;For complete details on setting up and using resources, I’ve created a comprehensive &lt;a href=&quot;docs/RESOURCES.md&quot;&gt;Resources Guide&lt;/a&gt; that covers everything from basic setup to advanced usage patterns.&lt;/p&gt;

&lt;h2 id=&quot;faq&quot;&gt;FAQ&lt;/h2&gt;

&lt;h3 id=&quot;how-do-i-update-rails-mcp-server-documentation-resources&quot;&gt;How do I update Rails MCP Server documentation resources?&lt;/h3&gt;

&lt;p&gt;Re-run the download command for any resource category to get the latest version:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rails-mcp-server-download-resources rails
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;can-i-use-rails-mcp-server-with-other-ai-clients-besides-claude-desktop&quot;&gt;Can I use Rails MCP Server with other AI clients besides Claude Desktop?&lt;/h3&gt;

&lt;p&gt;Yes! The MCP proxy setup allows compatibility with any MCP-compatible client. The HTTP/SSE endpoints work with various LLM providers.&lt;/p&gt;

&lt;h3 id=&quot;whats-the-difference-between-rails-mcp-server-and-neovim-mcp-server&quot;&gt;What’s the difference between Rails MCP Server and Neovim MCP Server?&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Rails MCP Server&lt;/strong&gt;: Analyzes Rails project structure, database, routes, and provides Rails ecosystem documentation&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Neovim MCP Server&lt;/strong&gt;: Provides access to currently open files in your editor sessions&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;how-do-i-troubleshoot-ruby-version-manager-issues-with-claude-desktop&quot;&gt;How do I troubleshoot Ruby version manager issues with Claude Desktop?&lt;/h3&gt;

&lt;p&gt;Use the MCP proxy setup to bypass Ruby version conflicts, or create a symbolic link as described in the &lt;a href=&quot;https://github.com/maquina-app/rails-mcp-server#ruby-version-manager-users&quot;&gt;Ruby Version Manager Users section&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;can-i-import-custom-documentation-alongside-official-rails-guides&quot;&gt;Can I import custom documentation alongside official Rails guides?&lt;/h3&gt;

&lt;p&gt;Yes! Use the &lt;code class=&quot;highlighter-rouge&quot;&gt;--file&lt;/code&gt; option to import your own markdown files:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rails-mcp-server-download-resources &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; /path/to/your/docs/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;hr /&gt;

&lt;h2 id=&quot;looking-forward&quot;&gt;Looking Forward&lt;/h2&gt;

&lt;p&gt;This enhanced Rails MCP Server has become an integral part of my Rails development workflow. The combination of comprehensive documentation access, improved integration options, and seamless editor integration through the Neovim MCP Server creates a development environment where AI assistance feels natural and productive.&lt;/p&gt;

&lt;p&gt;The ability to instantly access official documentation, work with live editing context, and maintain project focus has significantly improved my development velocity and the quality of my AI-assisted coding sessions.&lt;/p&gt;

&lt;p&gt;I encourage you to try both servers together and explore the new resource system. The documentation access alone makes this upgrade worthwhile, and the improved integration options ensure it works well regardless of your development setup.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Source code and detailed setup instructions:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/maquina-app/rails-mcp-server&quot;&gt;Rails MCP Server&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/maquina-app/nvim-mcp-server&quot;&gt;Neovim MCP Server&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;related-posts&quot;&gt;Related Posts&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://mariochavez.io/desarrollo/2025/04/20/rails-mcp-server-with-sse/&quot;&gt;Rails MCP Server with HTTP Server-Sent Events support&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://mariochavez.io/desarrollo/2024/12/15/model-context-protocol-development/&quot;&gt;Model Context Protocol: Enhancing AI Development Workflows&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;p&gt;&lt;em&gt;The Rails MCP Server continues to evolve based on real-world usage. If you have suggestions or encounter issues, please feel free to open an issue or contribute to the project.&lt;/em&gt;&lt;/p&gt;</content><author><name>Mario Alberto Chávez Cárdenas</name></author><category term="Rails MCP Server" /><category term="Model Context Protocol" /><category term="Rails Documentation" /><category term="AI Development" /><category term="LLM Integration" /><category term="Ruby on Rails" /><category term="MCP Proxy" /><category term="Neovim" /><category term="Claude Desktop" /><summary type="html">Discover how Rails MCP Server provides consistent Rails documentation across multiple LLM clients, with MCP proxy support and Neovim integration for enhanced AI-assisted development.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/rails-mcp-1.2.0.jpg" /><media:content medium="image" url="https://mariochavez.io/images/rails-mcp-1.2.0.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en_US"><title type="html">Rails MCP Server with HTTP Server-Sent Events support</title><link href="https://mariochavez.io/desarrollo/2025/04/20/rails-mcp-server-with-sse/" rel="alternate" type="text/html" title="Rails MCP Server with HTTP Server-Sent Events support" /><published>2025-04-20T00:00:00-06:00</published><updated>2025-04-20T00:00:00-06:00</updated><id>repo://posts.collection/_posts/2025-04-20-rails-mcp-server-with-sse.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2025/04/20/rails-mcp-server-with-sse/">&lt;h1 id=&quot;rails-mcp-server-110-with-http-sse-support&quot;&gt;Rails MCP Server 1.1.0 with HTTP SSE support&lt;/h1&gt;

&lt;p&gt;I’m excited to announce this new version of Rails MCP Server, version 1.1.0! This release introduces significant internal refactoring through the integration of the &lt;a href=&quot;https://github.com/jlowin/fastmcp&quot;&gt;FastMCP gem&lt;/a&gt;, providing better code organization and adding support for HTTP Server-Sent Events (SSE).&lt;/p&gt;

&lt;h2 id=&quot;whats-new-in-v110&quot;&gt;What’s New in v1.1.0&lt;/h2&gt;

&lt;h3 id=&quot;fastmcp-integration&quot;&gt;FastMCP Integration&lt;/h3&gt;

&lt;p&gt;The most substantial change in this release is the internal refactoring to use the FastMCP gem. This refactoring has provided several benefits:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Improved Code Organization&lt;/strong&gt;: I’ve made the codebase more modular and easier to maintain&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Improved tools&lt;/strong&gt;: I’ve reviewed the code for each tool to fix issues with edge cases and to make the tools honor &lt;code class=&quot;highlighter-rouge&quot;&gt;.gitignore&lt;/code&gt; file when scanning the codebase for files. This is important for large codebases.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Added two new tools&lt;/strong&gt;: There are two new tools, analyze controller and views and analyze environment configuration. Analyze controllers and views finds all the relationships with the routes, views, stimulus controllers and controller actions in detail. Analyze environment configuration compares the configuration for inconsistencies between environments, missing configuration, and possible security issues, &lt;em&gt;it does not leak keys or passwords to the LLM&lt;/em&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;http-server-sent-events-sse-support&quot;&gt;HTTP Server-Sent Events (SSE) Support&lt;/h3&gt;

&lt;p&gt;With this release, I’ve added HTTP Server-Sent Events (SSE) support for real-time communication:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;Support for other clients:&lt;/strong&gt; Clients with support for HTTP Server-Sent Events (SSE) can now interact with the Rails MCP Server.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;using-http-mode-with-sse&quot;&gt;Using HTTP Mode with SSE&lt;/h2&gt;

&lt;p&gt;The Rails MCP Server can now run in two distinct modes:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;strong&gt;STDIO mode (default)&lt;/strong&gt;: Communicates over standard input/output for direct integration with clients like Claude Desktop.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;HTTP mode&lt;/strong&gt;: Runs as an HTTP server with JSON-RPC and Server-Sent Events (SSE) endpoints.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;To start in HTTP mode:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Start in HTTP mode on the default port (6029)&lt;/span&gt;
rails-mcp-server &lt;span class=&quot;nt&quot;&gt;--mode&lt;/span&gt; http

&lt;span class=&quot;c&quot;&gt;# Start in HTTP mode on a custom port&lt;/span&gt;
rails-mcp-server &lt;span class=&quot;nt&quot;&gt;--mode&lt;/span&gt; http &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 8080
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When running in HTTP mode, the server provides two endpoints:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;JSON-RPC endpoint: &lt;code class=&quot;highlighter-rouge&quot;&gt;http://localhost:&amp;lt;port&amp;gt;/mcp/messages&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;SSE endpoint: &lt;code class=&quot;highlighter-rouge&quot;&gt;http://localhost:&amp;lt;port&amp;gt;/mcp/sse&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;This enables integration with web applications, dashboard tools, and other systems that need to communicate with the Rails MCP server.&lt;/p&gt;

&lt;h2 id=&quot;upgrading-from-earlier-versions&quot;&gt;Upgrading from Earlier Versions&lt;/h2&gt;

&lt;p&gt;Upgrading to v1.1.0 should be straightforward for most users. The API remains backward compatible, so existing code should continue to work without modification. To upgrade:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;rails-mcp-server&apos;&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# This installs the current version 1.1.0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;under-the-hood&quot;&gt;Under the Hood&lt;/h2&gt;

&lt;p&gt;I’ve streamlined the codebase significantly by refactoring to use FastMCP. The FastMCP gem provides a robust implementation of the MCP protocol, handling message encoding/decoding, connection management, and event dispatching.&lt;/p&gt;

&lt;p&gt;I built the SSE implementation on top of Rack and integrated it seamlessly with FastMCP’s event system. This allows for efficient real-time updates and event streaming while maintaining compatibility with the Model Context Protocol standard.&lt;/p&gt;

&lt;h2 id=&quot;testing-with-mcp-inspector&quot;&gt;Testing with MCP Inspector&lt;/h2&gt;

&lt;p&gt;The Rails MCP Server v1.1.0 works seamlessly with MCP Inspector, making it easier than ever to test and debug your MCP server:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Install and run MCP Inspector with your Rails MCP Server&lt;/span&gt;
npm &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; @modelcontextprotocol/inspector

&lt;span class=&quot;c&quot;&gt;# Run the inspector and connect to the Rails MCP Server via STDIO or HTTP SSE&lt;/span&gt;
npx @modelcontextprotocol/inspector
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;how-i-use-the-rails-mcp-server&quot;&gt;How I use the Rails MCP Server&lt;/h2&gt;

&lt;p&gt;I use the server with Claude Desktop from Anthropic. It does not yet support HTTP SSE; it can only communicate via STDIO. Adding HTTP SSE facilitates people using other clients to use the server easily, as using the server with Claude Desktop is not simple if you use a Ruby version manager.&lt;/p&gt;

&lt;p&gt;Claude Desktop starts a process to run the server but with a &lt;em&gt;no login&lt;/em&gt; session, which means that your Ruby version manager is not initialized and macOS uses the bundled 2.6 Ruby version. There is no real fix for this situation, just a workaround. Please look at the &lt;a href=&quot;https://github.com/maquina-app/rails-mcp-server?tab=readme-ov-file#ruby-version-manager-users&quot;&gt;README&lt;/a&gt; to see how to make it work for &lt;strong&gt;rbenv&lt;/strong&gt;; a similar solution is required for other Ruby managers.&lt;/p&gt;

&lt;p&gt;When I start a session with Claude, my first prompt is:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Switch to project my_finances, don&apos;t analyze the project or any loaded files until you are told to.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I do this because the Sonnet model can start very creatively and begin analyzing all possible files in the project, consuming its quota.&lt;/p&gt;

&lt;p&gt;I work on a feature per chat, so I load only the files that are related to the work that I want to do:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Load the following file or files, do not analyze or try to load dependencies unless you are told to.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Again, here I pass the list of files to load but I stop Sonnet from trying to analyze without knowing yet what I want to do. My next prompt is to explain what I want to do, and then I ask it to analyze the files and maybe load more if needed.&lt;/p&gt;

&lt;p&gt;While working with Claude Desktop, it’s easy to reach the chat quota. I’m prepared at the end to continue with the feature if it’s not done yet. I use the following prompt:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Summarize this chat. Describe what is the goal and add any relevant information about what was done. Include the project name and the list with a brief description of any file loaded, generated or shared with you.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I copy the output and start a new chat with the following prompt:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Here is a summary of a previous chat. Switch to the project if a given name exists. Don&apos;t load any reference files until you are told to. Also, don&apos;t analyze the project or any loaded files until you are told to.
Just comprehend in a general way what was done before.

If you are told to generate data, always generate synthetic data unless you are told otherwise.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And continue with the cycle. Claude Desktop doesn’t write to the disk; I always review the generated code and copy it manually. I modify the code when it makes sense and share it back with Claude.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;I believe this release of Rails MCP Server v1.1.0 represents a significant step forward in terms of code quality and feature set. The integration with FastMCP provides a more maintainable foundation, while the addition of SSE support expands the communication options available to applications using the server.&lt;/p&gt;

&lt;p&gt;I encourage you to upgrade to this latest version and explore the new capabilities it offers. As always, I welcome feedback and contributions from the community.&lt;/p&gt;

&lt;p&gt;Source code is available at &lt;a href=&quot;https://github.com/maquina-app/rails-mcp-server&quot;&gt;https://github.com/maquina-app/rails-mcp-server&lt;/a&gt;&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/rails-mcp-server/rails-mcp-server-1-1-0.jpg" /><media:content medium="image" url="https://mariochavez.io/images/rails-mcp-server/rails-mcp-server-1-1-0.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en_US"><title type="html">Rails MCP Server - Enhancing AI-Assisted Development</title><link href="https://mariochavez.io/desarrollo/2025/03/21/rails-mcp-server-enhancing-ai-assisted-development/" rel="alternate" type="text/html" title="Rails MCP Server - Enhancing AI-Assisted Development" /><published>2025-03-21T12:00:00-06:00</published><updated>2025-03-21T12:00:00-06:00</updated><id>repo://posts.collection/_posts/2025-03-21-rails-mcp-server-enhancing-ai-assisted-development.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2025/03/21/rails-mcp-server-enhancing-ai-assisted-development/">&lt;p&gt;AI has changed the way we write and deploy code to production. LLMs are getting better and better at understanding and also at generating code. It started with chats, where you can make questions and share code, then evolved to suggest auto-completion inside the editor and later the inclusion of chats in the same editor.&lt;/p&gt;

&lt;p&gt;Nowadays we have editors that are created specifically to understand the code base and write code with just prompts, and a button to accept the changes and update the code base.&lt;/p&gt;

&lt;p&gt;But, there is a shortcoming when working with AI, mainly because of the bias of the LLMs that are better at generating code for the JavaScript ecosystem, and not that good with code in almost every other programming language.&lt;/p&gt;

&lt;p&gt;Still, AI is great for generating boilerplate code or for green field projects. Moreover, the possibility to extend LLM model knowledge with techniques and protocols that help with the time to deploy, adding significant value, even if it requires more iterations to help the LLM get the correct context.&lt;/p&gt;

&lt;p&gt;In my case, I can’t take advantage of the new IDEs that integrate AI into their core; I don’t use IDEs, I use Neovim. There are tools to make Neovim work like those IDEs, but still, that is something that I don’t want to do.&lt;/p&gt;

&lt;p&gt;With my way of work, I prefer to use Claude Desktop with the Sonnets models. My workflow is simple; I create projects with a prompt that provides general instructions for the model, something like:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;You are an expert Ruby on Rails developer. Help me to write professional and well-crafted code; don’t explain it unless required. You are familiar with TailwindCSS, Turbo Rails, Hotwire, and Stimulus. Also, don’t write tests unless you are required. All tests should be with minitest in unit test style.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Then, in the knowledge base of the project, I add documentation and texts that provide context in greater detail, along with code style, what to do, and what not to do.&lt;/p&gt;

&lt;p&gt;Once my projects are configured, then I can start doing some work. I mainly work on brownfield projects with large code bases, so sharing the whole code base is not an option. Before I start the task at hand, I collect fragments of code that can be relevant to what I need to accomplish.&lt;/p&gt;

&lt;p&gt;I even have a bash script that can copy the full content of a file along with the file path. The AI generates new code or changes with my instructions since the AI can’t write directly to my files, this allows me to review the code and assess if it will work as expected and if the code style is consistent with my code base.&lt;/p&gt;

&lt;p&gt;If I spot something that I can write better or might produce an error, I don’t ask the AI to fix it. I just copy what makes sense to Neovim, update the code, and copy it back to the AI so it can have the latest version. I work this way because I don’t Vibe code. I need to keep some quality in the code, and I also need to fully understand what is happening because that code powers companies and their customers.&lt;/p&gt;

&lt;p&gt;This workflow works great so far, but when I learned about the Model Context Protocol or MCP, I wondered how I might be able to use it to improve how I share code with Claude Desktop. So, I embarked on a quest to create a Rails MCP server; actually, Claude Desktop wrote about 80% of it.&lt;/p&gt;

&lt;h2 id=&quot;what-the-rails-mcp-server-can-do&quot;&gt;What the Rails MCP Server can do?&lt;/h2&gt;

&lt;p&gt;The Rails MCP Server provides a set of tools that allow Claude to interact directly with my Rails projects. This enables a more seamless workflow when I need AI assistance with my codebase. Here are the capabilities:&lt;/p&gt;

&lt;h3 id=&quot;project-navigation&quot;&gt;Project Navigation&lt;/h3&gt;

&lt;p&gt;I can easily switch between different Rails projects using the &lt;code class=&quot;highlighter-rouge&quot;&gt;switch_project&lt;/code&gt; tool. This is particularly useful when I’m working on multiple applications and need Claude’s assistance with different codebases throughout my workday.&lt;/p&gt;

&lt;p&gt;The Rails MCP Server follows the XDG Base Directory Specification for configuration files:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;On macOS: &lt;code class=&quot;highlighter-rouge&quot;&gt;$XDG_CONFIG_HOME/rails-mcp&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.config/rails-mcp&lt;/code&gt; if XDG_CONFIG_HOME is not set&lt;/li&gt;
  &lt;li&gt;On Windows: &lt;code class=&quot;highlighter-rouge&quot;&gt;%APPDATA%\rails-mcp&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The server automatically creates these directories and an empty &lt;code class=&quot;highlighter-rouge&quot;&gt;projects.yml&lt;/code&gt; file on the first run. To configure my projects, I edit the &lt;code class=&quot;highlighter-rouge&quot;&gt;projects.yml&lt;/code&gt; file to include my Rails projects:&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;store&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;~/projects/store&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;blog&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;~/projects/rails-blog&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Each key in the YAML file is a project name (used with the &lt;code class=&quot;highlighter-rouge&quot;&gt;switch_project&lt;/code&gt; tool), and each value is the path to the project directory.&lt;/p&gt;

&lt;p&gt;Example prompts I use:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Can you switch to the ‘store’ project so we can explore it?”&lt;/li&gt;
  &lt;li&gt;“I’d like to analyze my ‘blog’ application. Please switch to that project first.”&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;project-overview&quot;&gt;Project Overview&lt;/h3&gt;

&lt;p&gt;With the &lt;code class=&quot;highlighter-rouge&quot;&gt;get_project_info&lt;/code&gt; tool, Claude can provide me with a comprehensive overview of my Rails application, including its version, directory structure, and configuration. This gives Claude the necessary context to understand my application’s architecture before diving into specific tasks.&lt;/p&gt;

&lt;p&gt;Example prompts I use:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Now that we’re in the blog project, can you give me an overview of the project structure and Rails version?”&lt;/li&gt;
  &lt;li&gt;“Tell me about this Rails application. What version is it running and how is it organized?”&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;file-exploration&quot;&gt;File Exploration&lt;/h3&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;list_files&lt;/code&gt; tool allows Claude to scan my project directories and locate specific files. I can filter by directory path or file pattern, making it easy to find what I need.&lt;/p&gt;

&lt;p&gt;Example prompts I use:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Can you list all the model files in this project?”&lt;/li&gt;
  &lt;li&gt;“Show me all the controller files in the app/controllers directory.”&lt;/li&gt;
  &lt;li&gt;“List all the JavaScript files in the app/javascript directory.”&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;code-examination&quot;&gt;Code Examination&lt;/h3&gt;

&lt;p&gt;Using the &lt;code class=&quot;highlighter-rouge&quot;&gt;get_file&lt;/code&gt; tool, Claude can retrieve the complete content of any file in my project with syntax highlighting. This eliminates my need to manually copy and paste code snippets, streamlining my workflow.&lt;/p&gt;

&lt;p&gt;Example prompts I use:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Can you show me the content of the User model file?”&lt;/li&gt;
  &lt;li&gt;“I need to see what’s in app/controllers/products_controller.rb. Can you retrieve that file?”&lt;/li&gt;
  &lt;li&gt;“Please show me the application.rb file so I can check the configuration settings.”&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;route-analysis&quot;&gt;Route Analysis&lt;/h3&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;get_routes&lt;/code&gt; tool provides access to all HTTP routes defined in my Rails application. Claude can analyze the routing structure to help me understand API endpoints, URL patterns, and controller actions.&lt;/p&gt;

&lt;p&gt;Example prompts I use:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Can you show me all the routes defined in this application?”&lt;/li&gt;
  &lt;li&gt;“I need to understand the API endpoints available in this project. Can you list the routes?”&lt;/li&gt;
  &lt;li&gt;“Show me the routing configuration for this Rails app so I can see how the URLs are structured.”&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;model-inspection&quot;&gt;Model Inspection&lt;/h3&gt;

&lt;p&gt;With the &lt;code class=&quot;highlighter-rouge&quot;&gt;get_models&lt;/code&gt; tool, Claude can examine my Active Record models in detail. It can list all models or provide comprehensive information about a specific model, including its schema, associations, and code implementation.&lt;/p&gt;

&lt;p&gt;Example prompts I use:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Can you list all the models in this Rails project?”&lt;/li&gt;
  &lt;li&gt;“I’d like to understand the User model in detail. Can you show me its schema, associations, and code?”&lt;/li&gt;
  &lt;li&gt;“Show me the Product model’s definition, including its relationships with other models.”&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;schema-investigation&quot;&gt;Schema Investigation&lt;/h3&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;get_schema&lt;/code&gt; tool allows Claude to access my database schema information. It can show the complete database structure or focus on a specific table, displaying columns, data types, constraints, and relationships.&lt;/p&gt;

&lt;p&gt;Example prompts I use:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;“Can you show me the complete database schema for this Rails application?”&lt;/li&gt;
  &lt;li&gt;“I’d like to see the structure of the users table. Can you retrieve that schema information?”&lt;/li&gt;
  &lt;li&gt;“Show me the columns and their data types in the products table.”&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The Rails MCP Server doesn’t just save me time—it enhances Claude’s understanding of my codebase, leading to more accurate and relevant assistance. Whether I’m troubleshooting an issue, implementing a new feature, or refactoring existing code, Claude can now access the context it needs to provide helpful suggestions tailored to my specific project.&lt;/p&gt;

&lt;h2 id=&quot;installation&quot;&gt;Installation&lt;/h2&gt;

&lt;p&gt;Installing the Rails MCP Server is straightforward. I start by installing the gem:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gem &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;rails-mcp-server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After installation, the &lt;code class=&quot;highlighter-rouge&quot;&gt;rails-mcp-server&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;rails-mcp-setup-claude&lt;/code&gt; executables are available in my PATH.&lt;/p&gt;

&lt;h2 id=&quot;claude-desktop-integration&quot;&gt;Claude Desktop Integration&lt;/h2&gt;

&lt;p&gt;I run the setup script which automatically configures Claude Desktop and sets up the proper XDG-compliant directory structure:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rails-mcp-setup-claude
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The script:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Creates the appropriate config directory for my platform&lt;/li&gt;
  &lt;li&gt;Creates an empty &lt;code class=&quot;highlighter-rouge&quot;&gt;projects.yml&lt;/code&gt; file if it doesn’t exist&lt;/li&gt;
  &lt;li&gt;Updates my Claude Desktop configuration&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;After running the script, I restart Claude Desktop to apply the changes.&lt;/p&gt;

&lt;h3 id=&quot;ruby-version-manager-users&quot;&gt;Ruby Version Manager Users&lt;/h3&gt;

&lt;p&gt;Claude Desktop launches the MCP server using my system’s default Ruby environment, bypassing version manager initialization (e.g., rbenv, RVM). The MCP server needs to use the same Ruby version where it was installed, as MCP server startup failures can occur when using an incompatible Ruby version.&lt;/p&gt;

&lt;p&gt;Since I use a Ruby version manager (rbenv), I create a symbolic link to my Ruby shim to ensure the correct version is used:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo ln&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; /home/mario/.rbenv/shims/ruby /usr/local/bin/ruby
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I replace the path with my actual path for the Ruby shim.&lt;/p&gt;

&lt;h2 id=&quot;final-thoughts&quot;&gt;Final Thoughts&lt;/h2&gt;

&lt;p&gt;If you want access to the source code, here is the link &lt;a href=&quot;https://github.com/maquina-app/rails-mcp-server&quot;&gt;https://github.com/maquina-app/rails-mcp-server&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The Rails MCP Server is a significant step forward in how I interact with AI assistants like Claude as a Ruby on Rails developer. I’ve learned that AI outputs are only as good as the context I provide—when Claude has access to the right files and project structures, the quality and accuracy of its suggestions improve dramatically. Instead of manually copying snippets or trying to explain complex relationships between models, I can simply ask Claude to examine the relevant files directly, maintaining control over my development process while enhancing my existing Neovim workflow with contextually aware AI assistance.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/rails-mcp-server/rails-mcp-server.jpg" /><media:content medium="image" url="https://mariochavez.io/images/rails-mcp-server/rails-mcp-server.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en_US"><title type="html">Nobuild with Rails and Importmap</title><link href="https://mariochavez.io/desarrollo/2024/11/28/nobuild-with-rails-and-importmap/" rel="alternate" type="text/html" title="Nobuild with Rails and Importmap" /><published>2024-11-28T12:00:00-06:00</published><updated>2024-11-28T12:00:00-06:00</updated><id>repo://posts.collection/_posts/2024-11-28-nobuild-with-rails-and-importmap.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2024/11/28/nobuild-with-rails-and-importmap/">&lt;p&gt;The latest versions of Ruby on Rails have focused on simplicity across different aspects of the framework, accompanied by the promise to return to the “one-man framework” (where a single developer can effectively build and maintain an entire application).&lt;/p&gt;

&lt;p&gt;Importmap Rails library is based on the principle that modern web browsers have caught up with the ECMAScript specification and can interpret ES Modules (ESM). As a web standard, Importmap allows you to control how JavaScript modules are resolved in the browser and manage dependencies and versions without the need to transpile or bundle the code sent to the browser.&lt;/p&gt;

&lt;h2 id=&quot;how-the-importmap-web-standard-works&quot;&gt;How the Importmap Web Standard Works&lt;/h2&gt;

&lt;p&gt;It all starts with a &lt;code class=&quot;highlighter-rouge&quot;&gt;script&lt;/code&gt; tag of type &lt;code class=&quot;highlighter-rouge&quot;&gt;importmap&lt;/code&gt; defined in your application’s main layout or web page. Inside this tag, a JSON object defines aliases and their corresponding paths to the source code.&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;script &lt;/span&gt;&lt;span class=&quot;na&quot;&gt;type=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;importmap&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;imports&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/assets/application.js&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;local-time&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;https://cdn.jsdelivr.net/npm/local-time@3.0.2/app/assets/javascripts/local-time.es2017-esm.min.js&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;utils&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/assets/utils.js&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the same map, you can mix library paths pointing to a CDN or using local resources. To use libraries from this map, reference the alias name.&lt;/p&gt;

&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;&amp;lt;!--&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Below&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;the&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;importmap&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;script&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;--&amp;gt;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;script&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;sr&quot;&gt;/script&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;&amp;gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And in your &lt;em&gt;application.js&lt;/em&gt;, import needed dependencies:&lt;/p&gt;

&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// application.js&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;LocalTime&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;local-time&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;LocalTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;utils&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Importmap support is present in browsers Chrome 89+, Safari 16.4+, Firefox 108+, and Edge 89+. For older browsers, include a polyfill:&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;script
  &lt;/span&gt;&lt;span class=&quot;na&quot;&gt;async&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;src=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://ga.jspm.io/npm:es-module-shims@1.10.1/dist/es-module-shims.js&quot;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;how-importmap-works-in-ruby-on-rails&quot;&gt;How Importmap Works in Ruby on Rails&lt;/h2&gt;

&lt;p&gt;Importmap functionality in Ruby on Rails follows the same standard described above and offers an easy way to create maps and version files. Using a web application named &lt;strong&gt;heroImage&lt;/strong&gt; as an example (source code available on &lt;a href=&quot;https://github.com/mariochavez/inspiration&quot;&gt;Github&lt;/a&gt;), let’s explore the implementation.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/no-build-importmap/heroimage-home.png&quot; alt=&quot;heroImage website&quot; /&gt;&lt;/p&gt;

&lt;p&gt;When you create a new Rails 8 application, the &lt;strong&gt;importmap-rails&lt;/strong&gt; gem is added and installed by default. A file &lt;em&gt;config/importmap.rb&lt;/em&gt; is created where you can &lt;em&gt;pin&lt;/em&gt; the JavaScript code needed in your application.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;application&quot;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/turbo-rails&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;turbo.min.js&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/stimulus&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;stimulus.min.js&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/stimulus-loading&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;stimulus-loading.js&quot;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;pin_all_from&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;app/javascript/controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;under: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;preload: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;pin&lt;/code&gt; keyword takes up to three arguments. The first one is required, as it is the alias of the JavaScript code. &lt;code class=&quot;highlighter-rouge&quot;&gt;pin &quot;application&quot;&lt;/code&gt; is a shortcut for file &lt;em&gt;application.js&lt;/em&gt; with alias &lt;em&gt;application&lt;/em&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;application&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;application.js&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When alias and file names differ, use the keyword &lt;code class=&quot;highlighter-rouge&quot;&gt;to:&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/turbo-rails&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;turbo.min.js&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;pin_all_from&lt;/code&gt; keyword helps reference multiple files at once. The first argument is the path where the JavaScript files are located, and the &lt;code class=&quot;highlighter-rouge&quot;&gt;under:&lt;/code&gt; argument prefixes the alias for each file. The generated alias uses the &lt;em&gt;under&lt;/em&gt; prefix and the file name, like &lt;code class=&quot;highlighter-rouge&quot;&gt;controllers/alert-controller&lt;/code&gt; for &lt;code class=&quot;highlighter-rouge&quot;&gt;alert_controller.js&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;To visualize the Importmap JSON file, execute:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bin/importmap json

&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;imports&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/turbo-rails&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/turbo.min-fae85750.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/stimulus&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/stimulus.min-4b1e420e.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/stimulus-loading&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/stimulus-loading-1fc53fe7.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;application&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/application-b1902c45.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;controllers/application&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/controllers/application-fab0f35b.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;controllers&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/controllers/index-c3f5d3c4.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;controllers/alert_controller&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/controllers/alert_controller-caf203bf.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;controllers/file_controller&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/controllers/file_controller-5da5fdc5.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;controllers/notifications_controller&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/controllers/notifications_controller-88e2cc65.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;controllers/service_worker_controller&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/controllers/service_worker_controller-ad4a24d3.js&quot;&lt;/span&gt;,
    &lt;span class=&quot;s2&quot;&gt;&quot;controllers/share_controller&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;//127.0.0.1:4700/assets/controllers/share_controller-fe28ed00.js&quot;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Rails resolves all JavaScript through the &lt;a href=&quot;https://github.com/rails/propshaft&quot;&gt;Propshaft&lt;/a&gt; gem, which resolves the physical path of the JavaScript code, maps to the &lt;em&gt;/assets&lt;/em&gt; web path, and adds the digest to each file for better caching and invalidations.&lt;/p&gt;

&lt;p&gt;Propshaft discovers physical paths from the asset’s configuration:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;assets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;paths&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Ensure your files exist in any of the registered paths or add your own path to be discovered by Propshaft and Importmap.&lt;/p&gt;

&lt;p&gt;Importmap in Rails allows you to specify how the browser should load JavaScript files. There are two options: &lt;code class=&quot;highlighter-rouge&quot;&gt;preload&lt;/code&gt; (default) and no preload. Preload tells the browser to download files as soon as possible. Importmap generates a link tag with &lt;code class=&quot;highlighter-rouge&quot;&gt;rel=&quot;modulepreload&quot;&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;link&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;rel=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;modulepreload&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;href=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://heroimage.co/assets/turbo.min-fae85750.js&quot;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;link&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;rel=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;modulepreload&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;href=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://heroimage.co/assets/stimulus-loading-1fc53fe7.js&quot;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;link&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;rel=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;modulepreload&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;href=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://heroimage.co/assets/stimulus-loading-1fc53fe7.js&quot;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;link&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;rel=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;modulepreload&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;href=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://heroimage.co/assets/application-b1902c45.js&quot;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you set the &lt;code class=&quot;highlighter-rouge&quot;&gt;preload&lt;/code&gt; argument to &lt;code class=&quot;highlighter-rouge&quot;&gt;false&lt;/code&gt;, the link tag is not generated and the browser downloads the file when needed.&lt;/p&gt;

&lt;p&gt;With Rails’ Importmap, you can also &lt;em&gt;pin&lt;/em&gt; JavaScript code from a CDN using the &lt;code class=&quot;highlighter-rouge&quot;&gt;to:&lt;/code&gt; argument for the URL:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;local-time&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://cdn.jsdelivr.net/npm/local-time@3.0.2/app/assets/javascripts/local-time.es2017-esm.min.js&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The Importmap includes a CLI to &lt;strong&gt;pin&lt;/strong&gt; or &lt;strong&gt;unpin&lt;/strong&gt; JavaScript code into &lt;em&gt;config/importmap.rb&lt;/em&gt; file. It also includes commands to update, audit, and inspect versions:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bin/importmap &lt;span class=&quot;nt&quot;&gt;--help&lt;/span&gt;
Commands:
  importmap audit              &lt;span class=&quot;c&quot;&gt;# Run a security audit&lt;/span&gt;
  importmap &lt;span class=&quot;nb&quot;&gt;help&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;COMMAND]     &lt;span class=&quot;c&quot;&gt;# Describe available commands or one specific command&lt;/span&gt;
  importmap json               &lt;span class=&quot;c&quot;&gt;# Show the full importmap in json&lt;/span&gt;
  importmap outdated           &lt;span class=&quot;c&quot;&gt;# Check for outdated packages&lt;/span&gt;
  importmap packages           &lt;span class=&quot;c&quot;&gt;# Print out packages with version numbers&lt;/span&gt;
  importmap pin &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;PACKAGES]    &lt;span class=&quot;c&quot;&gt;# Pin new packages&lt;/span&gt;
  importmap unpin &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;PACKAGES]  &lt;span class=&quot;c&quot;&gt;# Unpin existing packages&lt;/span&gt;
  importmap update             &lt;span class=&quot;c&quot;&gt;# Update outdated package pins&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When using the &lt;em&gt;pin&lt;/em&gt; command for a JavaScript package, instead of setting the &lt;code class=&quot;highlighter-rouge&quot;&gt;to:&lt;/code&gt; argument to the CDN, Importmap resolves package dependencies and downloads the package and dependencies to &lt;em&gt;vendor/javascript&lt;/em&gt;, allowing the Rails application to serve those files:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bin/importmap pin local-time
Pinning &lt;span class=&quot;s2&quot;&gt;&quot;local-time&quot;&lt;/span&gt; to vendor/javascript/local-time.js via download from https://ga.jspm.io/npm:local-time@3.0.2/app/assets/javascripts/local-time.es2017-esm.js
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# config/importmap.rb&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;local-time&quot;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# @3.0.2&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This approach works well when your package has simple dependencies or well-defined dependencies in the JavaScript package. If that’s not the case, it becomes challenging to use with Importmap vendoring the code at &lt;em&gt;vendor/javascript&lt;/em&gt;. It might work with the URL and manual dependency addition, or you can &lt;a href=&quot;https://mariochavez.io/desarrollo/2024/08/09/no-build-javascript-rails-importmap/&quot;&gt;tweak the vendored code&lt;/a&gt; to make it work.&lt;/p&gt;

&lt;h2 id=&quot;how-to-work-with-rails-gems---engines---and-importmap&quot;&gt;How to Work with Rails Gems - Engines - and Importmap?&lt;/h2&gt;

&lt;p&gt;There are two approaches to creating Ruby on Rails gems compatible with Importmap. The first approach allows your gem to provide JavaScript code, which you can choose to pin in the Importmap configuration. This is how the &lt;strong&gt;turbo-rails&lt;/strong&gt; and &lt;strong&gt;stimulus-rails&lt;/strong&gt; gems are implemented.&lt;/p&gt;

&lt;p&gt;Place your JavaScript code in the &lt;em&gt;app/assets/javascripts&lt;/em&gt; folder of your gem. You may need an additional process that minifies the JavaScript files and generates JavaScript map files. Then, inside the &lt;code class=&quot;highlighter-rouge&quot;&gt;Engine&lt;/code&gt; class, define an &lt;code class=&quot;highlighter-rouge&quot;&gt;initializer&lt;/code&gt; hook to declare your JavaScript code with Propshaft:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;MyEngine&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Engine&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Additional code&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;PRECOMPILE_ASSETS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;%w( my_javascript.js my_javascript.min.js my_javascript.min.js.map )&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;freeze&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;initializer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;my_engine.assets&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;respond_to?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:assets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;assets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;precompile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PRECOMPILE_ASSETS&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The second option uses an Importmap configuration file. If your engine has its layout template and the views are isolated from the host application, and the engine doesn’t need to share the JavaScript code with the host application, you can create an Importmap configuration file at &lt;em&gt;config/importmap.rb&lt;/em&gt;, set your pins, place your JavaScript code at &lt;em&gt;app/javascript&lt;/em&gt;, and configure the engine with an initializer.&lt;/p&gt;

&lt;p&gt;Open your &lt;code class=&quot;highlighter-rouge&quot;&gt;engine.rb&lt;/code&gt; Ruby file and add the Importmap configuration file and a sweeper:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;initializer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;my-engine.importmap&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;after: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;importmap&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config/importmap.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;cache_sweeper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;watches: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;app/javascript&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;

  &lt;span class=&quot;no&quot;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;on_load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:action_controller_base&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;before_action&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;cache_sweeper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute_if_updated&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Specify the Importmap to use in your engine’s layout template:&lt;/p&gt;

&lt;div class=&quot;language-erb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;javascript_importmap_tags&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;application&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;importmap: &lt;/span&gt;&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt; &lt;span class=&quot;cp&quot;&gt;%&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For sharing JavaScript code with the host application, like Stimulus controllers, create a partial Importmap configuration file and set the engine to merge it with the main one in the host application.&lt;/p&gt;

&lt;p&gt;Create an Importmap configuration file at &lt;em&gt;config/importmap.rb&lt;/em&gt; and add the JavaScript pins to share with the host application. If you have dependencies for external packages, add those via a generator or installer to the host application:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin_all_from&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;expand_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;../app/assets/javascripts/controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__dir__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;under: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;preload: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;false&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Open your &lt;code class=&quot;highlighter-rouge&quot;&gt;engine.rb&lt;/code&gt; file and add an initializer:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;initializer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;maquina.importmap&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;before: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;importmap&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;paths&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config/importmap.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;what-are-the-advantages-of-using-importmap&quot;&gt;What are the Advantages of Using Importmap?&lt;/h2&gt;

&lt;p&gt;From a Ruby on Rails developer perspective, the main advantage of using Importmap is the freedom from requiring a JavaScript runtime-like node and freedom from the &lt;em&gt;node_modules&lt;/em&gt; dependency.&lt;/p&gt;

&lt;p&gt;Additionally, you don’t need an additional process in development mode to transpile and minify the JavaScript code. You rely on web standards to serve the code to the browser. Deploying your Rails application behind a reverse proxy offers several benefits. First, if you enable the HTTP/2 protocol, your browser can fetch multiple files with a single HTTP connection, and downloading many small JavaScript files won’t impact performance.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/no-build-importmap/tools.png&quot; alt=&quot;Web tools&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Enabling your proxy to use gzip or brotli compression ensures you are sending very small files while maintaining readability when using browser developer tools. If you change one file, you only need to invalidate that specific file, which the browser will download. The browser knows that a file was modified because of the fingerprint that Propshaft adds to all files.&lt;/p&gt;

&lt;p&gt;Using a reverse proxy like &lt;a href=&quot;https://github.com/basecamp/thruster&quot;&gt;Thruster&lt;/a&gt; along with Puma offloads the assets serving from the Rails application. Thruster can cache assets and serve them when a client requests a file.&lt;/p&gt;

&lt;h2 id=&quot;when-not-to-use-importmap&quot;&gt;When Not to Use Importmap&lt;/h2&gt;

&lt;p&gt;There are cases where you should avoid using Importmap in a Rails application. If you are building a SPA application with React, Vue, or any other similar tool, there is a high likelihood you are writing your code with TypeScript. In this case, you should stick with the bundling strategy.&lt;/p&gt;

&lt;p&gt;Additionally, if you need to support older browsers, bundling with code transpilation is a better option.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/no-build-importmap/nobuild-with-rails.jpg" /><media:content medium="image" url="https://mariochavez.io/images/no-build-importmap/nobuild-with-rails.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en_US"><title type="html">No build for Javascript libraries with Rails and Importmap</title><link href="https://mariochavez.io/desarrollo/2024/08/09/no-build-javascript-rails-importmap/" rel="alternate" type="text/html" title="No build for Javascript libraries with Rails and Importmap" /><published>2024-08-09T12:00:00-06:00</published><updated>2024-08-09T12:00:00-06:00</updated><id>repo://posts.collection/_posts/2024-08-09-no-build-javascript-rails-importmap.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2024/08/09/no-build-javascript-rails-importmap/">&lt;p&gt;As a web developer working with Ruby on Rails, you’re always looking for ways to streamline your workflow and make your applications more efficient. Enter Importmap - a powerful feature that simplifies how you manage JavaScript libraries in your Rails projects. In this post, we’ll dive into what Importmap is, how it works, and how you can use it for your projects.&lt;/p&gt;

&lt;h2 id=&quot;what-is-importmap&quot;&gt;What is Importmap?&lt;/h2&gt;

&lt;p&gt;Importmap is a way to map JavaScript module names to their actual locations. They allow you to use &lt;code class=&quot;highlighter-rouge&quot;&gt;import&lt;/code&gt; statements in your JavaScript code without needing a bundler like Webpack or Rollup. This means you can use modern JavaScript modules directly in the browser, making your development process simpler and faster.&lt;/p&gt;

&lt;h2 id=&quot;how-does-importmap-work&quot;&gt;How does Importmap work?&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;strong&gt;Mapping&lt;/strong&gt;: Importmaps create a mapping between a module name and its location.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Browser Support&lt;/strong&gt;: Modern browsers use this mapping to load modules when they encounter &lt;code class=&quot;highlighter-rouge&quot;&gt;import&lt;/code&gt; statements.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Rails Integration&lt;/strong&gt;: Rails 7+ includes built-in support for Importmap, making it easy to use in your projects.&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;Local Pinning&lt;/strong&gt;: By default, Rails pins libraries locally, copying the code to your project into the &lt;code class=&quot;highlighter-rouge&quot;&gt;vendor/javascript&lt;/code&gt; folder. While this might feel similar to how JavaScript libraries were vendored in older Rails projects, Importmap provides a modern tool for managing dependencies and versions.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;practical-tips-for-using-importmap-in-rails&quot;&gt;Practical tips for using Importmap in Rails&lt;/h2&gt;

&lt;h3 id=&quot;1-setting-up-importmap&quot;&gt;1. Setting up Importmap&lt;/h3&gt;

&lt;p&gt;For a new Rails application, Importmap is set up by default. If you want to add it to an existing application, then follow these steps.&lt;/p&gt;

&lt;p&gt;To get started with Importmap in your Rails project, add this to your Gemfile:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;gem&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;importmap-rails&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then run:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bundle install
bin/rails importmap:install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This sets up the necessary files and configurations.&lt;/p&gt;

&lt;h3 id=&quot;2-adding-javascript-libraries&quot;&gt;2. Adding JavaScript libraries&lt;/h3&gt;

&lt;p&gt;To add a library, use the &lt;code class=&quot;highlighter-rouge&quot;&gt;pin&lt;/code&gt; option with &lt;code class=&quot;highlighter-rouge&quot;&gt;bin/importmap&lt;/code&gt; command. Let’s use Chart.js as an example:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; bin/importmap pin chart.js
Pinning &lt;span class=&quot;s2&quot;&gt;&quot;chart.js&quot;&lt;/span&gt; to vendor/javascript/chart.js.js via download from https://ga.jspm.io/npm:chart.js@4.4.3/dist/chart.js
Pinning &lt;span class=&quot;s2&quot;&gt;&quot;@kurkle/color&quot;&lt;/span&gt; to vendor/javascript/@kurkle/color.js via download from https://ga.jspm.io/npm:@kurkle/color@0.3.2/dist/color.esm.js
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This command performs the following steps::&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Download Chart.js and its dependencies.&lt;/li&gt;
  &lt;li&gt;Place the files in the &lt;code class=&quot;highlighter-rouge&quot;&gt;vendor/javascript&lt;/code&gt; directory.&lt;/li&gt;
  &lt;li&gt;Update the &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt; file with the correct local paths.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This is the contents of &lt;code class=&quot;highlighter-rouge&quot;&gt;vendor/javascript&lt;/code&gt; directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;ls &lt;/span&gt;vendor/javascript
8.5k  9 Aug 12:53 &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt;  @kurkle--color.js
186k  9 Aug 12:53 &lt;span class=&quot;nt&quot;&gt;-N&lt;/span&gt;  chart.js.js
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt; looks as follows with the pinned libraries.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;chart.js&apos;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# @4.4.3&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;@kurkle/color&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;@kurkle--color.js&apos;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# @0.3.2&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, let’s create a Stimulus controller to use Chart.js. First, make sure you have Stimulus installed in your Rails application. Then, create a new file &lt;code class=&quot;highlighter-rouge&quot;&gt;app/javascript/controllers/chart_controller.js&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;@hotwired/stimulus&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;registerables&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;chart.js&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;nx&quot;&gt;Chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;register&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;registerables&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;targets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;canvas&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

  &lt;span class=&quot;nf&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;canvasTarget&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;getContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;2d&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;chart&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;January&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;February&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;March&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;April&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;May&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;June&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;datasets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Sample Data&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;65&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;59&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;80&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;81&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;56&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;55&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;borderColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;rgba(75, 192, 192, 1)&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;backgroundColor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;rgba(75, 192, 192, 0.2)&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;borderWidth&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;scales&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;na&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;na&quot;&gt;beginAtZero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;nf&quot;&gt;disconnect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;chart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;destroy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now you can use this Stimulus controller in your Rails view. For example, in &lt;code class=&quot;highlighter-rouge&quot;&gt;app/views/home/index.html.erb&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-erb highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;data-controller=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;chart&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;canvas&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;data-chart-target=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;canvas&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;width=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;400&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;height=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;200&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&amp;lt;/canvas&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This setup allows you to easily create charts in your Rails application using Chart.js through a Stimulus controller. The chart data can be dynamically passed from your Rails backend to the frontend using Stimulus values.&lt;/p&gt;

&lt;p&gt;But if you try to load the page, the graph is not displayed. After looking at the developer tools in the browser, you will find the following error:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Failed to register controller: chart (controllers/chart_controller)
  TypeError: Importing a module script failed.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The error is not helpful, but it gives you a clue that there is a problem with the dependencies in the Stimulus &lt;code class=&quot;highlighter-rouge&quot;&gt;chart_controller&lt;/code&gt;. Looking at the network tab in the browser tools, you find out that there is a missing file.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;URL: http://localhost:3000/_/6La3kzg5.js
Status: 404 Not Found
Source: Network
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the code of the file &lt;code class=&quot;highlighter-rouge&quot;&gt;vendor/javascript/chart.js.js&lt;/code&gt;, almost at the beginning of the file, you find the following reference:&lt;/p&gt;

&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;...&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Jt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;../_/6La3kzg5.js&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems like &lt;a href=&quot;https://jspm.org&quot;&gt;jspm.io&lt;/a&gt; adds a dependency which Importmap is unable to identify and download with the rest of the files. This is a known issue documented in the Importmap repository, as &lt;a href=&quot;https://github.com/rails/importmap-rails/pull/235&quot;&gt;Download all the files associated with a package from a CDN&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;3-pinning-from-cdns&quot;&gt;3. Pinning from CDNs&lt;/h3&gt;

&lt;p&gt;While Importmap pins libraries locally by default, it also allows you to pin from a CDN instead. Using this method, the library is served directly from the CDN instead of our Rails application.&lt;/p&gt;

&lt;p&gt;To try to find a solution, change the pins in the &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt; file to point to the CDN:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Using JSPM.io (default)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;chart.js&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;https://ga.jspm.io/npm:chart.js@4.3.0/dist/chart.js&apos;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;@kurkle/color&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;https://ga.jspm.io/npm:@kurkle/color@0.3.2/dist/color.esm.js&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After making the change, reload the page. Now the graph is there, loading the libraries from the CDN solved the issue of missing references. If you are ok with this approach, then you can stop here.&lt;/p&gt;

&lt;p&gt;If your goal is to serve and cache the libraries without a dependency on external CDN, then continue to the next section.&lt;/p&gt;

&lt;h3 id=&quot;4-customizing-local-pinning&quot;&gt;4. Customizing local pinning&lt;/h3&gt;

&lt;p&gt;With the option to choose a CDN from which to vendor JavaScript libraries, you should try another CDN, like &lt;a href=&quot;www.jsdelivr.com&quot;&gt;JSDeliver&lt;/a&gt;. Each CDN bundles dependencies differently, so you might get lucky trying another option.&lt;/p&gt;

&lt;p&gt;Remove all files from &lt;code class=&quot;highlighter-rouge&quot;&gt;vendor/javascript&lt;/code&gt; and remove the pins to Chart.js and @kurkle/color from &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt;. The Importmap’s pin command accepts option &lt;code class=&quot;highlighter-rouge&quot;&gt;-f&lt;/code&gt; to specify a specific CDN different from JSpm.io.&lt;/p&gt;

&lt;p&gt;The first try to pin Chart.js fails with an error.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; bin/importmap pin chart.js &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; jsdelivr
Pinning &lt;span class=&quot;s2&quot;&gt;&quot;chart.js&quot;&lt;/span&gt; to vendor/javascript/chart.js.js via download from https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.js
/.rbenv/versions/3.3.4/lib/ruby/3.3.0/net/http.rb:1603:in &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;initialize&lt;span class=&quot;s1&quot;&gt;&apos;: Failed to open TCP connection to cdn.jsdelivr.net:443 (execution expired) (Net::OpenTimeout)
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the second try, add the library @kurkle/color to the pin command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; bin/importmap pin chart.js @kurkle/color  &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; jsdelivr
Pinning &lt;span class=&quot;s2&quot;&gt;&quot;@kurkle/color&quot;&lt;/span&gt; to vendor/javascript/@kurkle/color.js via download from https://cdn.jsdelivr.net/npm/@kurkle/color@0.3.2/dist/color.esm.js
Pinning &lt;span class=&quot;s2&quot;&gt;&quot;chart.js&quot;&lt;/span&gt; to vendor/javascript/chart.js.js via download from https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.js
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This time it succeeded, the new files are placed in &lt;code class=&quot;highlighter-rouge&quot;&gt;vendor/javascript&lt;/code&gt; and the file &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt; contains the pins. Reloading the page in your application shows that you have the same error as before, the missing file name is different but still the same result.&lt;/p&gt;

&lt;p&gt;It is time to try something different. Remove the files from &lt;code class=&quot;highlighter-rouge&quot;&gt;vendor/javascript&lt;/code&gt; one more time. Navigate to that directory and open your browser to &lt;a href=&quot;https://www.jsdelivr.com/&quot;&gt;https://www.jsdelivr.com/&lt;/a&gt;. Search for Chart.js and from the code block copy the URL and download the library using curl. Also, search for @kurkle/color and download it.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; chart.js.js &lt;span class=&quot;s1&quot;&gt;&apos;https://cdn.jsdelivr.net/npm/chart.js@4.4.3/+esm&apos;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; curl &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; @kurkle--color.js &lt;span class=&quot;s1&quot;&gt;&apos;https://cdn.jsdelivr.net/npm/@kurkle/color@0.3.2/+esm&apos;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once again, reload your application page. One more time you will get an error in the browser developer tools, but this time the error is different. It says that @kurkle/color failed to be loaded.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[Error] Failed to load resource: the server responded with a status of 404 (Not Found) http://localhost:3000/npm/@kurkle/color@0.3.2/+esm
[Error] Failed to register controller: chart (controllers/chart_controller) – TypeError: Importing a module script failed.
TypeError: Importing a module script failed.
 error
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The reference to &lt;code class=&quot;highlighter-rouge&quot;&gt;npm/@kurkle/color@0.3.2/+esm&lt;/code&gt; appears at the beginning of chart.js.js file. You need to replace this reference for the @kurkle/color that you have pinned in &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt;. Use &lt;code class=&quot;highlighter-rouge&quot;&gt;sed&lt;/code&gt; command to replace the value as follows:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;s|/npm/@kurkle/color@0.3.2/+esm|@kurkle/color|g&apos;&lt;/span&gt; chart.js.js
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After this change, reload the application page. Now the graph is rendered and there are no errors related to missing references.&lt;/p&gt;

&lt;p&gt;Not in all cases when pinning libraries from a CDN you will have this problem, but if there is a case, now you know how to diagnose and try to fix it. I would expect that newer versions of Importmap will have a feature to understand and resolve hidden references that libraries might have.&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Importmap in Ruby on Rails offers a streamlined approach to managing JavaScript libraries like Chart.js. By simplifying your workflow, leveraging the power of modern browsers, and providing local access to your dependencies, you can focus more on creating functionality and less on configuration. Give Importmap a try in your next Rails project and experience the benefits for yourself!&lt;/p&gt;

&lt;p&gt;Remember, while Importmap is powerful and the default local pinning provides good version control, you still have the flexibility to use various CDNs when needed. Consider your specific needs and performance requirements when deciding on your Importmap strategy.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/no-build/no-build.jpg" /><media:content medium="image" url="https://mariochavez.io/images/no-build/no-build.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Sound to Script: Using OpenAI’s Whisper Model and Whisper.cpp</title><link href="https://mariochavez.io/desarrollo/2023/12/10/sound-to-script-openia-whisper/" rel="alternate" type="text/html" title="Sound to Script: Using OpenAI&apos;s Whisper Model and Whisper.cpp" /><published>2023-12-10T00:00:00-06:00</published><updated>2023-12-10T00:00:00-06:00</updated><id>repo://posts.collection/_posts/2023-12-10-sound-to-script-openia-whisper.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2023/12/10/sound-to-script-openia-whisper/">&lt;p&gt;AI offers a different set of inputs and outputs for inferences. One of the many inference models is Automatic Speech Recognition (ASR). Using OpenAI’s Whiper model makes transcribing pre-recorded or live audio possible.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ggerganov/whisper.cpp&quot;&gt;Whisper.cpp&lt;/a&gt; implements OpenAI’s Whisper model, which allows you to run this model on your machine. It could be done running your CPU, Apple’s Core ML from M processors, or using a dedicated GPU unit. You can run the smaller or larger Whisper model; Whisper.cpp also supports running quantized models, which require less memory and disk space using the &lt;a href=&quot;https://github.com/ggerganov/ggml&quot;&gt;GGML library&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So, let’s see how to use Whisper.cpp to process a video to get subtitle SRT format.&lt;/p&gt;

&lt;p&gt;First, you need to clone the Whisper.cpp repository.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;https://github.com/ggerganov/whisper.cpp]&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;https://github.com/ggerganov/whisper.cpp&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you are running Whisper.cpp from your CPU, change to the code folder and run the make command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then download a Whiper model in ggml format:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash ./models/download-ggml-model.sh base.en
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can find available models here: &lt;a href=&quot;https://huggingface.co/ggerganov/whisper.cpp&quot;&gt;https://huggingface.co/ggerganov/whisper.cpp&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;With the model in place, run the following command to test it with a sample audio in the repository.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./main &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; samples/jfk.wav
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You should see the model being loaded; at the end, it displays the inferred text from the audio.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;main: processing &lt;span class=&quot;s1&quot;&gt;&apos;samples/jfk.wav&apos;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;176000 samples, 11.0 sec&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;, 4 threads, 1 processors, 5 beams + best of 5, lang &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; en, task &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; transcribe, timestamps &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 1 ...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;00:00:00.000 &lt;span class=&quot;nt&quot;&gt;--&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; 00:00:11.000]   And so my fellow Americans, ask not what your country can &lt;span class=&quot;k&quot;&gt;do for &lt;/span&gt;you, ask what you can &lt;span class=&quot;k&quot;&gt;do for &lt;/span&gt;your country.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, I’ll focus on getting Whisper.cpp to work with Apple’s silicon processor to get better performance at inference.&lt;/p&gt;

&lt;p&gt;You need Python installed to prepare Whisper models for running with Apple’s Core ML. The best way to set up Python is to install it via &lt;a href=&quot;https://docs.conda.io/projects/miniconda/en/latest/&quot;&gt;Miniconda&lt;/a&gt; and create an environment for Whisper.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda create &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; py310-whisper &lt;span class=&quot;nv&quot;&gt;python&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;3.10 &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
conda activate py310-whisper
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With Python ready and activated, install the following dependencies for Core ML.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pip &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;ane_transformers
pip &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;openai-whisper
pip &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;coremltools
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Next, generate a Core ML model off the downloaded base.en Whisper model. If you downloaded a different model, update the command to reflect that change.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./models/generate-coreml-model.sh base.en
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, you need to compile Whisper.cpp with Core ML support.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;make clean
&lt;span class=&quot;nv&quot;&gt;WHISPER_COREML&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1 make &lt;span class=&quot;nt&quot;&gt;-j&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running the Core ML model with Whisper.cpp Core ML support produces faster inference.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./main &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; models/ggml-base.en.bin &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; samples/jfk.wav
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With these tools ready, you can move to a different scenario where the audio needs to be extracted from a video, passed to Whisper.cpp, and produced the subtitle file in SRT format.&lt;/p&gt;

&lt;p&gt;To extract audio from a video, &lt;a href=&quot;https://ffmpeg.org&quot;&gt;ffmpeg&lt;/a&gt; is the best tool for this job. Whisper.cpp needs audio in 16-bit format.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ffmpeg &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; video.mp4  &lt;span class=&quot;nt&quot;&gt;-ar&lt;/span&gt; 16000 &lt;span class=&quot;nt&quot;&gt;-ac&lt;/span&gt; 1 &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt;:a pcm_s16le video.wav
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The output is a WAV audio file that you can use to produce a transcription into a JSON file.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./main -m models/ggml-base.en.bin -f video.wav  -oj -ojf video
....
    
	&quot;params&quot;: {
            &quot;model&quot;: &quot;models/ggml-medium.en-q5_0.bin&quot;,
            &quot;language&quot;: &quot;en&quot;,
            &quot;translate&quot;: false
    },
    &quot;result&quot;: {
            &quot;language&quot;: &quot;en&quot;
    },
    &quot;transcription&quot;: [
            {
                    &quot;timestamps&quot;: {
                            &quot;from&quot;: &quot;00:00:00,720&quot;,
                            &quot;to&quot;: &quot;00:00:08,880&quot;
                    },
                    &quot;offsets&quot;: {
                            &quot;from&quot;: 720,
                            &quot;to&quot;: 8880
                    },
                    &quot;text&quot;: &quot; Hi, everyone. Would you let people in why? Okay. Yes. My name is Selma. For those of you that don&apos;t&quot;,
                    &quot;tokens&quot;: [
                            {
                                    &quot;text&quot;: &quot; Hi&quot;,
                                    &quot;timestamps&quot;: {
                                            &quot;from&quot;: &quot;00:00:00,000&quot;,
                                            &quot;to&quot;: &quot;00:00:00,240&quot;
                                    },
                                    &quot;offsets&quot;: {
                                            &quot;from&quot;: 0,
                                            &quot;to&quot;: 240
                                    },
                                    &quot;id&quot;: 15902,
                                    &quot;p&quot;: 0.882259
                            },
                            {
                                    &quot;text&quot;: &quot;,&quot;,
                                    &quot;timestamps&quot;: {
                                            &quot;from&quot;: &quot;00:00:00,240&quot;,
                                            &quot;to&quot;: &quot;00:00:00,470&quot;
                                    },
                                    &quot;offsets&quot;: {
                                            &quot;from&quot;: 240,
                                            &quot;to&quot;: 470
                                    },
....
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This JSON file can be transformed to meet our needs. In our case, we want to produce an SRT format for video player subtitles. This last part is done with a Ruby script.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;json_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; JSON.parse&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;File.read&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;json_file_path&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;

transcription &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; json_data[&lt;span class=&quot;s1&quot;&gt;&apos;transcription&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
srt_content &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;

transcription.each_with_index &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |entry, index|
  from_time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; entry[&lt;span class=&quot;s1&quot;&gt;&apos;timestamps&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;from&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
  to_time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; entry[&lt;span class=&quot;s1&quot;&gt;&apos;timestamps&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;to&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
  text &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; entry[&lt;span class=&quot;s1&quot;&gt;&apos;text&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;

  srt_content +&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{index + 1}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;n&quot;&lt;/span&gt;
  srt_content +&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{from_time} --&amp;gt; #{to_time}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;n&quot;&lt;/span&gt;
  srt_content +&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{text}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;n&quot;&lt;/span&gt;
end

File.write&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;srt_file_path, srt_content&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It depends on the length of the extracted audio file; this process can take a few seconds or several minutes to complete.&lt;/p&gt;

&lt;p&gt;The following is a Ruby script performs all three actions at once: extract audio, transcribe, and transform into SRT file format.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;require &lt;span class=&quot;s1&quot;&gt;&apos;json&apos;&lt;/span&gt;
require &lt;span class=&quot;s1&quot;&gt;&apos;tmpdir&apos;&lt;/span&gt;

def extract_audio&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;, input_video_path&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# Generate temporary WAV file path based on the input video&lt;/span&gt;
  temp_wav_file_path &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{dir}/#{File.basename(input_video_path, &apos;.*&apos;)}.wav&quot;&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Construct the ffmpeg command&lt;/span&gt;
  ffmpeg_command &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;ffmpeg -i &apos;#{input_video_path}&apos; -ar 16000 -ac 1 -c:a pcm_s16le &apos;#{temp_wav_file_path}&apos;&quot;&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Execute the ffmpeg command&lt;/span&gt;
  puts ffmpeg_command
  system&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ffmpeg_command&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Check if the command was successful&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$?&lt;/span&gt;.success?
    puts &lt;span class=&quot;s2&quot;&gt;&quot;Audio extracted successfully to #{temp_wav_file_path}&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;temp_wav_file_path
  &lt;span class=&quot;k&quot;&gt;else
    &lt;/span&gt;puts &lt;span class=&quot;s2&quot;&gt;&quot;Error extracting audio. Please check your ffmpeg installation and the input video file.&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  end
end

def process_wav&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;, wav_file_path&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# Path to the main command and binary file&lt;/span&gt;
  path &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;~/Development/llm/whisper.cpp/&apos;&lt;/span&gt;
  main_command &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;main&apos;&lt;/span&gt;
  model_file &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;models/ggml-medium.en-q5_0.bin&apos;&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Generate temporary JSON file path based on the WAV file&lt;/span&gt;
  temp_json_file_path &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{dir}/#{File.basename(wav_file_path, &apos;.*&apos;)}&quot;&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Construct the full command with quotes around file paths&lt;/span&gt;
  full_command &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{path}#{main_command} -m #{path}#{model_file} -f &apos;#{wav_file_path}&apos; -oj -ojf &apos;#{temp_json_file_path}&apos;&quot;&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Execute the command&lt;/span&gt;
  puts full_command
  system&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;full_command&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Check if the command was successful&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$?&lt;/span&gt;.success?
    puts &lt;span class=&quot;s2&quot;&gt;&quot;Processing completed successfully for #{wav_file_path}&quot;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{temp_json_file_path}.wav.json&quot;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;else
    &lt;/span&gt;puts &lt;span class=&quot;s2&quot;&gt;&quot;Error processing the WAV file. Please check your command and the input file.&quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  end
end

def process_json_to_srt&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;json_file_path, srt_file_path&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  json_data &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; JSON.parse&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;File.read&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;json_file_path&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;

  &lt;span class=&quot;c&quot;&gt;# Extract &apos;transcription&apos; array from JSON&lt;/span&gt;
  transcription &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; json_data[&lt;span class=&quot;s1&quot;&gt;&apos;transcription&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
  srt_content &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;

  transcription.each_with_index &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |entry, index|
    from_time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; entry[&lt;span class=&quot;s1&quot;&gt;&apos;timestamps&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;from&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
    to_time &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; entry[&lt;span class=&quot;s1&quot;&gt;&apos;timestamps&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;to&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
    text &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; entry[&lt;span class=&quot;s1&quot;&gt;&apos;text&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;

    srt_content +&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{index + 1}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    srt_content +&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{from_time} --&amp;gt; #{to_time}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
    srt_content +&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{text}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
  end

  &lt;span class=&quot;c&quot;&gt;# Write SRT content to the new file&lt;/span&gt;
  File.write&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;srt_file_path, srt_content&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

  puts &lt;span class=&quot;s2&quot;&gt;&quot;SRT file created at #{srt_file_path}&quot;&lt;/span&gt;
end

&lt;span class=&quot;c&quot;&gt;# Check if the video file path is provided as a command-line argument&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;ARGV.empty?
  puts &lt;span class=&quot;s2&quot;&gt;&quot;Usage: ruby combined_script.rb path/to/your/video.mp4&quot;&lt;/span&gt;
  &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else
  &lt;/span&gt;video_path &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ARGV[0]

  Dir.mktmpdir &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; |dir|
    &lt;span class=&quot;c&quot;&gt;# Extract audio&lt;/span&gt;
    wav_file_path &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; extract_audio&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;, video_path&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# Process audio to obtain JSON transcript&lt;/span&gt;
    json_file_path &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; process_wav&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;, wav_file_path&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;c&quot;&gt;# Convert JSON to SRT&lt;/span&gt;
    srt_file_path &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#{File.dirname(video_path)}/#{File.basename(video_path, &apos;.*&apos;)}.srt&quot;&lt;/span&gt;
    process_json_to_srt&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;json_file_path, srt_file_path&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  end
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It needs a few changes in the &lt;code class=&quot;highlighter-rouge&quot;&gt;process_wav&lt;/code&gt; method.&lt;/p&gt;

&lt;p&gt;First, you need to update the path to your Whisper binaries. And second, the relative path to the binaries of your model.
After these changes, you can create subtitles for your video with the following command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ruby transcribe.rb video.mp4
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After script completion, you will have a video.srt file next to your video file.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/whisper/sound.jpg" /><media:content medium="image" url="https://mariochavez.io/images/whisper/sound.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Full-text search with SQLite and Rails</title><link href="https://mariochavez.io/desarrollo/2023/09/01/full-text-search-with-sqlite-and-rails/" rel="alternate" type="text/html" title="Full-text search with SQLite and Rails" /><published>2023-09-01T00:00:00-06:00</published><updated>2023-09-01T00:00:00-06:00</updated><id>repo://posts.collection/_posts/2023-09-01-full-text-search-with-sqlite-and-rails.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2023/09/01/full-text-search-with-sqlite-and-rails/">&lt;p&gt;Today, I planned to move a few small Ruby on Rails applications with Heroku using &lt;a href=&quot;https://kamal-deploy.org/&quot;&gt;Kamal&lt;/a&gt; onto a single server. All applications use PostgreSQL as the database because it is simple to use with Heroku and because they take advantage of Postgres’ full-text search.&lt;/p&gt;

&lt;p&gt;Because of the size and usage of those applications, I was not convinced that I wanted to manage my own PostgreSQL server or pay for a managed service. So, I started to consider replacing the database with &lt;a href=&quot;https://www.sqlite.org/index.html&quot;&gt;SQLite&lt;/a&gt;. At least in my feed at &lt;a href=&quot;https://x.com/mario_chavez&quot;&gt;X&lt;/a&gt;, I have seen so many posts in the past few months on how good and fast it is.&lt;/p&gt;

&lt;p&gt;I wanted something like the &lt;a href=&quot;https://github.com/Casecommons/pg_search#pg_search_scope&quot;&gt;pg_search&lt;/a&gt; gem, where I could define a scope name and the fields to be indexed. On the SQLite side, I found that it has an extension called &lt;a href=&quot;https://www.sqlite.org/fts5.html&quot;&gt;FTS5&lt;/a&gt;, which is defined as:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;FTS5 is an SQLite &lt;a href=&quot;https://www.sqlite.org/c3ref/module.html&quot;&gt;virtual table module&lt;/a&gt; that provides &lt;a href=&quot;https://en.wikipedia.org/wiki/Full_text_search&quot;&gt;full-text search&lt;/a&gt; functionality to database applications. In their most elementary form, full-text search engines allow the user to efficiently search a large collection of documents for the subset that contains one or more instances of a search term. The search functionality provided to World Wide Web users by Google is, among other things, a full-text search engine, as it allows users to search for all documents on the web that contain, for example, the term “fts5”.&lt;/p&gt;

&lt;/blockquote&gt;

&lt;p&gt;This looked promising, so I started implementing a quick and dirty solution for my needs.
Starting from a model Post with title and content attributes, I want to define a &lt;code class=&quot;highlighter-rouge&quot;&gt;full_search&lt;/code&gt; scope and indicate the attributes to index for full-text search.&lt;/p&gt;

&lt;p&gt;Something like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Post&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationRecord&lt;/span&gt;
  &lt;span class=&quot;kp&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;SqliteSearch&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;search_scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:title&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:content&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where &lt;code class=&quot;highlighter-rouge&quot;&gt;SqliteSearch&lt;/code&gt; is the module that does the heavy work. Before continuing with the implementation, there are decisions to be made regarding how to store the indexed data in the database. A virtual table is required to store the indexed data; one option is to create a single table for this purpose with a &lt;code class=&quot;highlighter-rouge&quot;&gt;record_type&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;record_id&lt;/code&gt; fields to identify the data per model type, just like the way it works for ActiveStorage or ActionText in Rails.&lt;/p&gt;

&lt;p&gt;The second option is to create a table per indexed model. I chose this option since not all my models require this functionality. The migration for this table is as follows:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;PostSearch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Migration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;7.0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;up&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;CREATE VIRTUAL TABLE fts_posts USING fts5(title, content, post_id)&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;down&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;DROP TABLE IF EXISTS fts_posts&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The table name follows the Rails convention, but it adds the prefix &lt;code class=&quot;highlighter-rouge&quot;&gt;fts_&lt;/code&gt;. The table fields are the ones that need indexing with the addition of the original record id with the foreign key convention. SQLite virtual tables don’t have data types, primary keys, constraints, or indexes.&lt;/p&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;SqliteSearch&lt;/code&gt; module needs to implement a way to add or update the model data to the search index. This is done using the &lt;strong&gt;ActiveRecord&lt;/strong&gt; callbacks for save and destroy commit.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;SqliteSearch&lt;/span&gt;
  &lt;span class=&quot;kp&quot;&gt;extend&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Concern&lt;/span&gt;

  &lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;update_search_index&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;primary_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;primary_key&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;table_name&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;foreign_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;foreign_key&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;search_attrs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;vc&quot;&gt;@@search_scope_attrs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;each_with_object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({})&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;attr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;attr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;quote_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;attr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;id_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;attributes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;primary_key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;sql_delete&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;~&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
      DELETE FROM fts_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; WHERE &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;foreign_key&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id_value&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;    SQL&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql_delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;sql_insert&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;~&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
      INSERT INTO fts_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;search_attrs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;, &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;foreign_key&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;)
      VALUES (&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;search_attrs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;values&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&apos;&quot;&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;.join(&quot;, &quot;)}, &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;attributes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;primary_key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;);
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;    SQL&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql_insert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;kp&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;delete_search_index&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;primary_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;primary_key&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;table_name&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;foreign_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;foreign_key&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;id_value&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;attributes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;primary_key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;sql_delete&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;~&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
      DELETE FROM fts_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; WHERE &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;foreign_key&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; = &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id_value&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;    SQL&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql_delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;included&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;after_save_commit&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:update_search_index&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;after_destroy_commit&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:delete_search_index&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;scope_foreign_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;to_s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;foreign_key&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;scope&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:full_search&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;none&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;blank?&lt;/span&gt;

      &lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;~&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
        SELECT &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;scope_foreign_key&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; AS id FROM fts_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
        WHERE fts_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; = &apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;&apos; ORDER BY rank;
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;      SQL&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;ids&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:values&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;flatten&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;id: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ids&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;class_methods&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;search_scope&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;attrs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;vc&quot;&gt;@@search_scope_attrs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;attrs&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;rebuild_search_index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ids&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;target_ids&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ids&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;target_ids&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;ids&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target_ids&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;empty?&lt;/span&gt;

      &lt;span class=&quot;n&quot;&gt;scope_foreign_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;to_s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;foreign_key&lt;/span&gt;

      &lt;span class=&quot;n&quot;&gt;delete_where&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ids&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;any?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;WHERE &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;scope_foreign_key&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; IN (&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ids&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;, &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;)&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;sql_delete&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;~&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
        DELETE FROM fts_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delete_where&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;;
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;      SQL&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql_delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

      &lt;span class=&quot;n&quot;&gt;target_ids&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;each&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;record&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;id: &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;pluck&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;vc&quot;&gt;@@search_scope_attrs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;first&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;record&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;present?&lt;/span&gt;
          &lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;record&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;pop&lt;/span&gt;

          &lt;span class=&quot;n&quot;&gt;sql_insert&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;~&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;strip&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
            INSERT INTO fts_&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;vc&quot;&gt;@@search_scope_attrs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;, &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;scope_foreign_key&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;)
            VALUES (&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;record&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;quote_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&apos;&quot;&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;.join(&quot;, &quot;)}, &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;);
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;          SQL&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sql_insert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;quote_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;s&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;\&amp;amp;\&amp;amp;&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;gsub&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&apos;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&apos;&apos;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The class method &lt;code class=&quot;highlighter-rouge&quot;&gt;search_scope&lt;/code&gt; tells the module the attributes we need to index. The &lt;code class=&quot;highlighter-rouge&quot;&gt;update_search_index&lt;/code&gt; callback is called when the record is created or updated. Since SQLite, virtual tables don’t support upsert, which is a way to tell the database to insert a record if it doesn’t exist or to update it if it does. Also, the Rails SQLite adapter does not support multiple statements in a single execution call. &lt;/p&gt;

&lt;p&gt;These limitations forced me to make two additional database calls: the first to delete the indexed data for a specific record, and the second to insert the new indexed data. It’s not very performant, but for a small database, it might be just fine.
The &lt;code class=&quot;highlighter-rouge&quot;&gt;delete_search_index&lt;/code&gt; callback removes the indexed data when a record is deleted.&lt;/p&gt;

&lt;p&gt;The module also implements a class method, &lt;code class=&quot;highlighter-rouge&quot;&gt;rebuild_search_index&lt;/code&gt;, which optionally receives an array of record ids to re-index. If no ids are passed, then it rebuilds the index for all records.&lt;/p&gt;

&lt;p&gt;Finally, a scope full_search is added to fetch records based on the full-text search index. You can use keywords like “AND”, “OR,” or “NOT” to refine your search or any other special character supported by SQLite FTS5.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;no&quot;&gt;Post&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;full_search&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Ruby OR Rails NOT Javascript&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Adding this module to my applications allowed me to explore the idea of moving from PostgreSQL for these small applications. Not because PostgreSQL is bad, but because it might be too much for the current application’s needs.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/full-text-search/full-text-search.jpg" /><media:content medium="image" url="https://mariochavez.io/images/full-text-search/full-text-search.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry xml:lang="en"><title type="html">Working with Rails Engines, Importmap and TailwindCSS for assets.</title><link href="https://mariochavez.io/desarrollo/2023/08/23/working-with-rails-engines-importmap-tailwindcss/" rel="alternate" type="text/html" title="Working with Rails Engines, Importmap and TailwindCSS for assets." /><published>2023-08-23T00:00:00-06:00</published><updated>2023-08-23T00:00:00-06:00</updated><id>repo://posts.collection/_posts/2023-08-23-working-with-rails-engines-importmap-tailwindcss.md</id><content type="html" xml:base="https://mariochavez.io/desarrollo/2023/08/23/working-with-rails-engines-importmap-tailwindcss/">&lt;p&gt;Rails engines are one of my favorite tools when I want to isolate reusable functionality for Rails applications. An example of this is the NoPassword gem, which allows users to login into an application just with their email and the received link and code.&lt;/p&gt;

&lt;p&gt;With Rails 3.1, the engines were mountable and integrated with the Asset Pipeline to manage the engine’s assets. This continued to work this way until Webpack was introduced to Rails in version 5.1. At this moment, it was not clear how to make Webpack work with the engine’s assets or any other gem that included assets.&lt;/p&gt;

&lt;p&gt;Rails 7 introduced CSS and JS bundling, along with the Propshaft gem to manage and serve assets. Also, introduced Importmaps and TailwindCSS as options for not having Node as a dependency, but in both cases without any official word on how to make these work with engines.&lt;/p&gt;

&lt;p&gt;NOTE: Importmap’s README explains how to composite multiple Impormap configurations. &lt;a href=&quot;https://github.com/rails/importmap-rails#composing-import-maps&quot;&gt;https://github.com/rails/importmap-rails#composing-import-maps&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Working on the NoPassword engine and a few private others, I decided for them to use Importmaps, TailwindCSS, and Propshaft. It led me to figure out a way to use the engine assets. The rest of this post describes my successful journey with assets and engines.&lt;/p&gt;

&lt;h2 id=&quot;importmap-engine-configuration&quot;&gt;Importmap engine configuration&lt;/h2&gt;

&lt;p&gt;First, let’s try the route described in Importmap’s README file.&lt;/p&gt;

&lt;p&gt;To install Importmap in an engine project, it requires adding the gem to the dummy app and adding the dependency to the engine’s gem spec file.&lt;/p&gt;

&lt;p&gt;Install Importmap and add it as a dependency to the Gemfile as follows:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bundle add importmap-rails
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And add it to the gem spec file.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;spec.add_dependency &lt;span class=&quot;s2&quot;&gt;&quot;importmap-rails&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;~&amp;gt; 1.2&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;&amp;gt;= 1.2.1&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then run the bundle command and navigate to the test/dummy app to execute the installer in the dummy app.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd test&lt;/span&gt;/dummy &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bin/rails importmap::install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Following the README instructions for composite Importmaps, open the &lt;code class=&quot;highlighter-rouge&quot;&gt;lib/my_engine/engine.rb&lt;/code&gt; file and add the following hook - remember to replace &lt;strong&gt;**&lt;/strong&gt;&lt;strong&gt;**&lt;/strong&gt;&lt;strong&gt;**&lt;/strong&gt;my-engine&lt;strong&gt;**&lt;/strong&gt;&lt;strong&gt;**&lt;/strong&gt;&lt;strong&gt;**&lt;/strong&gt; with the name of your engine -:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;MyEngine&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Engine&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;initializer&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;my-engine.importmap&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;before: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;importmap&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;paths&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config/importmap.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# ...&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then create the file &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt; and pin the engine’s javascript assets.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pin_all_from File.expand_path&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;../app/assets/javascript&quot;&lt;/span&gt;, __dir__&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To test this setup, two Stimulus controllers were added, one in the engine’s &lt;code class=&quot;highlighter-rouge&quot;&gt;app/assets/javascript&lt;/code&gt; and another one at the dummy app &lt;code class=&quot;highlighter-rouge&quot;&gt;test/dummy/app/javascript/controllers&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-jsx highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;javascript&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;controllers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;host_controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;js &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Dummy&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;APP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;@hotwired/stimulus&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Connected&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;element&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;textContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Hello World! This is a Javascript from the Host&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Loaded&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;err&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;assets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;javascript&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;engine_controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;js &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;@hotwired/stimulus&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Controller&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Connected&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;element&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;textContent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Hello World! This is a Javascript from the Engine&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Loaded&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Set up Stimulus in the dummy app by adding the gem and running the installer.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd test&lt;/span&gt;/dummy
bundle add stimulus-rails
./bin/rails stimulus:install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The Dummy app has a &lt;strong&gt;HomeController&lt;/strong&gt; with an index action. The index template has two divs. One for &lt;code class=&quot;highlighter-rouge&quot;&gt;host_controller.js&lt;/code&gt; and the second one for &lt;code class=&quot;highlighter-rouge&quot;&gt;engine_controller.js&lt;/code&gt; .&lt;/p&gt;

&lt;div class=&quot;language-html highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;Engine&apos;s Stimulus controller (Host app)&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;data-controller=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;host&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;data-controller=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;engine&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/importmap-1.png&quot; alt=&quot;Importmap&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately, this setup does not work, at least for my use case, where I expect the engine to have Stimulus controllers available in the host application, the Dummy app in this case. The engine’s controller is there in the imports manifest but is not loaded in the context of the Stimulus application.&lt;/p&gt;

&lt;p&gt;The way that I make this work is to first organize the engine’s Stimulus controllers with the following directory structure: &lt;code class=&quot;highlighter-rouge&quot;&gt;app/assets/javascript/my_engine/controllers&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Next, modify the Dummy app’s &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt; and add the following line at the end of the file.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin_all_from&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;app/assets/javascript/my_engine/controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;under: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;my_engine/controllers&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With this change, reload the page, and now it is working! The engine’s Stimulus controller is loaded by the host application.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/importmap-2.png&quot; alt=&quot;Importmap&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In the Importmap repository, there is an open issue about how to make the gem work with engines, and the user muriloime mentions this solution &lt;a href=&quot;https://github.com/rails/importmap-rails/issues/58&quot;&gt;https://github.com/rails/importmap-rails/issues/58&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Now, what about making Importmap work with the engine’s own views? In the case of the NoPassword gem, it provides views for the login process and uses a Stimulus controller to display errors; it does not depend on the host application in any way.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/no-password-demo.gif&quot; alt=&quot;No Password&quot; /&gt;&lt;/p&gt;

&lt;p&gt;First, add Stimulus as a gem dependency to the gem spec file and execute the bundle command.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;add_dependency&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;stimulus-rails&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;~&amp;gt; 1.2&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The installer is not available inside the engine, so this step requires adding a few files manually. Let’s start with the javascript files.&lt;/p&gt;

&lt;div class=&quot;language-jsx highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;assets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;javascript&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;my_engine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;js&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;controllers&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;err&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;assets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;javascript&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;my_engine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;controllers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;js&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// Import and register all your controllers from the importmap under controllers/*&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;controllers/application&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Eager load all controllers defined in the import map under controllers/**/*_controller&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eagerLoadControllersFrom&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;@hotwired/stimulus-loading&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nf&quot;&gt;eagerLoadControllersFrom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;controllers&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Lazy load controllers as they appear in the DOM (remember not to preload controllers in import map!)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// import { lazyLoadControllersFrom } from &quot;@hotwired/stimulus-loading&quot;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// lazyLoadControllersFrom(&quot;controllers&quot;, application)&lt;/span&gt;

&lt;span class=&quot;err&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;assets&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;javascript&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;my_engine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;controllers&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;js&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Application&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;@hotwired/stimulus&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Configure Stimulus development experience&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;debug&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;window&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Stimulus&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;application&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Open the file &lt;code class=&quot;highlighter-rouge&quot;&gt;config/importmap.rb&lt;/code&gt; and replace the content with the following pins that load Stimulus and the engine’s controllers:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/stimulus&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;stimulus.min.js&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;preload: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;@hotwired/stimulus-loading&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;stimulus-loading.js&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;preload: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;pin&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;application&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;preload: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;pin_all_from&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;app/assets/javascript/my_engine/controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;under: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;controllers&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;to: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;my_engine/controllers&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Instead of composing a global Importmap, we are going to set up a local configuration for the engine. Open the &lt;code class=&quot;highlighter-rouge&quot;&gt;lib/my_engine.rb&lt;/code&gt; file and add the following code:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;my_engine/version&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;my_engine/engine&quot;&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;importmap-rails&quot;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;MyEngine&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;attr_accessor&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:configuration&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Configuration&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;attr_reader&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:importmap&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@importmap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Importmap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
      &lt;span class=&quot;vi&quot;&gt;@importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;draw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;config/importmap.rb&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;init_config&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;configuration&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Configuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;configure&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;init_config&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;yield&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;configuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;init_config&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here, a configuration class was added to the engine. It has only one setting, where it initializes a new Importmap with assets belonging to the engine. Be aware that sweepers are not set up for Importmap; this means that changes made during development with the engine will not be taken until the app is restarted.
This configuration can be extended to include more engine settings if needed.&lt;/p&gt;

&lt;p&gt;Now we need to create a helper similar to &lt;code class=&quot;highlighter-rouge&quot;&gt;javascript_importmap_tag&lt;/code&gt; that is aware of the engine’s Importmap configuration. Open the &lt;code class=&quot;highlighter-rouge&quot;&gt;app/helpers/my_engine/application_helper.rb&lt;/code&gt; and add the following method.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;my_engine_importmap_tags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;entry_point&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;application&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;shim: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;safe_join&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;javascript_inline_importmap_tag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;configuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;resolver: &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)),&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;javascript_importmap_module_preload_tags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;configuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;importmap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;javascript_importmap_shim_nonce_configuration_tag&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;javascript_importmap_shim_tag&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;javascript_import_module_tag&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;entry_point&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;compact&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now open the engine’s layout and replace the &lt;code class=&quot;highlighter-rouge&quot;&gt;javascript_importmap_tag&lt;/code&gt; with &lt;code class=&quot;highlighter-rouge&quot;&gt;my_engine_importmap_tags&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;To test this, add a controller named &lt;code class=&quot;highlighter-rouge&quot;&gt;MyEngine::HomeController&lt;/code&gt; with an index action and a div that uses &lt;code class=&quot;highlighter-rouge&quot;&gt;engine_controller.js&lt;/code&gt; to it.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/importmap-3.png&quot; alt=&quot;Importmap&quot; /&gt;&lt;/p&gt;

&lt;p&gt;These are the two configuration options for Importmap with engines. Share the engine’s Stimulus controllers with the host app, or use the engine’s Stimulus controllers internally for the engine’s templates.&lt;/p&gt;

&lt;h2 id=&quot;tailwindcss-engine-configuration&quot;&gt;TailwindCSS engine configuration&lt;/h2&gt;

&lt;p&gt;The steps to install it are simple. First, let’s install it into the Dummy app.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd test&lt;/span&gt;/dummy &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bundle add tailwindcss-rails
./bin/rails tailwindcss:install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For the Dummy app that comes with the engine in development mode, there are two additional steps that are not required when the host app is not the Dummy app.&lt;/p&gt;

&lt;p&gt;Ensure that the TailwindCSS task runs with Foreman or Overmind using your &lt;code class=&quot;highlighter-rouge&quot;&gt;Procfile.dev&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;web: bin/rails server &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 3000
css: bin/rails app:tailwindcss:watch
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, change the &lt;code class=&quot;highlighter-rouge&quot;&gt;test/dummy/config/tailwind.config.js&lt;/code&gt; file that was installed by TailwindCSS to have the right path to the Dummy app. Change the content section to include the &lt;code class=&quot;highlighter-rouge&quot;&gt;./test/dummy&lt;/code&gt; path.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;content: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/public/*.html&apos;&lt;/span&gt;,
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/app/helpers/**/*.rb&apos;&lt;/span&gt;,
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/app/javascript/**/*.js&apos;&lt;/span&gt;,
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/app/views/**/*.{erb,haml,html,slim}&apos;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Restart your application, and it should work for the Dummy app.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/tailwind-1.png&quot; alt=&quot;TailwindCSS&quot; /&gt;&lt;/p&gt;

&lt;p&gt;To extend the TailwindCSS styling into the engine’s templates, there are a few steps that need to be taken first. The host app, in our case, the Dummy app, needs to override the engine’s layout to include the TailwindCSS files. Copy the file &lt;code class=&quot;highlighter-rouge&quot;&gt;app/layouts/my_engine/application.html.erb&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;test/dummy/app/layouts/my_engine/application.html.erb&lt;/code&gt; and add the following line in the &lt;strong&gt;head&lt;/strong&gt; section:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;%&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; stylesheet_link_tag &lt;span class=&quot;s2&quot;&gt;&quot;tailwind&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;inter-font&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;data-turbo-track&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;reload&quot;&lt;/span&gt; %&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Navigate to an engine action, and you can confirm the general CSS reset of TailwindCSS is applied, but utility classes are ignored.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/tailwind-2.png&quot; alt=&quot;TailwindCSS&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This happens because the file doesn’t know that it also needs to scan the engine templates for TailwindCSS classes.&lt;/p&gt;

&lt;p&gt;To fix this, we need a rake task and a generator in the host or Dummy app. Create a file &lt;code class=&quot;highlighter-rouge&quot;&gt;test/dummy/lib/tasks/tailwind.rake&lt;/code&gt; and add the following content:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# frozen_string_literal: true&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:tailwindcss&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;desc&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Generates your tailwind config file&quot;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;task&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:config&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Generators&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;invoke&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tailwind_config&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;--force&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;no&quot;&gt;Rake&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Task&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tailwindcss:build&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;enhance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tailwindcss:config&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rake&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Task&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tailwindcss:watch&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;enhance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tailwindcss:config&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here we are adding a &lt;strong&gt;tailwindcss:config&lt;/strong&gt; task that invokes a generator (we are going to create this one in a moment) and enhancing TailwindCSS tasks provided by the gem by injecting this new task into the build process.&lt;/p&gt;

&lt;p&gt;For the generator, create the file &lt;code class=&quot;highlighter-rouge&quot;&gt;test/dummy/lib/generators/tailwind_config_generator.rb&lt;/code&gt; in the host or Dummy app and add the following code:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# frozen_string_literal: true&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TailwindConfigGenerator&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Generators&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Base&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;source_root&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;expand_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;../templates&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;__FILE__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;create_tailwind_config_file&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@engines_paths&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;configuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;tailwind_content&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;# The second parameter for the template method is required only if the host app is the Dummy app; &lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# for an external host app, remove that parameter.&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;template&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;config/tailwind.config.js&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;expand_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;../../../config/tailwind.config.js&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kp&quot;&gt;__FILE__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This generator, when executed, creates a new TailwindCSS config file from a template, but before doing that, in the &lt;code class=&quot;highlighter-rouge&quot;&gt;create_tailwind_config_file&lt;/code&gt; method, we can set up the engine paths to consider when scanning for TailwindCSS classes.&lt;/p&gt;

&lt;p&gt;In the code, the generator assumes that our engine configuration exposes a &lt;code class=&quot;highlighter-rouge&quot;&gt;tailwind_content&lt;/code&gt; accessor with an array of paths.&lt;/p&gt;

&lt;p&gt;Add an accessor to the Configuration class in file &lt;code class=&quot;highlighter-rouge&quot;&gt;lib/my_engine.rb&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;attr_accessor&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:tailwind_content&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also add to the &lt;code class=&quot;highlighter-rouge&quot;&gt;initializer&lt;/code&gt; method of the same class the following paths:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;vi&quot;&gt;@tailwind_content&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/app/views/**/*&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/app/helpers/**/*&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/app/controllers/**/*&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;MyEngine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/app/javascript/**/*.js&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Moving back to the template file in the &lt;code class=&quot;highlighter-rouge&quot;&gt;tailwind_config_generator&lt;/code&gt;, this is the TailwindCSS config file, but it will be created dynamically by the task to be able to inject the engine paths into it.&lt;/p&gt;

&lt;p&gt;Move the file &lt;code class=&quot;highlighter-rouge&quot;&gt;test/dummy/config/tailwind.config.js&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;lib/generators/templates/config/tailwind.config.js.tt&lt;/code&gt; and modify the &lt;strong&gt;content&lt;/strong&gt; section as follows:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;ss&quot;&gt;content: &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/public/*.html&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/app/helpers/**/*.rb&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/app/javascript/**/*.js&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;s1&quot;&gt;&apos;./test/dummy/app/views/**/*.{erb,haml,html,slim}&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;sx&quot;&gt;%= @engines_paths.map{ |path| &quot;&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;sx&quot;&gt;&apos;&quot; }.join(&quot;,&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;sx&quot;&gt;&quot;) %&amp;gt;
  ],
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Add the file &lt;code class=&quot;highlighter-rouge&quot;&gt;test/dummy/config/tailwind.config.js&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;.gitignore&lt;/code&gt; file, since this file will be generated automatically.&lt;/p&gt;

&lt;p&gt;Restart the application, navigate the view in the host app and a view in the engine, and confirm that TailwindCSS is working for both cases.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/tailwind-3.png&quot; alt=&quot;TailwindCSS&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/engines-assets/tailwind-4.png&quot; alt=&quot;TailwindCSS&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;wrapping-up&quot;&gt;Wrapping up&lt;/h2&gt;

&lt;p&gt;This is how I have been working with the Rails engines Importmap and TailwindCSS. Most of the knowledge here came from reading the source code of the libraries and trial and error.&lt;/p&gt;

&lt;p&gt;If you are looking to work with engines and this tool set for assets, please give it a try and let me know how it goes or if there is a better, simpler way to archive the same.&lt;/p&gt;</content><author><name>Mario Alberto Chávez</name></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://mariochavez.io/images/engines-assets/engines-assets.jpg" /><media:content medium="image" url="https://mariochavez.io/images/engines-assets/engines-assets.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>